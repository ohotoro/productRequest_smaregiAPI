
<script>

// ===== localStorage ì•ˆì „ ì´ˆê¸°í™” (ê°€ì¥ ë¨¼ì € ì‹¤í–‰) =====
(function() {
  try {
    // ë²„ì „ ê´€ë¦¬
    const APP_VERSION = '1.0.1'; // ë²„ì „ ë³€ê²½ ì‹œ ìºì‹œ ìë™ í´ë¦¬ì–´
    const savedVersion = localStorage.getItem('app_version');
    
    if (savedVersion !== APP_VERSION) {
      localStorage.clear();
      sessionStorage.clear();
      localStorage.setItem('app_version', APP_VERSION);
      console.log('ìºì‹œ í´ë¦¬ì–´ ì™„ë£Œ - ìƒˆ ë²„ì „:', APP_VERSION);
    }
    
    // ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬ (30ì¼ ì´ìƒ)
    const maxAge = 30 * 24 * 60 * 60 * 1000;
    const now = Date.now();
    
    Object.keys(localStorage).forEach(key => {
      try {
        const item = localStorage.getItem(key);
        if (item && key !== 'app_version') {
          const parsed = JSON.parse(item);
          if (parsed.timestamp && (now - parsed.timestamp) > maxAge) {
            localStorage.removeItem(key);
          }
        }
      } catch (e) {
        // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì œê±°
        if (key !== 'app_version') {
          localStorage.removeItem(key);
        }
      }
    });
    
  } catch (error) {
    console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    // ì‹¬ê°í•œ ì˜¤ë¥˜ ì‹œ ì „ì²´ í´ë¦¬ì–´
    try {
      localStorage.clear();
      sessionStorage.clear();
    } catch (e) {
      // localStorage ì ‘ê·¼ ë¶ˆê°€ ì‹œ
    }
  }
})();

// ===== 1. ì „ì—­ ìƒìˆ˜ ë° ì„¤ì • =====
const CONFIG = {
  CACHE_TTL: 300000,
  SESSION_TTL: 1800000,
  AUTO_SAVE_DELAY: 30000,
  SEARCH_DEBOUNCE: 1000,
  MAX_CACHE_SIZE: 100,
  MAX_SESSION_ITEMS: 100
};

// ===== 2. ì „ì—­ ìƒíƒœ ê´€ë¦¬ (ìµœì†Œí™”) =====
const AppState = {
  products: [],
  orderItems: [],
  currentOrderInfo: null,
  currentFilter: 'all',
  settings: {},
  isSearching: false,
  hasUnsavedChanges: false,
  currentLang: 'ko',
  translations: {},
  categoryRules: {},
  productIssues: {},
  safetyStockCache: [],
  smaregiData: {},
  smaregiUploadTime: null,
  smaregiDataLoaded: false,
  uploadedCSVContent: null,
  uploadedSmaregiContent: null,
  currentStockEditItem: null,
  timers: {
    autoSave: null,
    search: null,
    safetySearch: null,
    retry: null,
    issue: null
  },
  voiceSettings: {
    volume: 0.8,
    rate: 1.2,
    pitch: 1.0,
    language: 'ko-KR'
  },
  timers: {
    autoSave: null,
    search: null,
    safetySearch: null,
    retry: null,
    issue: null
  }
};

// 1. ìë™ ë™ê¸°í™” ì„¤ì •
let syncInterval = null;
let currentVersion = 0;
let currentSortField = 'default';
let currentSortOrder = 'asc';

function startAutoSync() {
  if (!AppState.currentOrderInfo) return;
  
  // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸ ì²´í¬
  syncInterval = setInterval(() => {
    checkForOrderUpdates();
  }, 30000);
}

function stopAutoSync() {
  if (syncInterval) {
    clearInterval(syncInterval);
    syncInterval = null;
  }
}

// 2. ì—…ë°ì´íŠ¸ ì²´í¬
function checkForOrderUpdates() {
  if (!AppState.currentOrderInfo || AppState.hasUnsavedChanges) return;
  
  google.script.run
    .withSuccessHandler((result) => {
      if (result.hasUpdate) {
        showUpdateNotification(result);
      }
    })
    .withFailureHandler((error) => {
      console.warn('ë™ê¸°í™” ì²´í¬ ì‹¤íŒ¨:', error);
    })
    .checkForUpdates(AppState.currentOrderInfo.orderId, currentVersion);
}

// 3. ì—…ë°ì´íŠ¸ ì•Œë¦¼
function showUpdateNotification(updateInfo) {
  const notification = document.createElement('div');
  notification.className = 'sync-notification';
  notification.innerHTML = `
    <div class="sync-notification-content">
      <div class="sync-icon">ğŸ”„</div>
      <div class="sync-message">
        <strong>${updateInfo.modifiedBy}ë‹˜ì´ ë°œì£¼ì„œë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.</strong>
        <p>ë³€ê²½ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      </div>
      <div class="sync-actions">
        <button class="btn btn-primary btn-sm" onclick="reloadOrderItems()">
          ìƒˆë¡œê³ ì¹¨
        </button>
        <button class="btn btn-secondary btn-sm" onclick="dismissSyncNotification(this)">
          ë‚˜ì¤‘ì—
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.classList.add('show');
  }, 100);
}

// 4. ë°œì£¼ í•­ëª© ìƒˆë¡œê³ ì¹¨
function reloadOrderItems() {
  showLoading('ìµœì‹  ë°ì´í„° ë¡œë“œ ì¤‘...');
  
  loadOrderItemsFromSheetAsync()
    .then(() => {
      hideLoading();
      showQuickSuccess('ìµœì‹  ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
      dismissAllSyncNotifications();
    })
    .catch((error) => {
      hideLoading();
      showError('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error);
    });
}

// 5. ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ì €ì¥ ì „ ì²´í¬
function saveToOrderSheet(orderItems) {
  // ì €ì¥ ì „ ìµœì‹  ë²„ì „ í™•ì¸
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler((updateCheck) => {
        if (updateCheck.hasUpdate) {
          // ì¶©ëŒ ê°ì§€
          if (confirm(`${updateCheck.modifiedBy}ë‹˜ì´ ë°œì£¼ì„œë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.\nê³„ì† ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            proceedWithSave(orderItems, resolve, reject);
          } else {
            reject('ì €ì¥ ì·¨ì†Œë¨');
          }
        } else {
          proceedWithSave(orderItems, resolve, reject);
        }
      })
      .withFailureHandler(reject)
      .checkForUpdates(AppState.currentOrderInfo.orderId, currentVersion);
  });
}

function proceedWithSave(orderItems, resolve, reject) {
  google.script.run
    .withSuccessHandler((result) => {
      if (result.success) {
        currentVersion = result.version;
        resolve(result);
      } else {
        reject(result.message);
      }
    })
    .withFailureHandler(reject)
    .saveToOrderSheetWithVersion(orderItems);
}

// ===== localStorage ì•ˆì „ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====
// ì•ˆì „í•œ localStorage ì €ì¥
function safeSetItem(key, value) {
  try {
    const data = {
      value: value,
      timestamp: Date.now()
    };
    localStorage.setItem(key, JSON.stringify(data));
    return true;
  } catch (e) {
    console.error('localStorage ì €ì¥ ì‹¤íŒ¨:', e);
    // ìš©ëŸ‰ ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ í•­ëª© ì‚­ì œ
    if (e.name === 'QuotaExceededError') {
      clearOldestItems();
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (e2) {
        return false;
      }
    }
    return false;
  }
}

// ì•ˆì „í•œ localStorage ì½ê¸°
function safeGetItem(key) {
  try {
    const item = localStorage.getItem(key);
    if (!item) return null;
    
    const parsed = JSON.parse(item);
    return parsed.value;
  } catch (e) {
    console.error('localStorage ì½ê¸° ì‹¤íŒ¨:', e);
    localStorage.removeItem(key);
    return null;
  }
}

// ê°€ì¥ ì˜¤ë˜ëœ í•­ëª© ì‚­ì œ
function clearOldestItems() {
  const items = [];
  
  Object.keys(localStorage).forEach(key => {
    if (key === 'app_version') return;
    
    try {
      const item = JSON.parse(localStorage.getItem(key));
      if (item.timestamp) {
        items.push({ key, timestamp: item.timestamp });
      }
    } catch (e) {
      localStorage.removeItem(key);
    }
  });
  
  // ì˜¤ë˜ëœ ìˆœìœ¼ë¡œ ì •ë ¬
  items.sort((a, b) => a.timestamp - b.timestamp);
  
  // ì ˆë°˜ ì‚­ì œ
  const removeCount = Math.floor(items.length / 2);
  for (let i = 0; i < removeCount; i++) {
    localStorage.removeItem(items[i].key);
  }
}

// ===== 3. ì»¬ëŸ¬ ë§¤í•‘ í…Œì´ë¸” =====
const colorMap = {
  'black': '#000000',
  'ivory': '#FFFFF0',
  'white': '#FFFFFF',
  'cream': '#FFFDD0',
  'beige': '#F5F5DC',
  'light beige': '#F8F4E6',
  'light yellow': '#FFFDD0',
  'oatmeal': '#D4C5B0',
  'light gray': '#D3D3D3',
  'melange': '#CCCAC9',
  'light mint': '#e2f4eb',
  'denim': '#1b306b',
  'lemon': '#fffac8',
  'gray beige': '#d8cfc4',
  'purple': '#4f284b',
  'gray melange': '#87827d',
  'olive': '#6b822e',
  'white melange': 'eae9e8',
  'gray': '#808080',
  'deep gray': '#4B4B4B',
  'dark gray': '#3A3A3A',
  'charcoal': '#36454F',
  'charcoal gray': '#36454F',
  'charcoal brown': '#6e6565',
  'melange gray': '#B8B8B8',
  'mixed gray': '#666',
  'silver': '#C0C0C0',
  'stone': '#999999',
  'brown': '#8B4513',
  'dark brown': '#654321',
  'deep brown': '#5C4033',
  'light khaki': '#F0E68C',
  'khaki': '#C3B091',
  'camel': '#C19A6B',
  'mocha': '#967969',
  'mocca': '#967969',
  'pale blue': '#B0E0E6',
  'light blue': '#ADD8E6',
  'sky blue': '#87CEEB',
  'blue': '#0066CC',
  'cobalt blue': '#0047AB',
  'sora': '#87CEEB',
  'sora blue': '#87CEEB',
  'navy': '#000080',
  'deep navy': '#000054',
  'dark navy': '#00004C',
  'charcoal navy': '#1C2841',
  'red': '#DC143C',
  'wine': '#722F37',
  'pink': '#FFC0CB',
  'light pink': '#FFB6C1',
  'baby pink': '#FFE4E1',
  'dusty pink': '#D39999',
  'indie pink': '#FF69B4',
  'neon pink': '#FF10F0',
  'rose': '#FF007F',
  'green': '#008000',
  'light green': '#90EE90',
  'deep green': '#013220',
  'mint': '#3EB489',
  'sage': '#87A96B',
  'moss green': '#8A9A5B',
  'yellow': '#FFFF00',
  'mustard': '#FFDB58',
  'orange': '#FFA500',
  'brick': '#CB4154',
  'lavender': '#E6E6FA',
  'lime': '#BFFF00',
  'ivory melange': '#FAF0E6'
};

// ===== 4. ìºì‹œ ê´€ë¦¬ í†µí•© =====
class CacheManager {
  constructor() {
    this.productCache = new Map();
    this.searchCache = new Map();
    this.safetyStockCache = null;
    this.safetyStockCacheTime = null;
  }
  
  set(type, key, value, ttl = CONFIG.CACHE_TTL) {
    const cache = type === 'product' ? this.productCache : this.searchCache;
    
    if (cache.size >= CONFIG.MAX_CACHE_SIZE) {
      const firstKey = cache.keys().next().value;
      cache.delete(firstKey);
    }
    
    cache.set(key, {
      value: value,
      timestamp: Date.now(),
      ttl: ttl
    });
  }
  
  get(type, key) {
    const cache = type === 'product' ? this.productCache : this.searchCache;
    const item = cache.get(key);
    
    if (!item) return null;
    
    if (Date.now() - item.timestamp > item.ttl) {
      cache.delete(key);
      return null;
    }
    
    return item.value;
  }
  
  clear(type) {
    if (type === 'product') {
      this.productCache.clear();
    } else if (type === 'search') {
      this.searchCache.clear();
    } else {
      this.productCache.clear();
      this.searchCache.clear();
    }
  }
}

class LocalCache {
  constructor() {
    this.prefix = 'ohotoro_';
    this.maxAge = 30 * 60 * 1000; // 30ë¶„
  }
  
  set(key, data) {
    try {
      const item = {
        data: data,
        timestamp: Date.now()
      };
      localStorage.setItem(this.prefix + key, JSON.stringify(item));
      return true;
    } catch (e) {
      console.warn('ë¡œì»¬ ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', e);
      return false;
    }
  }
  
  get(key) {
    try {
      const item = localStorage.getItem(this.prefix + key);
      if (!item) return null;
      
      const parsed = JSON.parse(item);
      const age = Date.now() - parsed.timestamp;
      
      if (age > this.maxAge) {
        localStorage.removeItem(this.prefix + key);
        return null;
      }
      
      return parsed.data;
    } catch (e) {
      console.warn('ë¡œì»¬ ìºì‹œ ì½ê¸° ì‹¤íŒ¨:', e);
      return null;
    }
  }
  
  clear() {
    const keys = Object.keys(localStorage);
    keys.forEach(key => {
      if (key.startsWith(this.prefix)) {
        localStorage.removeItem(key);
      }
    });
  }
}

// ===== 5. SmartRetry í´ë˜ìŠ¤ =====
class SmartRetry {
  constructor() {
    this.maxRetries = 3;
    this.retryDelay = 1000;
    this.backoffMultiplier = 2;
  }
  
  async execute(functionName, args = [], options = {}) {
    const maxRetries = options.maxRetries || this.maxRetries;
    const retryDelay = options.retryDelay || this.retryDelay;
    let lastError;
    
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            [functionName](...args);
        });
      } catch (error) {
        lastError = error;
        
        if (attempt < maxRetries) {
          showRetryNotification(functionName, attempt, maxRetries);
          const delay = retryDelay * Math.pow(this.backoffMultiplier, attempt - 1);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }
    
    hideRetryNotification();
    throw new Error(`${functionName} ì‹¤í–‰ ì‹¤íŒ¨ (${maxRetries}íšŒ ì‹œë„): ${lastError}`);
  }
}

// ===== 6. ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ =====
const cache = new CacheManager();
const smartRetry = new SmartRetry();

// ===== 7. ì´ˆê¸°í™” =====
document.addEventListener('DOMContentLoaded', async function() {
  console.log('=== ì•± ì´ˆê¸°í™” ì‹œì‘ ===');
  const startTime = performance.now();

  // URL íŒŒë¼ë¯¸í„°ë¡œ ê°•ì œ ìƒˆë¡œê³ ì¹¨ í™•ì¸
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('refresh') === 'shipping') {
    sessionStorage.setItem('forceRefreshShipping', 'true');
    localStorage.removeItem('shippingSession');
  }
  
  showLoading('ì´ˆê¸° ì„¤ì • ë¡œë“œ ì¤‘...');
  
  try {
    // 1ë‹¨ê³„: ê¸°ë³¸ ì„¤ì • ë¡œë“œ
    const [settings, translations, orderInfo] = await Promise.all([
      loadSettingsDataOnly().catch(() => ({})),
      initializeLanguage().catch(() => ({})),
      checkCurrentOrderAsync().catch(() => null)
    ]);
    
    AppState.settings = settings;
    AppState.translations = translations;
    
    // ìŒì„± ì„¤ì • ë¡œë“œ ì¶”ê°€
    await loadVoiceSettings();
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupEventListeners();
    
    // ë°œì£¼ì„œ ì •ë³´ ì„¤ì •
    if (orderInfo) {
      AppState.currentOrderInfo = orderInfo;
      updateOrderStatus();
      enableOrderFeatures();
    }
    
    // 2ë‹¨ê³„: ìƒí’ˆ ë°ì´í„° ë¡œë“œ
    updateLoadingMessage('ìƒí’ˆ ë°ì´í„° ë¡œë“œ ì¤‘...');
    
    const dataPromises = [
      loadInitialProductsWithIssuesAsync(),
      loadSmaregiDataAsync(), // ì´ í•¨ìˆ˜ê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•¨
      loadCategoryRulesAsync().catch(() => ({}))
    ];
    
    // ë°œì£¼ì„œê°€ ìˆìœ¼ë©´ ë°œì£¼ í•­ëª©ë„ í•¨ê»˜ ë¡œë“œ
    if (orderInfo) {
      updateLoadingMessage('ë°œì£¼ í•­ëª© ë¡œë“œ ì¤‘...');
      dataPromises.push(
        loadOrderItemsFromSheetAsync()
          .then(items => {
            console.log('ë°œì£¼ í•­ëª© ë¡œë“œ ì™„ë£Œ:', items ? items.length : 0);
            // ë°œì£¼ ëª©ë¡ì´ ë¡œë“œë˜ë©´ ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
            updateOrderList();
            updateOrderSummary();
            return items;
          })
      );
    }
    
    // ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
    const results = await Promise.all(dataPromises);
    
    // 3ë‹¨ê³„: Smaregi ì—°ê²° ìƒíƒœ í™•ì¸ (ë°ì´í„° ë¡œë“œ í›„)
    checkSmaregiConnection();
    
    // 4ë‹¨ê³„: UI ì´ˆê¸°í™”
    initializeDisplaySettings();
    injectColorChipStyles();
    startAutoSave();
    
    // ì„¸ì…˜ ë³µì›
    if (AppState.currentOrderInfo && !restoreSession()) {
      // ì´ë¯¸ updateOrderList()ê°€ í˜¸ì¶œë˜ì—ˆìœ¼ë¯€ë¡œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
      console.log('ì„¸ì…˜ ë³µì› ìŠ¤í‚µ');
    }

    // Sticky Header ì„¤ì • (ì—¬ê¸°ì— ì¶”ê°€)
    setupStickyFooter();
    
    // 5ë‹¨ê³„: ëª¨ë“  ì‘ì—… ì™„ë£Œ í›„ ë¡œë”© ìˆ¨ê¸°ê¸°
    const loadTime = (performance.now() - startTime) / 1000;
    console.log(`ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ: ${loadTime.toFixed(1)}ì´ˆ`);
    
    hideLoading();
    showQuickSuccess(`ì´ˆê¸°í™” ì™„ë£Œ (${loadTime.toFixed(1)}ì´ˆ)`);
    
  } catch (error) {
    console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
    hideLoading();
    showError('ì•± ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
  }
});

// ë” ì„¸ë°€í•œ ë²„ì „ (í•„ìš”ì‹œ ì‚¬ìš©)
function setupStickyFooter() {
  const orderTab = document.getElementById('order-tab');
  const stickyFooter = document.getElementById('order-sticky-footer');
  const orderSection = document.getElementById('order-section');
  const orderActions = document.querySelector('.order-actions');
  
  if (!orderTab || !stickyFooter || !orderSection || !orderActions) return;
  
  let isSticky = false;
  
  function checkStickyState() {
    // ë°œì£¼ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ìˆ¨ê¹€
    if (!orderTab.classList.contains('active')) {
      if (isSticky) {
        stickyFooter.classList.remove('show');
        document.body.classList.remove('sticky-footer-active');
        isSticky = false;
      }
      return;
    }
    
    const actionsRect = orderActions.getBoundingClientRect();
    const windowHeight = window.innerHeight;
    const scrollY = window.scrollY;
    
    // ì›ë³¸ ë²„íŠ¼ì˜ í•˜ë‹¨ì´ ë·°í¬íŠ¸ ìƒë‹¨ì„ ë²—ì–´ë‚¬ê³ ,
    // ë°œì£¼ ëª©ë¡ì— í•­ëª©ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ
    const shouldShow = actionsRect.bottom < 0 && AppState.orderItems.length > 0;
    
    if (shouldShow && !isSticky) {
      stickyFooter.classList.add('show');
      document.body.classList.add('sticky-footer-active');
      updateStickyFooterSummary();
      isSticky = true;
    } else if (!shouldShow && isSticky) {
      stickyFooter.classList.remove('show');
      document.body.classList.remove('sticky-footer-active');
      isSticky = false;
    }
  }
  
  // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ (throttle ì ìš©)
  let scrollTimer;
  window.addEventListener('scroll', () => {
    if (scrollTimer) return;
    
    scrollTimer = setTimeout(() => {
      checkStickyState();
      scrollTimer = null;
    }, 50); // 50ms throttle
  });
  
  // íƒ­ ì „í™˜ ì‹œ ì²´í¬
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      setTimeout(checkStickyState, 100);
    });
  });
  
  // ë°œì£¼ ëª©ë¡ ì—…ë°ì´íŠ¸ ì‹œì—ë„ ì²´í¬
  const originalUpdateOrderList = window.updateOrderList;
  window.updateOrderList = function() {
    originalUpdateOrderList.apply(this, arguments);
    setTimeout(checkStickyState, 100);
  };
  
  // ì´ˆê¸° ìƒíƒœ ì²´í¬
  setTimeout(checkStickyState, 100);
}

// Sticky header ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸
function updateStickyFooterSummary() {
  const totalItems = document.getElementById('total-items').textContent;
  const totalQuantity = document.getElementById('total-quantity').textContent;
  const totalAmount = document.getElementById('total-amount').textContent;
  
  document.getElementById('sticky-total-items').textContent = totalItems;
  document.getElementById('sticky-total-quantity').textContent = totalQuantity;
  document.getElementById('sticky-total-amount').textContent = totalAmount;
}

function applyBundleData(bundle) {
  // ìƒí’ˆ ë°ì´í„°
  if (bundle.productsData) {
    AppState.products = bundle.productsData.products || [];
    AppState.productIssues = bundle.productsData.productIssues || {};
  }
  
  // ì„¤ì •
  if (bundle.settings) {
    AppState.settings = bundle.settings;
  }
  
  // í˜„ì¬ ë°œì£¼ì„œ
  if (bundle.currentOrder) {
    AppState.currentOrderInfo = bundle.currentOrder;
    updateOrderStatus();
    enableOrderFeatures();
  }
  
  // Smaregi ë°ì´í„°
  if (bundle.smaregiData) {
    AppState.smaregiData = bundle.smaregiData.data || {};
    AppState.smaregiUploadTime = bundle.smaregiData.uploadTime;
    AppState.smaregiDataLoaded = Object.keys(AppState.smaregiData).length > 0;
  }
  
  // ì¹´í…Œê³ ë¦¬ ê·œì¹™
  if (bundle.categoryRules) {
    AppState.categoryRules = bundle.categoryRules;
  }
  
  // UI ì´ˆê¸°í™”
  setupEventListeners();
  initializeDisplaySettings();
  injectColorChipStyles();
  startAutoSave();
  
  // ë°œì£¼ì„œê°€ ìˆìœ¼ë©´ ë°œì£¼ í•­ëª© ë¡œë“œ
  if (AppState.currentOrderInfo) {
    loadOrderItemsFromSheetAsync();
  }
}

// ë°±ê·¸ë¼ìš´ë“œ ì—…ë°ì´íŠ¸ í™•ì¸
function checkForUpdates() {
  // 5ì´ˆ í›„ì— ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìµœì‹  ë°ì´í„° í™•ì¸
  setTimeout(() => {
    google.script.run
      .withSuccessHandler((newBundle) => {
        if (newBundle && isDataUpdated(newBundle)) {
          // ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì—…ë°ì´íŠ¸
          const localCache = new LocalCache();
          localCache.set('initial_bundle', newBundle);
          console.log('ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }
      })
      .getInitialDataBundle();
  }, 5000);
}

// ì´ˆê¸° ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€)
async function loadInitialData(orderInfo) {
  const dataPromises = [
    loadInitialProductsWithIssuesAsync(),
    loadSmaregiDataAsync(),
    loadCategoryRulesAsync().catch(() => ({})),
    loadVoiceSettings()
  ];
  
  if (orderInfo) {
    dataPromises.push(loadOrderItemsFromSheetAsync());
  }
  
  const results = await Promise.all(dataPromises);
  
  // ë°œì£¼ í•­ëª© ì²˜ë¦¬
  if (orderInfo && results[3]) {
    console.log('ë°œì£¼ í•­ëª© ë¡œë“œ ì™„ë£Œ:', results[3].length);
  }
  
  return results;
}

// UI ì´ˆê¸°í™” í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€)
function initializeUI() {
  initializeDisplaySettings();
  injectColorChipStyles();
  setupKeyboardShortcuts();
  startAutoSave();
  
  // ì„¸ì…˜ ë³µì›
  if (AppState.currentOrderInfo && !restoreSession()) {
    updateOrderList();
  }
}


// loadSmaregiDataAsync í•¨ìˆ˜ ì¶”ê°€ (ì´ í•¨ìˆ˜ë¥¼ ìœ„ ì½”ë“œ ì•„ë˜ì— ì¶”ê°€)
async function loadSmaregiDataAsync() {
  return new Promise((resolve) => {
    google.script.run
      .withSuccessHandler((result) => {
        if (result && result.data) {
          AppState.smaregiData = result.data;
          AppState.smaregiUploadTime = result.uploadTime;
          AppState.smaregiDataLoaded = true;
          console.log(`Smaregi ë°ì´í„° ë¡œë“œ: ${Object.keys(result.data).length}ê°œ`);
          if (result.uploadTime) {
            console.log(`ì—…ë¡œë“œ ì‹œê°„: ${result.uploadTime}`);
          }
        } else {
          AppState.smaregiData = {};
          AppState.smaregiDataLoaded = false;
          console.log('Smaregi ë°ì´í„° ì—†ìŒ');
        }
        resolve(AppState.smaregiData);
      })
      .withFailureHandler((error) => {
        console.warn('Smaregi ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        AppState.smaregiData = {};
        AppState.smaregiDataLoaded = false;
        resolve({});
      })
      .getSmaregiData();
  });
}

// loadInitialProductsWithIssuesAsync í•¨ìˆ˜ ìˆ˜ì • (íƒ€ì„ì•„ì›ƒ ì¶”ê°€)
async function loadInitialProductsWithIssuesAsync() {
  return new Promise((resolve, reject) => {
    const timeout = setTimeout(() => {
      console.error('loadInitialProductsWithIssues íƒ€ì„ì•„ì›ƒ (30ì´ˆ)');
      resolve({ products: [], productIssues: {} });
    }, 30000); // 30ì´ˆ íƒ€ì„ì•„ì›ƒ
    
    google.script.run
      .withSuccessHandler((result) => {
        clearTimeout(timeout);
        if (result.products) {
          AppState.products = result.products;
          AppState.productIssues = result.productIssues || {};
          
          // ë¡œì»¬ ìºì‹œ ë³µì›
          restoreLocalCache();
        }
        console.log('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        resolve(result);
      })
      .withFailureHandler((error) => {
        clearTimeout(timeout);
        console.error('í†µí•© ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        resolve({ products: [], productIssues: {} });
      })
      .loadInitialProductsWithIssues();
  });
}

// ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateLoadingMessage(message) {
  const loadingEl = document.getElementById('loading');
  if (loadingEl) {
    const messageEl = loadingEl.querySelector('.loading-message');
    if (messageEl) {
      messageEl.textContent = message;
    }
  }
}

// ===== 8. ë¹„ë™ê¸° í•¨ìˆ˜ë“¤ =====
async function checkCurrentOrderAsync() {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(resolve)
      .withFailureHandler((error) => {
        console.error('getCurrentOrder ì‹¤íŒ¨:', error);
        resolve(null); // reject ëŒ€ì‹  null ë°˜í™˜
      })
      .getCurrentOrder();
  });
}

// scripts.htmlì˜ loadOrderItemsFromSheetAsync í•¨ìˆ˜ ìˆ˜ì •
async function loadOrderItemsFromSheetAsync() {
  if (!AppState.currentOrderInfo?.orderId) return [];
  
  return new Promise((resolve) => {
    google.script.run
      .withSuccessHandler((result) => {
        if (result?.success && result.items) {
          AppState.orderItems = result.items.map(item => ({
            ...item,
            searchText: `${item.barcode} ${item.name} ${item.option || ''}`.toLowerCase(),
            id: item.id || (Date.now() + Math.random())
          }));
          
          updateOrderList();
          updateOrderSummary();
          resolve(AppState.orderItems);
        } else {
          AppState.orderItems = [];
          updateOrderList();
          resolve([]);
        }
      })
      .withFailureHandler(() => {
        AppState.orderItems = [];
        updateOrderList();
        resolve([]);
      })
      .loadOrderItems(AppState.currentOrderInfo.orderId);
  });
}

async function loadInitialProductsAsync() {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler((data) => {
        console.log('ì´ˆê¸° ìƒí’ˆ ë¡œë“œ ì„±ê³µ:', data ? data.length : 0);
        AppState.products = data || [];
        
        // ì´ìŠˆ ì •ë³´ëŠ” ë³„ë„ë¡œ ë¡œë“œ (ì—ëŸ¬ê°€ ìˆì–´ë„ ê³„ì† ì§„í–‰)
        google.script.run
          .withSuccessHandler((issues) => {
            AppState.productIssues = issues || {};
            AppState.products.forEach(product => {
              if (AppState.productIssues[product.barcode]) {
                product.issueMemo = AppState.productIssues[product.barcode].memo;
                product.issueRemarks = AppState.productIssues[product.barcode].remarks;
              }
            });
          })
          .withFailureHandler((error) => {
            console.warn('ì´ìŠˆ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
          })
          .loadProductIssuesData();
        
        restoreLocalCache();
        resolve(data || []);
      })
      .withFailureHandler((error) => {
        console.error('loadInitialProducts ì‹¤íŒ¨:', error);
        resolve([]); // reject ëŒ€ì‹  ë¹ˆ ë°°ì—´ ë°˜í™˜
      })
      .loadInitialProducts();
  });
}

async function loadCategoryRulesAsync() {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler((rules) => {
        AppState.categoryRules = rules || {};
        resolve(rules || {});
      })
      .withFailureHandler((error) => {
        console.warn('ì¹´í…Œê³ ë¦¬ ê·œì¹™ ë¡œë“œ ì‹¤íŒ¨:', error);
        resolve({}); // reject ëŒ€ì‹  ë¹ˆ ê°ì²´ ë°˜í™˜
      })
      .loadCategoryRules();
  });
}

// ===== 9. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • =====
function setupEventListeners() {
  // === ì´ë²¤íŠ¸ ìœ„ì„ (matches ì œê±°) ===
  document.body.addEventListener('click', handleGlobalClick);
  document.body.addEventListener('change', handleGlobalChange);
  document.body.addEventListener('keydown', handleGlobalKeydown);
  
  // === ê²€ìƒ‰ ê´€ë ¨ ===
  const searchInput = document.getElementById('search-input');
  const searchBtn = document.getElementById('search-btn');
  
  if (searchBtn) {
    searchBtn.addEventListener('click', performSearch);
  }
  
  if (searchInput) {
    // autofocus ëŒ€ì‹  placeholderë¡œ ì•ˆë‚´
    searchInput.placeholder = 'í´ë¦­í•˜ì—¬ ê²€ìƒ‰ ì‹œì‘...';
    
    // ì‚¬ìš©ìê°€ í´ë¦­í–ˆì„ ë•Œë§Œ í¬ì»¤ìŠ¤
    searchInput.addEventListener('click', function() {
      this.placeholder = 'ìƒí’ˆëª… ë˜ëŠ” ë°”ì½”ë“œë¡œ ê²€ìƒ‰...';
    });
    
    const debouncedSearch = debounce(performSearch, 1000);
    
    searchInput.addEventListener('input', function(e) {
      const query = e.target.value.trim();
      if (query.length >= 2) {
        debouncedSearch();
      }
    });
    
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        performSearch();
      }
    });
  }
  
  // === íƒœê·¸ í•„í„° ===
  document.querySelectorAll('.tag-filter').forEach(filter => {
    filter.addEventListener('click', function() {
      document.querySelectorAll('.tag-filter').forEach(f => f.classList.remove('active'));
      this.classList.add('active');
      AppState.currentFilter = this.dataset.tag;
      filterSearchResults();
    });
  });
  
  // === ë°œì£¼ ì•¡ì…˜ ë²„íŠ¼ë“¤ ===
  const saveBtn = document.getElementById('save-draft-btn');
  if (saveBtn) saveBtn.addEventListener('click', saveDraft);
  
  const confirmSelectedBtn = document.getElementById('confirm-selected-btn');
  if (confirmSelectedBtn) confirmSelectedBtn.addEventListener('click', confirmSelectedItems);
  
  const confirmAllBtn = document.getElementById('confirm-all-btn');
  if (confirmAllBtn) confirmAllBtn.addEventListener('click', confirmAllItems);
  
  const clearBtn = document.getElementById('clear-btn');
  if (clearBtn) clearBtn.addEventListener('click', clearOrders);
  
  // === ë°œì£¼ì„œ ê´€ë¦¬ ë²„íŠ¼ë“¤ ===
  const createOrderBtn = document.getElementById('create-order-btn');
  if (createOrderBtn) {
    createOrderBtn.addEventListener('click', showCreateOrderModal);
  }
  
  const openOrderBtn = document.getElementById('open-order-btn');
  if (openOrderBtn) {
    openOrderBtn.addEventListener('click', showOpenOrderModal);
  }
  
  const mergeItemsBtn = document.getElementById('merge-items-btn');
  if (mergeItemsBtn) {
    mergeItemsBtn.addEventListener('click', mergeDuplicateItems);
  }
  
  // === ë°œì£¼ì„œ ìƒì„± ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ ===
  const createOrderConfirmBtn = document.getElementById('create-order-confirm');
  if (createOrderConfirmBtn) {
    createOrderConfirmBtn.addEventListener('click', createOrder);
  }
  
  // === ì„¤ì • ì €ì¥ ===
  const saveSettingsBtn = document.getElementById('save-settings');
  if (saveSettingsBtn) {
    saveSettingsBtn.addEventListener('click', saveSettings);
  }
  
  // === ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ë“¤ ===
  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', function() {
      const modal = this.closest('.modal');
      if (modal && modal.id) {
        closeModal(modal.id);
      }
    });
  });
  
  // === ì¬ê³  ìƒíƒœ ëª¨ë‹¬ ë¼ë””ì˜¤ ë²„íŠ¼ ===
  document.querySelectorAll('input[name="stockStatus"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const customInput = document.getElementById('custom-status');
      if (this.value === 'custom') {
        customInput.disabled = false;
        customInput.focus();
      } else {
        customInput.disabled = true;
        customInput.value = '';
      }
    });
  });
  
  // === í˜ì´ì§€ ì–¸ë¡œë“œ ===
  window.addEventListener('beforeunload', handleBeforeUnload);
  
  // === ì½”ë©˜íŠ¸ íˆ´íŒ ì„¤ì • ===
  setupCommentTooltips();
  
  // === ë™ì  ì´ë²¤íŠ¸ ìœ„ì„ ì„¤ì • ===
  setupDynamicEventDelegation();
}

let currentCommentTooltip = null;
let commentTooltipTimeout = null;

// íˆ´íŒ í‘œì‹œ í•¨ìˆ˜
function showCommentTooltip(button) {
  // ê¸°ì¡´ íˆ´íŒ ì œê±°
  hideCommentTooltip();
  
  const orderItem = button.closest('.order-item');
  if (!orderItem || !orderItem.dataset.id) return;
  
  const itemId = orderItem.dataset.id;
  const item = AppState.orderItems.find(i => String(i.id) === String(itemId));
  
  if (!item || !item.comment) return;
  
  // íˆ´íŒ ìƒì„±
  const tooltip = document.createElement('div');
  tooltip.className = 'comment-tooltip';
  tooltip.id = 'active-comment-tooltip';
  tooltip.textContent = item.comment;
  
  // bodyì— ì¶”ê°€
  document.body.appendChild(tooltip);
  
  // ìœ„ì¹˜ ê³„ì‚°
  const rect = button.getBoundingClientRect();
  const tooltipRect = tooltip.getBoundingClientRect();
  
  // ê¸°ë³¸ ìœ„ì¹˜ (ë²„íŠ¼ ìœ„)
  let top = rect.top - tooltipRect.height - 10;
  let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
  
  // í™”ë©´ ìƒë‹¨ ë²—ì–´ë‚¨ ì²´í¬
  if (top < 10) {
    // ë²„íŠ¼ ì•„ë˜ë¡œ í‘œì‹œ
    top = rect.bottom + 10;
    tooltip.classList.add('bottom');
    
    // í™”ì‚´í‘œ ë°©í–¥ ë³€ê²½ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ ì¶”ê°€
    const style = document.createElement('style');
    style.textContent = `
      #active-comment-tooltip.bottom::before {
        top: -5px;
        bottom: auto;
        border-top: none;
        border-bottom: 5px solid #333;
      }
    `;
    tooltip.appendChild(style);
  }
  
  // ì¢Œìš° í™”ë©´ ë²—ì–´ë‚¨ ì²´í¬
  if (left < 10) {
    left = 10;
  } else if (left + tooltipRect.width > window.innerWidth - 10) {
    left = window.innerWidth - tooltipRect.width - 10;
  }
  
  tooltip.style.position = 'fixed';
  tooltip.style.top = top + 'px';
  tooltip.style.left = left + 'px';
  
  currentCommentTooltip = tooltip;
  
  // í˜ì´ë“œì¸ íš¨ê³¼
  requestAnimationFrame(() => {
    tooltip.classList.add('visible');
  });
}

// íˆ´íŒ ìˆ¨ê¸°ê¸° í•¨ìˆ˜
function hideCommentTooltip() {
  if (currentCommentTooltip) {
    currentCommentTooltip.classList.remove('visible');
    setTimeout(() => {
      if (currentCommentTooltip) {
        currentCommentTooltip.remove();
        currentCommentTooltip = null;
      }
    }, 200);
  }
  
  // ê¸°ì¡´ ë°©ì‹ë„ ì§€ì› (í˜¸í™˜ì„±)
  const existingTooltip = document.getElementById('active-comment-tooltip');
  if (existingTooltip && existingTooltip !== currentCommentTooltip) {
    existingTooltip.remove();
  }
}

// ì½”ë©˜íŠ¸ íˆ´íŒ ì´ë²¤íŠ¸ ì„¤ì •
function setupCommentTooltips() {
  // ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©
  document.addEventListener('mouseenter', function(e) {
    // e.targetì´ Elementì¸ì§€ í™•ì¸
    if (!e.target || typeof e.target.closest !== 'function') return;
    
    const commentBtn = e.target.closest('.order-action-btn.comment.has-comment');
    if (!commentBtn) return;
    
    // íƒ€ì´ë¨¸ ì´ˆê¸°í™”
    if (commentTooltipTimeout) {
      clearTimeout(commentTooltipTimeout);
    }
    
    // ì•½ê°„ì˜ ì§€ì—° í›„ íˆ´íŒ í‘œì‹œ
    commentTooltipTimeout = setTimeout(() => {
      showCommentTooltip(commentBtn);
    }, 300);
  }, true);
  
  document.addEventListener('mouseleave', function(e) {
    // e.targetì´ Elementì¸ì§€ í™•ì¸
    if (!e.target || typeof e.target.closest !== 'function') return;
    
    const commentBtn = e.target.closest('.order-action-btn.comment.has-comment');
    if (!commentBtn) return;
    
    // íƒ€ì´ë¨¸ ì·¨ì†Œ
    if (commentTooltipTimeout) {
      clearTimeout(commentTooltipTimeout);
      commentTooltipTimeout = null;
    }
    
    // íˆ´íŒ ìˆ¨ê¸°ê¸°
    hideCommentTooltip();
  }, true);
  
  // ìŠ¤í¬ë¡¤ ì‹œ íˆ´íŒ ìˆ¨ê¸°ê¸°
  document.addEventListener('scroll', function() {
    hideCommentTooltip();
  }, true);
  
  // í´ë¦­ ì‹œ íˆ´íŒ ìˆ¨ê¸°ê¸°
  document.addEventListener('click', function() {
    hideCommentTooltip();
  }, true);
}

// DOM ë¡œë“œ í›„ ì‹¤í–‰
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupCommentTooltips);
} else {
  setupCommentTooltips();
}

// setupEventListeners() í•¨ìˆ˜ ë‚´ì—ì„œ í˜¸ì¶œ
setupCommentTooltips();

// ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ìš”ì†Œë“¤ì˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
function setupDynamicEventDelegation() {
  // ëª¨ë‹¬ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë  ë•Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      mutation.addedNodes.forEach(function(node) {
        if (node.nodeType === 1) { // Element node
          // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
          if (node.classList && node.classList.contains('modal')) {
            const closeBtn = node.querySelector('.modal-close');
            if (closeBtn && !closeBtn.hasAttribute('data-listener')) {
              closeBtn.setAttribute('data-listener', 'true');
              closeBtn.addEventListener('click', function() {
                closeModal(node.id);
              });
            }
          }
        }
      });
    });
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
}

// ===== ì¬ê³  ìƒíƒœ ë³‘í•© í—¬í¼ í•¨ìˆ˜ =====
function getMergedStockStatus(items) {
  // ì¬ê³  ìƒíƒœ ìš°ì„ ìˆœìœ„ (ë‚®ì„ìˆ˜ë¡ ìš°ì„ )
  const stockPriority = {
    'í’ˆì ˆ': 1,
    'ì˜¤ë”ì¤‘': 2,
    // "Xê°œë§Œ ê°€ëŠ¥" í˜•íƒœëŠ” 3ìœ¼ë¡œ ì²˜ë¦¬
    'ê°€ëŠ¥': 4,
    'ë¯¸í™•ì¸': 5
  };
  
  let mostRestrictive = null;
  let lowestPriority = 999;
  let minAvailableQty = Infinity;
  
  items.forEach(item => {
    const status = item.stockAvailable || 'ë¯¸í™•ì¸';
    
    // "Xê°œë§Œ ê°€ëŠ¥" í˜•íƒœ ì²˜ë¦¬
    const partialMatch = status.match(/(\d+)ê°œë§Œ ê°€ëŠ¥/);
    if (partialMatch) {
      const availableQty = parseInt(partialMatch[1]);
      if (availableQty < minAvailableQty) {
        minAvailableQty = availableQty;
        mostRestrictive = status;
        lowestPriority = 3;
      }
    } else {
      // ì¼ë°˜ ìƒíƒœ ì²˜ë¦¬
      const priority = stockPriority[status] || 999;
      if (priority < lowestPriority) {
        lowestPriority = priority;
        mostRestrictive = status;
      }
    }
  });
  
  return mostRestrictive || 'ë¯¸í™•ì¸';
}

function mergeDuplicateItems() {
  if (!AppState.currentOrderInfo) {
    showError('ë¨¼ì € ë°œì£¼ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (AppState.orderItems.length === 0) {
    showError('ë³‘í•©í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  const groupedItems = {};
  let mergedCount = 0;
  let conflictCount = 0;
  let exportedSkipCount = 0;
  
  // ë°”ì½”ë“œë³„ë¡œ ê·¸ë£¹í™”
  AppState.orderItems.forEach(item => {
    if (!groupedItems[item.barcode]) {
      groupedItems[item.barcode] = {
        exported: [],
        confirmed: [],
        unconfirmed: []
      };
    }
    
    if (item.exportedAt || item.exportStatus) {
      groupedItems[item.barcode].exported.push(item);
    } else if (item.status === 'í™•ì •') {
      groupedItems[item.barcode].confirmed.push(item);
    } else {
      groupedItems[item.barcode].unconfirmed.push(item);
    }
  });
  
  // ë³‘í•© ì‹¤í–‰
  const newOrderItems = [];
  const mergeReport = [];
  
  Object.keys(groupedItems).forEach(barcode => {
    const group = groupedItems[barcode];
    
    // ë‚´ë³´ë‚´ê¸°ëœ í•­ëª©ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
    group.exported.forEach(item => {
      newOrderItems.push(item);
      if (group.confirmed.length > 1) {
        exportedSkipCount++; // ë³‘í•© ê°€ëŠ¥í–ˆì§€ë§Œ ë‚´ë³´ë‚´ê¸° ë•Œë¬¸ì— ìŠ¤í‚µ
      }
    });
    
    // ë‚´ë³´ë‚´ê¸°ë˜ì§€ ì•Šì€ í™•ì • í•­ëª©ë“¤ ë³‘í•©
    if (group.confirmed.length > 1) {
      const mergedConfirmed = {
        ...group.confirmed[0],
        quantity: group.confirmed.reduce((sum, item) => sum + item.quantity, 0),
        comment: group.confirmed
          .map(item => item.comment)
          .filter(c => c)
          .join(' / '),
        priority: Math.min(...group.confirmed.map(item => item.priority || 3)),
        stockAvailable: getMergedStockStatus(group.confirmed)
      };
      
      // ì¬ê³  ìƒíƒœê°€ ë‹¤ë¥¸ ê²½ìš° ê²½ê³ 
      const uniqueStockStatuses = new Set(group.confirmed.map(item => item.stockAvailable));
      if (uniqueStockStatuses.size > 1) {
        conflictCount++;
        mergeReport.push({
          name: group.confirmed[0].name,
          statuses: Array.from(uniqueStockStatuses),
          merged: mergedConfirmed.stockAvailable
        });
      }
      
      newOrderItems.push(mergedConfirmed);
      mergedCount += group.confirmed.length - 1;
    } else if (group.confirmed.length === 1) {
      // í™•ì • í•­ëª©ì´ 1ê°œë§Œ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì¶”ê°€
      newOrderItems.push(group.confirmed[0]);
    }
    
    // ë¯¸í™•ì • í•­ëª©ë“¤ì€ ë³‘í•©í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ì¶”ê°€
    group.unconfirmed.forEach(item => {
      newOrderItems.push(item);
    });
  });
  
  if (mergedCount > 0) {
    AppState.orderItems = newOrderItems;
    updateOrderList();
    scheduleAutoSave();
    
    let message = `âœ… ${mergedCount}ê°œì˜ ì¤‘ë³µ í•­ëª©ì´ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤.`;
    
    if (exportedSkipCount > 0) {
      message += `\nğŸ“¤ ${exportedSkipCount}ê°œëŠ” ì´ë¯¸ ë‚´ë³´ë‚´ê¸°ë˜ì–´ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.`;
    }
    
    if (conflictCount > 0) {
      message += `\nâš ï¸ ${conflictCount}ê°œ í•­ëª©ì˜ ì¬ê³  ìƒíƒœê°€ ë‹¬ë¼ ê°€ì¥ ì œí•œì ì¸ ìƒíƒœë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`;
    }
    
    // showInfo ëŒ€ì‹  ëª¨ë‹¬ë¡œ í‘œì‹œ
    const modalContent = `
      <div style="padding: 20px;">
        <h3>ë³‘í•© ì™„ë£Œ</h3>
        <p style="white-space: pre-line;">${message}</p>
        <div style="margin-top: 20px; text-align: right;">
          <button class="btn btn-primary" onclick="closeModal()">í™•ì¸</button>
        </div>
      </div>
    `;
    showModal(modalContent);
    
  } else if (exportedSkipCount > 0) {
    showError('ë³‘í•© ê°€ëŠ¥í•œ í•­ëª©ì´ ìˆì§€ë§Œ ëª¨ë‘ ë‚´ë³´ë‚´ê¸°ë˜ì–´ ë³‘í•©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  } else {
    showError('ë³‘í•©í•  ì¤‘ë³µ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
  }
}

// ===== 10. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ =====
function handleGlobalClick(e) {
  const target = e.target;
  
  // íƒ­ ì „í™˜
  if (target.classList && target.classList.contains('nav-btn')) {
    e.preventDefault();
    switchTab(target.dataset.tab);
    return;
  }
  
  // ëª¨ë‹¬ ë‹«ê¸°
  if (target.classList && target.classList.contains('modal-close')) {
    e.preventDefault();
    const modal = target.closest('.modal');
    if (modal) closeModal(modal.id);
    return;
  }
  
  // Quick ë©”ë‰´ ì™¸ë¶€ í´ë¦­
  const isQuickMenu = target.closest('.quick-stock-menu');
  const isStockBtn = target.classList && target.classList.contains('stock-status-btn');
  
  if (!isQuickMenu && !isStockBtn) {
    document.querySelectorAll('.quick-stock-menu.show').forEach(menu => {
      menu.classList.remove('show');
    });
  }
}

function handleGlobalChange(e) {
  const target = e.target;
  
  if (target.classList && target.classList.contains('quantity-input')) {
    const orderItem = target.closest('.order-item');
    if (orderItem && orderItem.dataset.id) {
      updateQuantity(orderItem.dataset.id, target.value);
    }
  }
  
  if (target.classList && target.classList.contains('order-checkbox')) {
    updateBulkEditButton();
  }
}

function handleGlobalKeydown(e) {
  const target = e.target;
  
  if (e.key === 'Escape') {
    closeAllModals();
    return;
  }
  
  if (e.altKey && e.key.toLowerCase() === 's') {
    e.preventDefault();
    if (AppState.currentOrderInfo && AppState.orderItems.length > 0) {
      saveDraft();
    }
  }
  
  if (e.altKey && e.key.toLowerCase() === 'f') {
    e.preventDefault();
    const searchInput = document.getElementById('search-input');
    if (searchInput) searchInput.focus();
  }
  
  if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
    e.preventDefault();
    openProductIssueModal();
  }
}

// ===== 11. íƒ­ ì „í™˜ =====
function switchTab(tabName) {
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.tab === tabName) {
      btn.classList.add('active');
    }
  });
  
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(`${tabName}-tab`).classList.add('active');
  
  if (tabName === 'dashboard') {
    loadDashboard();
  } else if (tabName === 'frequent') {
    loadFrequentItems();
  } else if (tabName === 'settings') {
    loadSettingsTab(); // ìˆ˜ì •
  } else if (tabName === 'safety-stock') {
    loadSafetyStockTab();
  }
}

// ì„¤ì • íƒ­ ë¡œë“œ í•¨ìˆ˜ ì¶”ê°€
function loadSettingsTab() {
  if (AppState.settings && Object.keys(AppState.settings).length > 0) {
    displaySettings(AppState.settings);
  } else {
    google.script.run
      .withSuccessHandler((settings) => {
        AppState.settings = settings;
        displaySettings(settings);
      })
      .withFailureHandler(() => {
        displaySettings({});
      })
      .getSettings();
  }
  
  setTimeout(initializeDisplaySettings, 100);
}

// ===== 12. ë°œì£¼ì„œ ê´€ë¦¬ =====
function updateOrderStatus() {
  const statusContainer = document.getElementById('current-order-info');
  
  if (AppState.currentOrderInfo) {
    statusContainer.innerHTML = `
      <div class="order-details">
        <span class="order-badge">ì‘ì—…ì¤‘</span>
        <span class="order-name">${AppState.currentOrderInfo.fileName}</span>
        <span class="order-recipient">(${AppState.currentOrderInfo.recipientName})</span>
        <a href="${AppState.currentOrderInfo.orderUrl}" target="_blank" class="btn btn-sm">ğŸ“ open</a>
      </div>
    `;
  } else {
    statusContainer.innerHTML = '<span class="no-order-message">ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”.</span>';
  }
}

function enableOrderFeatures() {
  // search-sectionê³¼ order-sectionì€ ì¡´ì¬í•˜ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
  const searchSection = document.getElementById('search-section');
  const orderSection = document.getElementById('order-section');
  
  if (searchSection) searchSection.classList.remove('disabled');
  if (orderSection) orderSection.classList.remove('disabled');
  
  // ê° ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì²˜ë¦¬
  const searchInput = document.getElementById('search-input');
  if (searchInput) searchInput.disabled = false;
  
  const searchBtn = document.getElementById('search-btn');
  if (searchBtn) searchBtn.disabled = false;
  
  // ì´ ë²„íŠ¼ë“¤ì€ HTMLì— ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  const saveDraftBtn = document.getElementById('save-draft-btn');
  if (saveDraftBtn) saveDraftBtn.disabled = false;
  
  const confirmSelectedBtn = document.getElementById('confirm-selected-btn');
  if (confirmSelectedBtn) confirmSelectedBtn.disabled = false;
  
  const confirmAllBtn = document.getElementById('confirm-all-btn');
  if (confirmAllBtn) confirmAllBtn.disabled = false;
  
  const clearBtn = document.getElementById('clear-btn');
  if (clearBtn) clearBtn.disabled = false;
  
  const exportCsvBtn = document.getElementById('export-csv-btn');
  if (exportCsvBtn) exportCsvBtn.disabled = false;
  
  // updateExportButtonStatus í•¨ìˆ˜ë„ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
  if (typeof updateExportButtonStatus === 'function') {
    updateExportButtonStatus();
  }
}

// ===== 13. ë°œì£¼ì„œ ìƒì„±/ì—´ê¸° =====

function createOrder() {
  const recipientSelect = document.getElementById('recipient-select');
  const newRecipientInput = document.getElementById('new-recipient-input');
  const recipientName = newRecipientInput.value.trim() || recipientSelect.value;
  
  if (!recipientName) {
    showError('ë°œì£¼ì²˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ë¡œë”© í‘œì‹œ ì‹œì‘
  showLoading('ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
  
  // ë¯¸ì¶œê³  í•­ëª© ë¨¼ì € í™•ì¸
  google.script.run
    .withSuccessHandler(function(undeliveredItems) {
      // ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      updateLoadingMessage('ë¯¸ì¶œê³  í•­ëª©ì„ í™•ì¸í•˜ëŠ” ì¤‘...');
      
      if (undeliveredItems && undeliveredItems.length > 0) {
        hideLoading();
        
        if (confirm(`ì´ì „ ë°œì£¼ì—ì„œ ë¯¸ì¶œê³ ëœ í•­ëª©ì´ ${undeliveredItems.length}ê°œ ìˆìŠµë‹ˆë‹¤.\në°œì£¼ëª©ë¡ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          createOrderWithUndelivered(recipientName, undeliveredItems);
        } else {
          createOrderNormal(recipientName);
        }
      } else {
        createOrderNormal(recipientName);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      console.warn('ë¯¸ì¶œê³  í•­ëª© í™•ì¸ ì‹¤íŒ¨:', error);
      // ì‹¤íŒ¨í•´ë„ ë°œì£¼ì„œëŠ” ìƒì„±
      createOrderNormal(recipientName);
    })
    .getUndeliveredItems();
}

function createNewOrderWithBase() {
  showCreateOrderModal(); // ê¸°ì¡´ ëª¨ë‹¬ í™œìš©
}

// ë¯¸ì¶œê³  í•­ëª© í¬í•¨í•˜ì—¬ ë°œì£¼ì„œ ìƒì„±
function createOrderWithUndelivered(recipientName, undeliveredItems) {
  showLoading(`ë°œì£¼ì„œ ìƒì„± ì¤‘... (ë¯¸ì¶œê³  ${undeliveredItems.length}ê°œ í•­ëª© í¬í•¨)`);
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        AppState.currentOrderInfo = result.orderInfo;
        AppState.orderItems = [];
        clearSession();
        
        updateOrderStatus();
        enableOrderFeatures();
        
        // ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        updateLoadingMessage('ë¯¸ì¶œê³  í•­ëª©ì„ ì¶”ê°€í•˜ëŠ” ì¤‘...');
        
        // ë¯¸ì¶œê³  í•­ëª©ì„ ë°œì£¼ ëª©ë¡ì— ì¶”ê°€
        let addedCount = 0;
        const totalItems = undeliveredItems.length;
        
        undeliveredItems.forEach((item, index) => {
          google.script.run
            .withSuccessHandler(function(productDetails) {
              if (productDetails) {
                const orderItem = {
                  ...productDetails,
                  quantity: item.undeliveredQty,
                  priority: 1, // ë†’ì€ ìš°ì„ ìˆœìœ„
                  comment: `ë¯¸ì¶œê³  (${item.lastDate})`,
                  status: 'ëŒ€ê¸°',
                  id: Date.now() + index,
                  stockAvailable: 'ë¯¸í™•ì¸'
                };
                
                AppState.orderItems.push(orderItem);
                addedCount++;
                
                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                updateLoadingMessage(`ë¯¸ì¶œê³  í•­ëª© ì¶”ê°€ ì¤‘... (${addedCount}/${totalItems})`);
                
                if (addedCount === totalItems) {
                  hideLoading();
                  updateOrderList();
                  scheduleAutoSave();
                  showQuickSuccess(`ë°œì£¼ì„œê°€ ìƒì„±ë˜ê³  ${addedCount}ê°œì˜ ë¯¸ì¶œê³  í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
              }
            })
            .withFailureHandler(function(error) {
              console.error('ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
              addedCount++;
              
              if (addedCount === totalItems) {
                hideLoading();
                updateOrderList();
              }
            })
            .getProductDetails(item.code);
        });
        
        closeModal('create-order-modal');
      } else {
        hideLoading();
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('ë°œì£¼ì„œ ìƒì„± ì‹¤íŒ¨: ' + error);
    })
    .createNewOrder(recipientName);
}

function createOrderNormal(recipientName) {
  showLoading('ìƒˆ ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        AppState.currentOrderInfo = result.orderInfo;
        AppState.orderItems = [];
        clearSession();
        
        updateOrderStatus();
        enableOrderFeatures();
        updateOrderList();
        closeModal('create-order-modal');
        showQuickSuccess(result.message);
      } else {
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('ë°œì£¼ì„œ ìƒì„± ì‹¤íŒ¨: ' + error);
    })
    .createNewOrder(recipientName);
}

function addUndeliveredItemsToOrder(items) {
  let processed = 0;
  
  items.forEach((item, index) => {
    // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ìˆœì°¨ì ìœ¼ë¡œ ì¶”ê°€
    setTimeout(() => {
      google.script.run
        .withSuccessHandler((productDetails) => {
          if (productDetails) {
            const orderItem = {
              ...productDetails,
              quantity: item.quantity,
              priority: item.priority,
              comment: item.comment,
              status: 'ëŒ€ê¸°',
              id: Date.now() + index,
              stockAvailable: 'ë¯¸í™•ì¸'
            };
            
            AppState.orderItems.push(orderItem);
            processed++;
            
            if (processed === items.length) {
              updateOrderList();
              scheduleAutoSave();
              showQuickSuccess(`${items.length}ê°œì˜ ë¯¸ì¶œê³  í•­ëª©ì´ ë°œì£¼ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
          }
        })
        .withFailureHandler((error) => {
          console.error('ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
          processed++;
        })
        .getProductDetails(item.barcode);
    }, index * 100); // 100ms ê°„ê²©ìœ¼ë¡œ í˜¸ì¶œ
  });
}

function showCreateOrderModal() {
  const modal = document.getElementById('create-order-modal');
  const recipientSelect = document.getElementById('recipient-select');
  
  showSaveIndicator('loading');
  google.script.run
    .withSuccessHandler(function(recipients) {
      showSaveIndicator('hide');
      recipientSelect.innerHTML = '<option value="">ë°œì£¼ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
      recipients.forEach(recipient => {
        const option = document.createElement('option');
        option.value = recipient;
        option.textContent = recipient;
        recipientSelect.appendChild(option);
      });
      modal.style.display = 'block';
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ë°œì£¼ì²˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
    })
    .getOrderRecipientsList();
}

function showOpenOrderModal() {
  const modal = document.getElementById('open-order-modal');
  const listContainer = document.getElementById('recent-orders-list');
  
  listContainer.innerHTML = `
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>ìµœê·¼ 30ì¼ê°„ì˜ ë°œì£¼ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  `;
  modal.style.display = 'block';
  
  google.script.run
    .withSuccessHandler(function(orders) {
      if (!orders || orders.length === 0) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“‹</div>
            <h3>ìµœê·¼ ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
          </div>
        `;
        return;
      }
      
      const ordersByDate = {};
      orders.forEach(order => {
        const date = new Date(order.createdAt);
        const dateKey = date.toLocaleDateString('ko-KR');
        if (!ordersByDate[dateKey]) {
          ordersByDate[dateKey] = [];
        }
        ordersByDate[dateKey].push(order);
      });
      
      let html = `<div class="order-list-header"><h4>ìµœê·¼ 30ì¼ê°„ ë°œì£¼ì„œ (ì´ ${orders.length}ê°œ)</h4></div>`;
      
      Object.keys(ordersByDate)
        .sort((a, b) => new Date(b) - new Date(a))
        .forEach(dateKey => {
          html += `
            <div class="order-date-group">
              <div class="date-header">${dateKey}</div>
              ${ordersByDate[dateKey].map(order => `
                <div class="recent-order-item" onclick="openExistingOrder('${order.id || ''}')">
                  <div class="recent-order-header">
                    <div class="recent-order-supplier">${order.supplier || 'ì•Œ ìˆ˜ ì—†ìŒ'}</div>
                    <div class="recent-order-time">${new Date(order.createdAt).toLocaleTimeString('ko-KR')}</div>
                  </div>
                  <div class="recent-order-name">${order.name || 'ì œëª© ì—†ìŒ'}</div>
                </div>
              `).join('')}
            </div>
          `;
        });
      
      listContainer.innerHTML = html;
    })
    .withFailureHandler(function(error) {
      listContainer.innerHTML = `
        <div class="error-state">
          <div class="error-icon">âŒ</div>
          <h3>ë°œì£¼ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</h3>
        </div>
      `;
    })
    .getRecentOrders();
}

function openExistingOrder(orderId) {
  if (!orderId) {
    showError('ë°œì£¼ì„œ IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return;
  }
  
  showSaveIndicator('loading');
  AppState.orderItems = [];
  clearSession();
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result?.success) {
        AppState.currentOrderInfo = result.orderInfo;
        AppState.orderItems = result.items || [];
        
        updateOrderStatus();
        enableOrderFeatures();
        updateOrderList();
        closeModal('open-order-modal');
        showQuickSuccess(`ë°œì£¼ì„œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (${AppState.orderItems.length}ê°œ í•­ëª©)`);
      } else {
        showError(result?.message || 'ë°œì£¼ì„œë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ë°œì£¼ì„œ ì—´ê¸° ì‹¤íŒ¨: ' + error);
    })
    .openOrder(orderId);
}

// ===== 14. ê²€ìƒ‰ ê¸°ëŠ¥ =====
function performSearch() {
  const query = document.getElementById('search-input').value.trim();
  
  if (!query || query.length < 2) {
    if (query.length === 1) {
      showError('ê²€ìƒ‰ì–´ë¥¼ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }
    return;
  }
  
  const container = document.getElementById('search-results');
  
  // ê²€ìƒ‰ì–´ë¥¼ ë‹¨ì–´ ë‹¨ìœ„ë¡œ ë¶„ë¦¬
  const searchTerms = query.toLowerCase().split(/\s+/);
  
  // ë¡œì»¬ ê²€ìƒ‰ ë¡œì§ ê°œì„ 
  const localResults = AppState.products.filter(product => {
    const searchableText = [
      product.barcode || '',
      product.name || '',
      product.option || '',
      product.supplierName || '',
      product.searchText || ''
    ].join(' ').toLowerCase();
    
    // ëª¨ë“  ê²€ìƒ‰ì–´ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    return searchTerms.every(term => searchableText.includes(term));
  });
  
  // ê²€ìƒ‰ ê²°ê³¼ ì •ë ¬ (ì •í™•ë„ ìˆœ)
  const sortedResults = sortSearchResults(localResults, query);
  
  // ë¡œì»¬ ê²°ê³¼ê°€ ì¶©ë¶„í•˜ë©´ ì„œë²„ ê²€ìƒ‰ ë²„íŠ¼ë§Œ í‘œì‹œ
  if (sortedResults.length >= 20) {
    displaySearchResults(sortedResults);
    return;
  }
  
  // ê²°ê³¼ í‘œì‹œ
  displaySearchResults(sortedResults);
  
  // ë¡œì»¬ ê²°ê³¼ê°€ ì ìœ¼ë©´ ì„œë²„ ê²€ìƒ‰ ë²„íŠ¼ ì¶”ê°€
  if (sortedResults.length < 10) {
    const existingBtn = container.querySelector('.search-more-container');
    if (!existingBtn) {
      const searchMoreBtn = document.createElement('div');
      searchMoreBtn.className = 'search-more-container';
      searchMoreBtn.innerHTML = `
        <button class="btn btn-secondary" onclick="searchAllProducts('${query}')">
          ì „ì²´ ìƒí’ˆì—ì„œ ê²€ìƒ‰ (${sortedResults.length}ê°œ ì™¸ ì¶”ê°€ ê²€ìƒ‰)
        </button>
      `;
      container.appendChild(searchMoreBtn);
    }
  }
}

function searchAllProducts(query) {
  AppState.isSearching = true;
  const container = document.getElementById('search-results');
  
  const searchMoreContainer = container.querySelector('.search-more-container');
  if (searchMoreContainer) {
    searchMoreContainer.innerHTML = `
      <div class="search-loading">
        <div class="loading-spinner-small"></div>
        <p>ì „ì²´ ìƒí’ˆì—ì„œ ê²€ìƒ‰ ì¤‘...</p>
      </div>
    `;
  }
  
  google.script.run
    .withSuccessHandler(function(results) {
      AppState.isSearching = false;
      
      if (results.length > 0) {
        const existingBarcodes = new Set(AppState.products.map(p => p.barcode));
        const newProducts = [];
        
        results.forEach(r => {
          if (!existingBarcodes.has(r.barcode)) {
            AppState.products.push(r);
            newProducts.push(r);
          }
        });
        
        // ê²€ìƒ‰ì–´ë¥¼ ë‹¨ì–´ ë‹¨ìœ„ë¡œ ë¶„ë¦¬
        const searchTerms = query.toLowerCase().trim().split(/\s+/);
        
        // ëª¨ë“  ìƒí’ˆì—ì„œ ê²€ìƒ‰ (ê¸°ì¡´ + ìƒˆë¡œ ì¶”ê°€ëœ ìƒí’ˆ)
        const allResults = AppState.products.filter(p => {
          const searchableText = [
            p.barcode || '',
            p.name || '',
            p.option || '',
            p.supplierName || '',
            p.searchText || ''
          ].join(' ').toLowerCase();
          
          // ëª¨ë“  ê²€ìƒ‰ì–´ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          return searchTerms.every(term => searchableText.includes(term));
        });
        
        // ê²€ìƒ‰ ê²°ê³¼ ì •ë ¬ (ì „ì²´ ì¼ì¹˜ ìš°ì„ )
        const sortedResults = sortSearchResults(allResults, query);
        
        displaySearchResults(sortedResults);
        
        if (newProducts.length > 0) {
          showQuickSuccess(`${newProducts.length}ê°œì˜ ì¶”ê°€ ê²°ê³¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
        }
      } else {
        // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ë•Œ ë” ìì„¸í•œ ì •ë³´ ì œê³µ
        container.innerHTML = `
          <div class="empty-state">
            <p>ì¶”ê°€ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <div style="margin-top: 10px; font-size: 14px; color: #666;">
              <p>ê²€ìƒ‰ íŒ:</p>
              <ul style="text-align: left; display: inline-block;">
                <li>ë„ì–´ì“°ê¸°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</li>
                <li>ì¼ë¶€ ë‹¨ì–´ë§Œ ì…ë ¥í•´ë³´ì„¸ìš” (ì˜ˆ: "nap" ë˜ëŠ” "jogger")</li>
                <li>ì •í™•í•œ ìƒí’ˆëª…ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”</li>
              </ul>
            </div>
          </div>
        `;
      }
    })
    .withFailureHandler(function(error) {
      AppState.isSearching = false;
      container.innerHTML = '<div class="empty-state">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      showError('ì „ì²´ ê²€ìƒ‰ ì‹¤íŒ¨: ' + error);
    })
    .searchAllProducts(query);
}

// ê²€ìƒ‰ ê²°ê³¼ ì •ë ¬ í•¨ìˆ˜ - ì •í™•ë„ ìˆœìœ¼ë¡œ ì •ë ¬
function sortSearchResults(results, query) {
  const queryLower = query.toLowerCase().trim();
  
  return results.sort((a, b) => {
    const nameA = (a.name || '').toLowerCase();
    const nameB = (b.name || '').toLowerCase();
    
    // 1. ìƒí’ˆëª…ì´ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° ìµœìš°ì„ 
    if (nameA === queryLower && nameB !== queryLower) return -1;
    if (nameB === queryLower && nameA !== queryLower) return 1;
    
    // 2. ìƒí’ˆëª…ì´ ê²€ìƒ‰ì–´ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°
    const startsWithA = nameA.startsWith(queryLower);
    const startsWithB = nameB.startsWith(queryLower);
    if (startsWithA && !startsWithB) return -1;
    if (startsWithB && !startsWithA) return 1;
    
    // 3. ìƒí’ˆëª…ì— ê²€ìƒ‰ì–´ê°€ í¬í•¨ëœ ê²½ìš° (ìœ„ì¹˜ê°€ ì•ì¼ìˆ˜ë¡ ìš°ì„ )
    const indexA = nameA.indexOf(queryLower);
    const indexB = nameB.indexOf(queryLower);
    if (indexA !== -1 && indexB !== -1 && indexA !== indexB) {
      return indexA - indexB;
    }
    
    // 4. ìì£¼ ë°œì£¼ ìƒí’ˆ ìš°ì„ 
    if (a.isFrequent && !b.isFrequent) return -1;
    if (b.isFrequent && !a.isFrequent) return 1;
    
    // 5. ìµœê·¼ ìƒí’ˆ ìš°ì„ 
    if (a.isRecent && !b.isRecent) return -1;
    if (b.isRecent && !a.isRecent) return 1;
    
    // 6. ìƒí’ˆëª… ì•ŒíŒŒë²³ ìˆœ
    return nameA.localeCompare(nameB);
  });
}

function displaySearchResults(results) {
  const container = document.getElementById('search-results');
  const displaySettings = loadDisplaySettings();
  const query = document.getElementById('search-input').value.trim().toLowerCase();
  
  if (results.length === 0) {
    container.innerHTML = '<div class="empty-state">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  // AppStateì—ì„œ Smaregi ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì„œë²„ í˜¸ì¶œ ì œê±°)
  const smaregiData = AppState.smaregiData || {};
  
  let html = `
    <div class="search-results-header">
      <span>${results.length}ê°œì˜ ê²€ìƒ‰ ê²°ê³¼</span>
      <button class="close-search-results" onclick="closeSearchResults()">âœ•</button>
    </div>
  `;
  
  html += results.map(product => {
    let badges = '';
    if (product.isFrequent === true) badges += '<span class="product-badge badge-frequent">ìì£¼ë°œì£¼</span>';
    if (product.isRecent === true) badges += '<span class="product-badge badge-recent">ìµœê·¼</span>';
    
    const category = getCategory(product.name);
    const categoryBadge = category ? `<span class="product-badge badge-category">${category}</span>` : '';
    
    const colorSizeInfo = parseColorSize(product.option);
    let issueIcon = '';
    const issueData = AppState.productIssues[product.barcode];
    
    if (issueData) {
      const memo = issueData.memo || '';
      let iconType = 'â„¹ï¸';
      if (memo.includes('í’ˆì ˆ')) iconType = 'ğŸš«';
      else if (memo.includes('ì˜¤ë”ì¤‘')) iconType = 'âš ï¸';
      
      issueIcon = `
        <span class="issue-icon" title="${memo}">
          ${iconType}
          <span class="issue-tooltip">${memo}</span>
        </span>
      `;
    }
    
    const storeStock = smaregiData[product.barcode] || 0;
    const hasSmaregiData = product.barcode in smaregiData;
    
    let stockDisplay = '';
    if (Object.keys(smaregiData).length > 0) {
      if (hasSmaregiData) {
        stockDisplay = `<span class="inline-stock-badge">ğŸª ë§¤ì¥: ${storeStock}ê°œ</span>`;
      } else {
        stockDisplay = `<span class="inline-stock-badge no-data">ğŸª ë§¤ì¥: ì¬ê³  ì—†ìŒ</span>`;
      }
    }
    
    // ì´ë¯¸ ë°œì£¼ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
    const existingItems = AppState.orderItems.filter(item => item.barcode === product.barcode);
    const confirmedItem = existingItems.find(item => item.status === 'í™•ì •');
    const unconfirmedItem = existingItems.find(item => item.status !== 'í™•ì •');
    
    let buttonHtml = '';
    let totalQuantity = 0;

    if (confirmedItem && unconfirmedItem) {
      // í™•ì •ê³¼ ë¯¸í™•ì • ë‘˜ ë‹¤ ìˆëŠ” ê²½ìš°
      totalQuantity = confirmedItem.quantity + unconfirmedItem.quantity;
      buttonHtml = `
        <div class="search-item-button-group">
          <button class="add-to-order-btn already-added has-both" onclick="addToOrderWithData('${product.barcode}', this)">
            <span class="btn-main-text">ì¶”ê°€ (${totalQuantity})</span>
            <span class="btn-sub-text">í™•ì • ${confirmedItem.quantity} + ëŒ€ê¸° ${unconfirmedItem.quantity}</span>
          </button>
        </div>
      `;
    } else if (confirmedItem) {
      // í™•ì •ë§Œ ìˆëŠ” ê²½ìš°
      buttonHtml = `
        <div class="search-item-button-group">
          <button class="add-to-order-btn confirmed-only" onclick="addDuplicateConfirmed('${product.barcode}', this)">
            <span class="btn-main-text">ì¬ì¶”ê°€</span>
            <span class="btn-sub-text">í™•ì • ${confirmedItem.quantity}ê°œ</span>
          </button>
        </div>
      `;
    } else if (unconfirmedItem) {
      // ë¯¸í™•ì •ë§Œ ìˆëŠ” ê²½ìš°
      totalQuantity = unconfirmedItem.quantity;
      buttonHtml = `
        <button class="add-to-order-btn already-added" onclick="addToOrderWithData('${product.barcode}', this)">
          ì¶”ê°€ (${totalQuantity})
        </button>
      `;
    } else {
      // ë°œì£¼ ëª©ë¡ì— ì—†ëŠ” ê²½ìš°
      buttonHtml = `
        <button class="add-to-order-btn" onclick="addToOrderWithData('${product.barcode}', this)">
          ì¶”ê°€
        </button>
      `;
    }
    
    let colorSizeHtml = '';
    if (product.option && colorSizeInfo.color) {
      colorSizeHtml = `
        <div class="search-product-options">
          ${displaySettings.colorChipEnabled !== false && colorSizeInfo.colorHex ? 
            `<span class="color-chip-container">
              <span class="color-chip" style="background-color: ${colorSizeInfo.colorHex}"></span>
              <span class="color-name">${colorSizeInfo.color}</span>
            </span>` : 
            `<span class="color-text">${colorSizeInfo.color}</span>`
          }
          ${colorSizeInfo.size ? `<span class="size-text">${colorSizeInfo.size}</span>` : ''}
        </div>
      `;
    }
    
    const productDataJson = JSON.stringify({
      barcode: product.barcode,
      name: product.name,
      option: product.option || '',
      supplierName: product.supplierName || '',
      purchasePrice: product.purchasePrice || 0,
      weight: product.weight || '',
      memo: product.memo || '',
      remarks: product.remarks || '',
      storeStock: storeStock
    }).replace(/"/g, '&quot;');
    
    return `
      <div class="search-item ${displaySettings.compactMode ? 'compact' : ''}" 
           data-category="${category}"
           data-product="${productDataJson}">
        <div class="search-product-info">
          <div class="search-product-main">
            <span class="search-product-name">${product.name}</span>
            ${stockDisplay}
            ${categoryBadge}
            ${badges}
            ${issueIcon}
          </div>
          ${colorSizeHtml}
        </div>
        
        <div class="search-product-price">
          ${product.purchasePrice > 0 ? 'â‚©' + formatNumber(product.purchasePrice) : '-'}
        </div>
        
        ${buttonHtml}
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
  filterSearchResults();
}

// ê²€ìƒ‰ ê²°ê³¼ ì¬ê³  ì •ë³´ ë¡œë“œ
function loadSearchResultsStock(results) {
  console.log('ì¬ê³  ì •ë³´ ë¡œë“œ ì‹œì‘, Smaregi ì—°ê²°:', AppState.smaregiConnected);
  
  // Smaregi ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
  if (!AppState.smaregiDataLoaded || !AppState.smaregiData) {
    console.log('Smaregi ë°ì´í„° ì—†ìŒ');
    // ì¬ê³  ë°°ì§€ë¥¼ ê¸°ë³¸ ìƒíƒœë¡œ ë³€ê²½
    document.querySelectorAll('.stock-badge.loading').forEach(badge => {
      badge.classList.remove('loading');
      badge.classList.add('no-data');
      badge.querySelector('.stock-text').textContent = 'ì¬ê³  ì—†ìŒ';
    });
    return;
  }
  
  // ë¡œì»¬ ë°ì´í„°ì—ì„œ ì¬ê³  ì •ë³´ ì—…ë°ì´íŠ¸
  results.forEach(product => {
    const stockQuantity = AppState.smaregiData[product.barcode] || 0;
    updateStockBadge(product.barcode, {
      stock: stockQuantity,
      availableStock: stockQuantity
    });
  });
  
  // íŒë§¤ ì •ë³´ í•¸ë“¤ëŸ¬ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
  initializeSalesInfoHandlers();
}


// ê°œë³„ ì¬ê³  ë°°ì§€ ì—…ë°ì´íŠ¸
function updateStockBadge(barcode, stockInfo) {
  const badge = document.querySelector(`.stock-badge[data-barcode="${barcode}"]`);
  if (!badge) return;
  
  badge.classList.remove('loading');
  
  const stock = stockInfo.availableStock || stockInfo.stock || 0;
  const stockText = badge.querySelector('.stock-text');
  
  if (stock === 0) {
    badge.classList.add('out-of-stock');
    stockText.textContent = 'í’ˆì ˆ';
  } else if (stock < 10) {
    badge.classList.add('low-stock');
    stockText.textContent = `${stock}ê°œ`;
  } else {
    badge.classList.add('in-stock');
    stockText.textContent = `${stock}ê°œ`;
  }
  
  // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ íˆ´íŒ
  if (stockInfo.lastUpdate) {
    const updateTime = new Date(stockInfo.lastUpdate);
    const timeStr = updateTime.toLocaleString('ko-KR', {
      month: 'numeric',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    badge.title = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timeStr}`;
  }
}

// íŒë§¤ ì •ë³´ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
function initializeSalesInfoHandlers() {
  document.querySelectorAll('.sales-icon').forEach(icon => {
    icon.style.display = 'inline-flex';
    
    // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ íŒë§¤ ì •ë³´ ë¡œë“œ
    icon.addEventListener('mouseenter', function() {
      if (!this.dataset.loaded) {
        loadSalesInfo(this.dataset.barcode, this);
      }
    });
  });
}

// ê°œë³„ íŒë§¤ ì •ë³´ ë¡œë“œ
function loadSalesInfo(barcode, iconElement) {
  iconElement.title = 'íŒë§¤ ì •ë³´ ë¡œë”©ì¤‘...';
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success && response.salesInfo) {
        const info = response.salesInfo;
        const settings = AppState.settings || {};
        
        iconElement.dataset.loaded = 'true';
        iconElement.title = `ìµœê·¼ ${info.shortPeriod}ì¼: ${info.lastShortDays}ê°œ\nìµœê·¼ ${info.longPeriod}ì¼: ${info.lastLongDays}ê°œ\nì¼í‰ê· : ${info.dailyAverage}ê°œ`;
        
        // ì„¤ì •ëœ ì„ê³„ê°’ ê°€ì ¸ì˜¤ê¸°
        const hotThreshold = parseInt(settings.salesThresholdHot) || 20;
        const popularThreshold = parseInt(settings.salesThresholdPopular) || 10;
        const normalThreshold = parseInt(settings.salesThresholdNormal) || 5;
        
        // íŒë§¤ëŸ‰ì— ë”°ë¥¸ ì•„ì´ì½˜ ìƒ‰ìƒ (ë‹¨ê¸° ê¸°ê°„ ê¸°ì¤€)
        if (info.lastShortDays >= hotThreshold) {
          iconElement.style.color = '#f44336'; // ë¹¨ê°• (í•«)
          iconElement.textContent = 'ğŸ”¥';
        } else if (info.lastShortDays >= popularThreshold) {
          iconElement.style.color = '#ff9800'; // ì£¼í™© (ì¸ê¸°)
          iconElement.textContent = 'â­';
        } else if (info.lastShortDays >= normalThreshold) {
          iconElement.style.color = '#4caf50'; // ì´ˆë¡ (ë³´í†µ)
          iconElement.textContent = 'âœ“';
        } else {
          iconElement.style.color = '#9e9e9e'; // íšŒìƒ‰ (ì €ì¡°)
          iconElement.textContent = 'ğŸ“Š';
        }
      } else {
        iconElement.title = 'íŒë§¤ ì •ë³´ ì—†ìŒ';
        iconElement.style.color = '#9e9e9e';
      }
    })
    .withFailureHandler(function(error) {
      iconElement.title = 'íŒë§¤ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨';
      iconElement.style.color = '#9e9e9e';
    })
    .getProductSalesData(barcode);
}

// ê°œë³„ ì¬ê³  ë°°ì§€ ì—…ë°ì´íŠ¸
function updateStockBadge(barcode, stockInfo) {
  const badge = document.querySelector(`.stock-badge[data-barcode="${barcode}"]`);
  if (!badge) return;
  
  badge.classList.remove('loading');
  
  const stock = stockInfo.availableStock || stockInfo.stock || 0;
  const stockText = badge.querySelector('.stock-text');
  
  if (stock === 0) {
    badge.classList.add('out-of-stock');
    stockText.textContent = 'í’ˆì ˆ';
  } else if (stock < 10) {
    badge.classList.add('low-stock');
    stockText.textContent = `${stock}ê°œ`;
  } else {
    badge.classList.add('in-stock');
    stockText.textContent = `${stock}ê°œ`;
  }
  
  // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ íˆ´íŒ
  if (stockInfo.lastUpdate) {
    const updateTime = new Date(stockInfo.lastUpdate);
    const timeStr = updateTime.toLocaleString('ko-KR', {
      month: 'numeric',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    badge.title = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timeStr}`;
  }
}

// íŒë§¤ ì •ë³´ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
function initializeSalesInfoHandlers() {
  document.querySelectorAll('.sales-icon').forEach(icon => {
    icon.style.display = 'inline-flex';
    
    // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ íŒë§¤ ì •ë³´ ë¡œë“œ
    icon.addEventListener('mouseenter', function() {
      if (!this.dataset.loaded) {
        loadSalesInfo(this.dataset.barcode, this);
      }
    });
  });
}

// ê°œë³„ íŒë§¤ ì •ë³´ ë¡œë“œ
function loadSalesInfo(barcode, iconElement) {
  iconElement.title = 'íŒë§¤ ì •ë³´ ë¡œë”©ì¤‘...';
  
  google.script.run
    .withSuccessHandler(function(response) {
      if (response.success && response.salesInfo) {
        const info = response.salesInfo;
        iconElement.dataset.loaded = 'true';
        iconElement.title = `ìµœê·¼ 7ì¼: ${info.last7Days}ê°œ\nìµœê·¼ 30ì¼: ${info.last30Days}ê°œ\nì¼í‰ê· : ${info.dailyAverage}ê°œ`;
        
        // íŒë§¤ëŸ‰ì— ë”°ë¥¸ ì•„ì´ì½˜ ìƒ‰ìƒ
        if (info.last7Days > 20) {
          iconElement.style.color = '#f44336'; // ë¹¨ê°• (í•«)
        } else if (info.last7Days > 10) {
          iconElement.style.color = '#ff9800'; // ì£¼í™© (ì¸ê¸°)
        } else if (info.last7Days > 5) {
          iconElement.style.color = '#4caf50'; // ì´ˆë¡ (ë³´í†µ)
        } else {
          iconElement.style.color = '#9e9e9e'; // íšŒìƒ‰ (ì €ì¡°)
        }
      } else {
        iconElement.title = 'íŒë§¤ ì •ë³´ ì—†ìŒ';
        iconElement.style.color = '#9e9e9e';
      }
    })
    .withFailureHandler(function(error) {
      iconElement.title = 'íŒë§¤ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨';
      iconElement.style.color = '#9e9e9e';
    })
    .getProductSalesData(barcode);
}

// í™•ì •ëœ í•­ëª© ì¬ì¶”ê°€ í•¨ìˆ˜ (displaySearchResults í•¨ìˆ˜ ë°”ë¡œ ë‹¤ìŒì— ì¶”ê°€)
function addDuplicateConfirmed(barcode, button) {
  console.log('addDuplicateConfirmed í˜¸ì¶œë¨:', barcode); // ë””ë²„ê¹…ìš©
  
  if (confirm('ì´ë¯¸ í™•ì •ëœ í•­ëª©ì…ë‹ˆë‹¤.\nì¶”ê°€ë¡œ ë°œì£¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    // ìƒˆë¡œìš´ ë¯¸í™•ì • í•­ëª©ìœ¼ë¡œ ì¶”ê°€
    addToOrderWithData(barcode, button);
  }
}

// ë°œì£¼ ëª©ë¡ì˜ íŠ¹ì • ì•„ì´í…œìœ¼ë¡œ ìŠ¤í¬ë¡¤ ë° í•˜ì´ë¼ì´íŠ¸
function focusOrderItem(barcode) {
  const orderItems = document.querySelectorAll('.order-item');
  
  orderItems.forEach(item => {
    const itemBarcode = item.querySelector('.item-barcode')?.textContent;
    if (itemBarcode === barcode) {
      // ìŠ¤í¬ë¡¤
      item.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
      item.classList.add('highlight');
      setTimeout(() => {
        item.classList.remove('highlight');
      }, 2000);
    }
  });
}

function closeSearchResults() {
  document.getElementById('search-results').innerHTML = '';
}

// ===== 15. ë°œì£¼ ëª©ë¡ ê´€ë¦¬ =====
function addToOrderWithData(barcode, button) {
  console.log('addToOrderWithData í˜¸ì¶œë¨:', barcode); // ë””ë²„ê¹…ìš©
  
  if (!AppState.currentOrderInfo) {
    showError('ë¨¼ì € ë°œì£¼ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const searchItem = button.closest('.search-item');
  if (!searchItem) {
    console.error('search-itemì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    addToOrder(barcode);
    return;
  }
  
  const productData = searchItem.dataset.product;
  if (!productData) {
    console.error('product ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
    addToOrder(barcode);
    return;
  }
  
  try {
    const product = JSON.parse(productData);
    console.log('íŒŒì‹±ëœ product:', product); // ë””ë²„ê¹…ìš©
    proceedAddToOrder(product, button);
  } catch (error) {
    console.error('JSON íŒŒì‹± ì—ëŸ¬:', error);
    addToOrder(barcode);
  }
}

function addToOrder(barcode) {
  if (!AppState.currentOrderInfo) {
    showError('ë¨¼ì € ë°œì£¼ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  let product = AppState.products.find(p => p.barcode === barcode);
  
  if (!product) {
    product = cache.get('product', barcode);
  }
  
  if (!product) {
    const addBtn = event.target;
    const originalText = addBtn.textContent;
    addBtn.textContent = 'ì¡°íšŒì¤‘...';
    addBtn.disabled = true;
    
    google.script.run
      .withSuccessHandler(function(details) {
        if (details) {
          product = {
            ...details,
            searchText: `${details.barcode} ${details.name} ${details.option}`.toLowerCase()
          };
          
          cache.set('product', barcode, product);
          AppState.products.push(product);
          proceedAddToOrder(product, addBtn);
        }
      })
      .withFailureHandler(function(error) {
        addBtn.textContent = originalText;
        addBtn.disabled = false;
        showError('ìƒí’ˆ ì¡°íšŒ ì‹¤íŒ¨');
      })
      .getProductDetails(barcode);
    
    return;
  }
  
  proceedAddToOrder(product, event.target);
}

function proceedAddToOrder(product, addBtn) {
  // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
  addBtn.classList.add('adding');
  addBtn.textContent = 'ì¶”ê°€ì¤‘...';
  addBtn.disabled = true;
  addBtn.style.cursor = 'wait';
  
  const existingUnconfirmed = AppState.orderItems.find(item => 
    item.barcode === product.barcode && item.status !== 'í™•ì •'
  );
  
  if (existingUnconfirmed) {
    existingUnconfirmed.quantity += 1;
    updateOrderList();
    
    const totalQuantity = AppState.orderItems
      .filter(item => item.barcode === product.barcode)
      .reduce((sum, item) => sum + item.quantity, 0);
    
    // ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜
    addBtn.classList.remove('adding');
    addBtn.classList.add('added-success', 'ripple');
    addBtn.textContent = 'ì¶”ê°€ë¨';
    
    setTimeout(() => {
      addBtn.classList.remove('added-success', 'ripple');
      addBtn.classList.add('already-added');
      addBtn.textContent = `ì¶”ê°€ (${totalQuantity})`;
      addBtn.disabled = false;
      addBtn.style.cursor = 'pointer';
    }, 1000);
    
    showQuickSuccess('ìˆ˜ëŸ‰ì´ ì¦ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    scheduleAutoSave();
    return;
  }
  
  const newItem = {
    ...product,
    quantity: 1,
    priority: 3,
    comment: '',
    status: 'ëŒ€ê¸°',
    id: Date.now() + Math.random(),
    confirmedAt: null,
    stockAvailable: 'ë¯¸í™•ì¸'
  };
  
  AppState.orderItems.push(newItem);
  updateOrderList();
  
  // ìµœê·¼ ì‚¬ìš© ì—…ë°ì´íŠ¸
  google.script.run.updateSharedRecentProducts(product);
  
  // ë¡œì»¬ ìºì‹œ ì €ì¥
  try {
    let localCache = localStorage.getItem('recentAddedProducts');
    localCache = localCache ? JSON.parse(localCache) : [];
    localCache = localCache.filter(p => p.barcode !== product.barcode);
    localCache.unshift({ ...product, isFromCache: true, cachedAt: new Date().toISOString() });
    localCache = localCache.slice(0, 100);
    localStorage.setItem('recentAddedProducts', JSON.stringify(localCache));
  } catch (e) {
    console.warn('ë¡œì»¬ ìºì‹œ ì €ì¥ ì‹¤íŒ¨:', e);
  }
  
  // ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜
  addBtn.classList.remove('adding');
  addBtn.classList.add('added-success', 'ripple');
  addBtn.textContent = 'ì¶”ê°€ë¨';
  
  setTimeout(() => {
    addBtn.classList.remove('added-success', 'ripple');
    addBtn.classList.add('already-added');
    addBtn.textContent = 'ì¶”ê°€ (1)';
    addBtn.disabled = false;
    addBtn.style.cursor = 'pointer';
  }, 1000);
  
  showQuickSuccess('ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
  scheduleAutoSave();
}

function updateOrderList() {
  const container = document.getElementById('order-list');
  const displaySettings = loadDisplaySettings();
  
  if (!AppState.currentOrderInfo) {
    container.innerHTML = '<div class="empty-state"><p>ë°œì£¼ì„œë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.</p></div>';
    updateOrderSummary();
    return;
  }
  
  if (AppState.orderItems.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>ë°œì£¼í•  ìƒí’ˆì„ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p></div>';
    updateOrderSummary();
    return;
  }
  
  const smaregiData = AppState.smaregiData || {};
  const hasSmaregiData = Object.keys(smaregiData).length > 0;
  
  // ë°”ì½”ë“œë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì¤‘ë³µ í‘œì‹œ
  const barcodeGroups = {};
  AppState.orderItems.forEach(item => {
    if (!barcodeGroups[item.barcode]) {
      barcodeGroups[item.barcode] = [];
    }
    barcodeGroups[item.barcode].push(item);
  });
  
  container.innerHTML = AppState.orderItems.map(item => {
    const isConfirmed = item.status === 'í™•ì •';
    const isExported = !!(item.exportedAt || (item.exportStatus && item.exportStatus.includes('ë‚´ë³´ë‚´ê¸° ì™„ë£Œ')));
    if (isExported) {
      console.log(`ë‚´ë³´ë‚´ê¸°ëœ í•­ëª©: ${item.barcode}, exportedAt: ${item.exportedAt}, exportStatus: ${item.exportStatus}`);
    }
    const amount = item.quantity * (item.purchasePrice || 0);
    const priorityDisplay = getPriorityDisplay(item.priority || 3);
    
    const stockStatus = getStockStatusDisplay(item.stockAvailable || 'ë¯¸í™•ì¸');
    const storeStock = smaregiData[item.barcode] || 0;
    const hasSmaregiDataForItem = item.barcode in smaregiData;
    
    let storeStockBadge = '';
    if (hasSmaregiData) {
      if (hasSmaregiDataForItem) {
        let stockClass = 'store-stock-normal';
        if (storeStock === 0) stockClass = 'store-stock-empty';
        else if (storeStock < 10) stockClass = 'store-stock-low';
        
        storeStockBadge = `
          <span class="store-stock-badge ${stockClass}">
            <span class="store-icon">ğŸª</span>
            <span class="store-count">${storeStock}ê°œ</span>
          </span>
        `;
      } else {
        storeStockBadge = `
          <span class="store-stock-badge store-stock-no-data">
            <span class="store-icon">ğŸª</span>
            <span class="store-count">-</span>
          </span>
        `;
      }
    }
    
    // â˜…â˜…â˜… ë°•ìŠ¤ ì •ë³´ ì²˜ë¦¬ - í˜•ì‹ ê°œì„  â˜…â˜…â˜…
    let boxInfoHtml = '';
    if (item.boxNumbers) {
      // "1(5), 2(3)" í˜•ì‹ì„ "1ë²ˆ(5ê°œ), 2ë²ˆ(3ê°œ)"ë¡œ ë³€í™˜
      const formattedBoxInfo = item.boxNumbers.replace(/(\d+)\((\d+)\)/g, '$1ë²ˆ($2ê°œ)');
      boxInfoHtml = `
        <span class="box-info">
          <span class="box-icon">ğŸ“¦</span>
          <span class="box-numbers">${formattedBoxInfo}</span>
        </span>
      `;
    }
    
    const colorSizeInfo = parseColorSize(item.option);
    let colorSizeHtml = '';
    if (item.option && colorSizeInfo.color) {
      colorSizeHtml = `
        <div class="order-product-options">
          ${displaySettings.colorChipEnabled !== false && colorSizeInfo.colorHex ? 
            `<span class="color-chip-container">
              <span class="color-chip" style="background-color: ${colorSizeInfo.colorHex}"></span>
              <span class="color-name">${colorSizeInfo.color}</span>
            </span>` : 
            `<span class="color-text">${colorSizeInfo.color}</span>`
          }
          ${colorSizeInfo.size ? `<span class="size-text">${colorSizeInfo.size}</span>` : ''}
          ${boxInfoHtml}
        </div>
      `;
    } else if (boxInfoHtml) {
      // ì˜µì…˜ì´ ì—†ëŠ” ê²½ìš°ì—ë„ ë°•ìŠ¤ ì •ë³´ê°€ ìˆìœ¼ë©´ í‘œì‹œ
      colorSizeHtml = `
        <div class="order-product-options">
          ${boxInfoHtml}
        </div>
      `;
    }
    
    // ê°™ì€ ë°”ì½”ë“œì˜ ë‹¤ë¥¸ í•­ëª© í™•ì¸
    const sameProducts = barcodeGroups[item.barcode];
    const isDuplicate = sameProducts.length > 1;
    const duplicateInfo = isDuplicate ? 
      `<span class="duplicate-badge" title="ë™ì¼ ìƒí’ˆ ${sameProducts.length}ê°œ">Ã—${sameProducts.length}</span>` : 
      '';
    
    return `
      <div class="order-item ${isConfirmed ? 'confirmed' : ''} ${isExported ? 'exported' : ''} ${isDuplicate ? 'has-duplicate' : ''} ${displaySettings.compactMode ? 'compact' : ''}" data-id="${item.id}">
        <div class="order-checkbox-wrapper">
          <input type="checkbox" class="order-checkbox" onchange="updateBulkEditButton()">
        </div>
        
        <div class="order-product-info">
          <div class="order-product-main">
            <span class="order-product-name">${item.name}</span>
            ${duplicateInfo}
            ${storeStockBadge}
            ${isConfirmed ? '<span class="confirmed-badge">í™•ì •</span>' : ''}
            ${isExported ? `<span class="exported-badge" title="ë‚´ë³´ë‚´ê¸°: ${item.exportedAt || 'ì™„ë£Œ'}">ë‚´ë³´ë‚´ê¸° ì™„ë£Œ</span>` : ''}
          </div>
          ${colorSizeHtml}
        </div>
        
        <div class="order-quantity-wrapper">
          <input type="number" 
                 class="quantity-input" 
                 value="${item.quantity}" 
                 min="1" 
                 onchange="updateQuantity('${item.id}', this.value)"
                 ${isConfirmed ? 'disabled' : ''}>
          <span class="quantity-unit">ê°œ</span>
          ${isExported && item.exportedQuantity && item.exportedQuantity !== item.quantity ? 
            `<span class="exported-quantity">(ë‚´ë³´ëƒ„: ${item.exportedQuantity}ê°œ)</span>` : 
            ''
          }
        </div>
        
        <div class="order-amount">â‚©${formatNumber(amount)}</div>

        <div class="stock-status-wrapper">
          <button class="stock-status-btn ${stockStatus.class}" 
                  onclick="showQuickStockMenu(event, '${item.id}')"
                  data-csv-status="${item.stockStatus || ''}">
            <span>${stockStatus.icon}</span>
            <span>${stockStatus.text}</span>
            ${item.stockStatus ? '<span class="csv-indicator">ğŸ“Š</span>' : ''}
          </button>
          <div class="quick-stock-menu" id="quick-menu-${item.id}">
            <div class="quick-stock-option" onclick="setQuickStock('${item.id}', 'ê°€ëŠ¥')">
              <span>âœ…</span> ê°€ëŠ¥
            </div>
            <div class="quick-stock-option" onclick="setQuickStock('${item.id}', 'í’ˆì ˆ')">
              <span>âŒ</span> í’ˆì ˆ
            </div>
            <div class="quick-stock-option" onclick="setQuickStock('${item.id}', 'ì˜¤ë”ì¤‘')">
              <span>â³</span> ì˜¤ë”ì¤‘
            </div>
            <div class="quick-stock-option custom" onclick="showStockStatusModal('${item.id}')">
              <span>âœï¸</span> ì§ì ‘ ì…ë ¥...
            </div>
          </div>
        </div>
        
        <div class="order-actions">
          <button class="order-action-btn priority ${priorityDisplay.class}" 
                  onclick="window.showPriorityPicker('${item.id}')"
                  data-item-id="${item.id}"
                  ${isConfirmed ? 'disabled' : ''}
                  title="ìš°ì„ ìˆœìœ„: ${priorityDisplay.text}">
            <span class="priority-badge">${priorityDisplay.icon}</span>
            <span class="priority-text">${priorityDisplay.text}</span>
          </button>
          <button class="order-action-btn comment ${item.comment ? 'has-comment' : ''}" 
                  onclick="window.showCommentInput('${item.id}')"
                  title="${item.comment ? 'ì½”ë©˜íŠ¸ ìˆ˜ì •' : 'ì½”ë©˜íŠ¸ ì¶”ê°€'}">
            ğŸ’¬
            ${item.comment ? '<span class="comment-indicator"></span>' : ''}
          </button>
          ${!isConfirmed ? 
            `<button class="order-action-btn delete" onclick="window.removeItem('${item.id}')" title="ì‚­ì œ">ì‚­ì œ</button>` :
            ''
          }
        </div>
      </div>
    `;
  }).join('');
  
  updateOrderSummary();
  updateBulkEditButton();
  updateExportButtonStatus();
}

// 3. sortOrderItems í•¨ìˆ˜ ìˆ˜ì •
function sortOrderItems(sortBy) {
  if (!AppState.orderItems || AppState.orderItems.length === 0) return;
  
  // ê°™ì€ í•„ë“œë¡œ ë‹¤ì‹œ ì •ë ¬í•˜ë©´ ìˆœì„œ ë°˜ëŒ€ë¡œ
  if (currentSortField === sortBy) {
    currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortField = sortBy;
    currentSortOrder = 'asc';
  }
  
  // ì •ë ¬ ì‹¤í–‰
  AppState.orderItems.sort((a, b) => {
    let compareValue = 0;
    
    switch (sortBy) {
      case 'status':
        // í™•ì • > ëŒ€ê¸° ìˆœ
        const statusOrder = { 'í™•ì •': 0, 'ëŒ€ê¸°': 1 };
        compareValue = (statusOrder[a.status] || 2) - (statusOrder[b.status] || 2);
        break;
        
      case 'priority':
        // ìš°ì„ ìˆœìœ„ ë†’ìŒ(1) > ë³´í†µ(2) > ë‚®ìŒ(3)
        compareValue = (a.priority || 3) - (b.priority || 3);
        break;
        
      case 'name':
        // ìƒí’ˆëª… ê°€ë‚˜ë‹¤ìˆœ
        compareValue = (a.name || '').localeCompare(b.name || '');
        break;
        
      case 'quantity':
        // ìˆ˜ëŸ‰ ë§ì€ ìˆœ
        compareValue = (b.quantity || 0) - (a.quantity || 0);
        break;
        
      case 'amount':
        // ê¸ˆì•¡ ë†’ì€ ìˆœ
        const amountA = (a.quantity || 0) * (a.purchasePrice || 0);
        const amountB = (b.quantity || 0) * (b.purchasePrice || 0);
        compareValue = amountB - amountA;
        break;
        
      case 'stock':
        // ì¬ê³  ìƒíƒœ ìˆœ (í’ˆì ˆ > ì˜¤ë”ì¤‘ > Xê°œë§Œ ê°€ëŠ¥ > ê°€ëŠ¥ > ë¯¸í™•ì¸)
        const stockOrder = {
          'í’ˆì ˆ': 0,
          'ì˜¤ë”ì¤‘': 1,
          'ë¯¸í™•ì¸': 4
        };
        
        const getStockOrder = (stock) => {
          if (stock in stockOrder) return stockOrder[stock];
          if (stock && stock.includes('ê°œë§Œ ê°€ëŠ¥')) return 2;
          if (stock === 'ê°€ëŠ¥') return 3;
          return 5;
        };
        
        compareValue = getStockOrder(a.stockAvailable) - getStockOrder(b.stockAvailable);
        break;
        
      case 'exported':
        // ë‚´ë³´ë‚´ê¸° ìƒíƒœ (ë‚´ë³´ë‚´ê¸° ì™„ë£Œ > ë¯¸ë‚´ë³´ë‚´ê¸°)
        const exportedA = a.exportedAt ? 0 : 1;
        const exportedB = b.exportedAt ? 0 : 1;
        compareValue = exportedA - exportedB;
        break;
        
      default:
        // ê¸°ë³¸: ì¶”ê°€ëœ ìˆœì„œ (ID ìˆœ)
        compareValue = (a.id || 0) - (b.id || 0);
    }
    
    // ì˜¤ë¦„ì°¨ìˆœ/ë‚´ë¦¼ì°¨ìˆœ ì ìš©
    return currentSortOrder === 'asc' ? compareValue : -compareValue;
  });
  
  // UI ì—…ë°ì´íŠ¸
  updateOrderList();
  
  // ëª¨ë‹¬ ë‹«ê¸°
  const modal = document.getElementById('modal');
  if (modal) modal.style.display = 'none';
  
  showQuickSuccess(`${getSortLabel(sortBy)}ìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// 4. ì •ë ¬ ë¼ë²¨ í—¬í¼ í•¨ìˆ˜ ì¶”ê°€
function getSortLabel(sortBy) {
  const labels = {
    'status': 'ìƒíƒœìˆœ',
    'priority': 'ìš°ì„ ìˆœìœ„',
    'name': 'ìƒí’ˆëª…',
    'quantity': 'ìˆ˜ëŸ‰ìˆœ',
    'amount': 'ê¸ˆì•¡ìˆœ',
    'stock': 'ì¬ê³ ìƒíƒœ',
    'exported': 'ë‚´ë³´ë‚´ê¸°ìƒíƒœ',
    'default': 'ê¸°ë³¸ìˆœì„œ'
  };
  return labels[sortBy] || sortBy;
}

// 5. showSortMenu í•¨ìˆ˜ ê°œì„ 
function showSortMenu() {
  const modalContent = `
    <h3>ë°œì£¼ ëª©ë¡ ì •ë ¬</h3>
    <div class="sort-options">
      <button class="sort-option ${currentSortField === 'status' ? 'active' : ''}" 
              onclick="sortOrderItems('status')">
        <span class="sort-icon">ğŸ“‹</span>
        <div>
          <div class="sort-title">ìƒíƒœìˆœ</div>
          <div class="sort-desc">í™•ì •ëœ í•­ëª©ì„ ìƒë‹¨ì— í‘œì‹œ</div>
        </div>
      </button>
      
      <button class="sort-option ${currentSortField === 'priority' ? 'active' : ''}" 
              onclick="sortOrderItems('priority')">
        <span class="sort-icon">â­</span>
        <div>
          <div class="sort-title">ìš°ì„ ìˆœìœ„</div>
          <div class="sort-desc">ê¸´ê¸‰í•œ í•­ëª©ë¶€í„° í‘œì‹œ</div>
        </div>
      </button>
      
      <button class="sort-option ${currentSortField === 'stock' ? 'active' : ''}" 
              onclick="sortOrderItems('stock')">
        <span class="sort-icon">ğŸ“¦</span>
        <div>
          <div class="sort-title">ì¬ê³  ìƒíƒœ</div>
          <div class="sort-desc">í’ˆì ˆ/ì˜¤ë”ì¤‘ í•­ëª© ìš°ì„ </div>
        </div>
      </button>
      
      <button class="sort-option ${currentSortField === 'amount' ? 'active' : ''}" 
              onclick="sortOrderItems('amount')">
        <span class="sort-icon">ğŸ’°</span>
        <div>
          <div class="sort-title">ê¸ˆì•¡ìˆœ</div>
          <div class="sort-desc">ê¸ˆì•¡ì´ í° ìˆœì„œëŒ€ë¡œ</div>
        </div>
      </button>
      
      <button class="sort-option ${currentSortField === 'name' ? 'active' : ''}" 
              onclick="sortOrderItems('name')">
        <span class="sort-icon">ğŸ”¤</span>
        <div>
          <div class="sort-title">ìƒí’ˆëª…</div>
          <div class="sort-desc">ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬</div>
        </div>
      </button>
      
      <button class="sort-option ${currentSortField === 'exported' ? 'active' : ''}" 
              onclick="sortOrderItems('exported')">
        <span class="sort-icon">ğŸ“¤</span>
        <div>
          <div class="sort-title">ë‚´ë³´ë‚´ê¸° ìƒíƒœ</div>
          <div class="sort-desc">ë‚´ë³´ë‚¸ í•­ëª© êµ¬ë¶„</div>
        </div>
      </button>
    </div>
  `;
  
  showModal(modalContent);
}

function updateQuantity(id, value) {
  const item = AppState.orderItems.find(i => i.id == id);
  if (item) {
    item.quantity = Math.max(1, parseInt(value) || 1);
    updateOrderSummary();
    scheduleAutoSave();
  }
}

function removeItem(id) {
  if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    AppState.orderItems = AppState.orderItems.filter(i => i.id != id);
    updateOrderList();
    scheduleAutoSave();
  }
}

function updateOrderSummary() {
  const totalItems = AppState.orderItems.length;
  const totalQuantity = AppState.orderItems.reduce((sum, item) => sum + item.quantity, 0);
  const totalAmount = AppState.orderItems.reduce((sum, item) => sum + (item.quantity * item.purchasePrice), 0);
  const pendingItems = AppState.orderItems.filter(item => item.status !== 'í™•ì •').length;
  
  document.getElementById('total-items').textContent = totalItems;
  document.getElementById('total-quantity').textContent = totalQuantity;
  document.getElementById('total-amount').textContent = 'â‚©' + formatNumber(totalAmount);
  document.getElementById('pending-items').textContent = pendingItems;
}

// ===== 16. ì¬ê³  ìƒíƒœ ê´€ë¦¬ =====
function showQuickStockMenu(event, itemId) {
  event.stopPropagation();
  
  const item = AppState.orderItems.find(i => i.id == itemId);
  if (!item) return;
  
  // ë‚´ë³´ë‚´ê¸°ëœ í•­ëª©ì€ ì¬ê³  ìƒíƒœ ë³€ê²½ ë¶ˆê°€
  if (item.exportedAt || item.exportStatus) {
    showError('ë‚´ë³´ë‚´ê¸°ëœ í•­ëª©ì€ ì¬ê³  ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ê¸°ì¡´ ì½”ë“œ ê³„ì†...
  document.querySelectorAll('.quick-stock-menu').forEach(menu => {
    if (menu.id !== `quick-menu-${itemId}`) {
      menu.classList.remove('show');
    }
  });
  
  const menu = document.getElementById(`quick-menu-${itemId}`);
  menu.classList.toggle('show');
  
  if (menu.classList.contains('show')) {
    setTimeout(() => {
      document.addEventListener('click', function closeMenu(e) {
        if (!menu.contains(e.target) && !e.target.closest('.stock-status-btn')) {
          menu.classList.remove('show');
          document.removeEventListener('click', closeMenu);
        }
      });
    }, 10);
  }
}

function setQuickStock(itemId, status) {
  const item = AppState.orderItems.find(i => i.id == itemId);
  if (!item) return;
  
  item.stockAvailable = status;
  
  // Quick ë©”ë‰´ ë‹«ê¸°
  document.querySelectorAll('.quick-stock-menu').forEach(menu => {
    menu.classList.remove('show');
  });
  
  // í•´ë‹¹ ì•„ì´í…œë§Œ UI ì—…ë°ì´íŠ¸
  updateOrderItem(itemId);
  
  // ìë™ ì €ì¥
  if (AppState.currentOrderInfo) {
    scheduleAutoSave();
  }
  
  showQuickSuccess('ì¬ê³  ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function showStockStatusModal(itemId) {
  const item = AppState.orderItems.find(i => i.id == itemId);
  if (!item) return;
  
  // Quick ë©”ë‰´ ë¨¼ì € ë‹«ê¸°
  document.querySelectorAll('.quick-stock-menu').forEach(menu => {
    menu.classList.remove('show');
  });
  
  AppState.currentStockEditItem = item;
  
  document.getElementById('stock-modal-product-info').innerHTML = `
    <strong>${item.name}</strong><br>
    <span class="text-muted">${item.barcode} | ìš”ì²­ìˆ˜ëŸ‰: ${item.quantity}ê°œ</span><br>
    <span class="stock-current-status">í˜„ì¬ ìƒíƒœ: ${item.stockAvailable || 'ë¯¸í™•ì¸'}</span>
  `;
  
  resetStockStatusModal();
  
  if (item.stockAvailable === 'ê°€ëŠ¥') {
    document.querySelector('input[value="available"]').checked = true;
  } else if (item.stockAvailable === 'í’ˆì ˆ') {
    document.querySelector('input[value="soldout"]').checked = true;
  } else if (item.stockAvailable === 'ì˜¤ë”ì¤‘') {
    document.querySelector('input[value="ordering"]').checked = true;
  } else if (item.stockAvailable && item.stockAvailable !== 'ë¯¸í™•ì¸') {
    document.querySelector('input[value="custom"]').checked = true;
    document.getElementById('custom-status').value = item.stockAvailable;
    document.getElementById('custom-status').disabled = false;
  }
  
  document.getElementById('stock-status-modal').style.display = 'block';
}

function updateOrderItem(itemId) {
  const item = AppState.orderItems.find(i => i.id == itemId);
  if (!item) return;
  
  const orderItemEl = document.querySelector(`[data-id="${itemId}"]`);
  if (!orderItemEl) return;
  
  // ì¬ê³  ìƒíƒœ ë²„íŠ¼ ì—…ë°ì´íŠ¸
  const stockBtn = orderItemEl.querySelector('.stock-status-btn');
  if (stockBtn) {
    const stockStatus = getStockStatusDisplay(item.stockAvailable || 'ë¯¸í™•ì¸');
    stockBtn.className = `stock-status-btn ${stockStatus.class}`;
    stockBtn.innerHTML = `
      <span>${stockStatus.icon}</span>
      <span>${stockStatus.text}</span>
      ${item.stockStatus ? '<span class="csv-indicator">ğŸ“Š</span>' : ''}
    `;
  }
  
  // ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
  const qtyInput = orderItemEl.querySelector('.quantity-input');
  if (qtyInput) {
    qtyInput.value = item.quantity;
  }
  
  // ê¸ˆì•¡ ì—…ë°ì´íŠ¸
  const amountEl = orderItemEl.querySelector('.order-amount');
  if (amountEl) {
    const amount = item.quantity * (item.purchasePrice || 0);
    amountEl.textContent = 'â‚©' + formatNumber(amount);
  }
  
  // ìš”ì•½ ì—…ë°ì´íŠ¸
  updateOrderSummary();
}

function resetStockStatusModal() {
  document.querySelectorAll('input[name="stockStatus"]').forEach(radio => {
    radio.checked = false;
  });
  document.getElementById('custom-status').value = '';
  document.getElementById('custom-status').disabled = true;
}

function saveStockStatus() {
  if (!AppState.currentStockEditItem) return;
  
  const selectedStatus = document.querySelector('input[name="stockStatus"]:checked');
  if (!selectedStatus) {
    showError('ì¬ê³  ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  let newStatus = '';
  switch(selectedStatus.value) {
    case 'available': newStatus = 'ê°€ëŠ¥'; break;
    case 'soldout': newStatus = 'í’ˆì ˆ'; break;
    case 'ordering': newStatus = 'ì˜¤ë”ì¤‘'; break;
    case 'custom':
      newStatus = document.getElementById('custom-status').value.trim();
      if (!newStatus) {
        showError('ìƒíƒœë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      break;
  }
  
  AppState.currentStockEditItem.stockAvailable = newStatus;
  updateOrderList();
  
  if (AppState.currentOrderInfo) {
    scheduleAutoSave();
  }
  
  AppState.currentStockEditItem = null;
  closeModal('stock-status-modal');
  showQuickSuccess('ì¬ê³  ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function getStockStatusDisplay(status, stockData) {
  const statusStr = status ? String(status).trim() : 'ë¯¸í™•ì¸';
  const isCSVConfirmed = stockData && stockData.stockStatus;
  
  const statusMap = {
    'ë¯¸í™•ì¸': { icon: 'â“', text: 'ë¯¸í™•ì¸', class: 'status-unconfirmed' },
    'ê°€ëŠ¥': { icon: 'âœ…', text: 'ê°€ëŠ¥', class: 'status-available' },
    'í’ˆì ˆ': { icon: 'âŒ', text: 'í’ˆì ˆ', class: 'status-soldout' },
    'ì˜¤ë”ì¤‘': { icon: 'â³', text: 'ì˜¤ë”ì¤‘', class: 'status-ordering' }
  };
  
  if (isCSVConfirmed) {
    if (stockData.stockStatus === 'not_found') {
      return { icon: 'ğŸ”', text: 'CSV ë¯¸ë“±ë¡', class: 'status-not-found csv-confirmed' };
    } else if (stockData.stockStatus === 'partial') {
      return { icon: 'ğŸ“Š', text: statusStr, class: 'status-partial csv-confirmed' };
    }
    
    const baseStatus = statusMap[statusStr] || statusMap['ë¯¸í™•ì¸'];
    return { ...baseStatus, class: baseStatus.class + ' csv-confirmed' };
  }
  
  if (statusStr.includes('ê°œë§Œ ê°€ëŠ¥')) {
    return { icon: 'ğŸ“Š', text: statusStr, class: 'status-partial' };
  }
  
  if (!isNaN(statusStr) && statusStr !== '' && statusStr !== 'ë¯¸í™•ì¸') {
    return { icon: 'ğŸ“Š', text: `${statusStr}ê°œë§Œ ê°€ëŠ¥`, class: 'status-partial' };
  }
  
  if (statusStr && !statusMap[statusStr]) {
    return { icon: 'ğŸ“', text: statusStr, class: 'status-custom' };
  }
  
  return statusMap[statusStr] || statusMap['ë¯¸í™•ì¸'];
}

// ===== 17. í™•ì •/ì €ì¥ ê¸°ëŠ¥ =====
function showConfirmModal(title, message, onConfirm) {
  const modalContent = `
    <div class="confirm-modal-content">
      <h3>${title}</h3>
      <p>${message}</p>
      <div class="modal-actions" style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" id="confirm-action-btn">í™•ì¸</button>
      </div>
    </div>
  `;
  
  showModal(modalContent);
  
  // í™•ì¸ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  setTimeout(() => {
    const confirmBtn = document.getElementById('confirm-action-btn');
    if (confirmBtn) {
      confirmBtn.onclick = function() {
        closeModal();
        if (onConfirm) onConfirm();
      };
    }
  }, 100);
}

// confirmSelectedItems í•¨ìˆ˜ ìˆ˜ì •
function confirmSelectedItems() {
  const checkboxes = document.querySelectorAll('.order-checkbox:checked');
  
  if (checkboxes.length === 0) {
    showError('í™•ì •í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ì„ íƒëœ í•­ëª©ë“¤ì˜ ì •ë³´ ìˆ˜ì§‘
  const selectedItems = [];
  checkboxes.forEach(checkbox => {
    const orderItem = checkbox.closest('.order-item');
    if (orderItem && orderItem.dataset.id) {
      const item = AppState.orderItems.find(i => String(i.id) === String(orderItem.dataset.id));
      if (item && item.status !== 'í™•ì •') {
        selectedItems.push(item);
      }
    }
  });
  
  if (selectedItems.length === 0) {
    showError('ì´ë¯¸ í™•ì •ëœ í•­ëª©ì…ë‹ˆë‹¤.');
    return;
  }
  
  // ìƒí’ˆ ëª©ë¡ HTML ìƒì„±
  const itemListHtml = selectedItems.map(item => `
    <div style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">
      <strong>${item.name}</strong>
      ${item.option ? `<span style="color: #666;"> - ${item.option}</span>` : ''}
      <span style="float: right; color: #3498db;">${item.quantity}ê°œ</span>
    </div>
  `).join('');
  
  // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ ì‚¬ìš©
  showConfirmModal(
    'ì„ íƒ í•­ëª© í™•ì •',
    `<div style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
      ${itemListHtml}
    </div>
    <p style="margin-top: 15px; font-weight: bold;">
      ì´ ${selectedItems.length}ê°œ í•­ëª©ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
    </p>`,
    function() {
      let confirmedCount = 0;
      selectedItems.forEach(item => {
        item.status = 'í™•ì •';
        item.confirmedAt = new Date().toLocaleString('ko-KR');
        confirmedCount++;
      });
      
      updateOrderList();
      saveDraft();
      
      if (confirmedCount > 0) {
        showQuickSuccess(`${confirmedCount}ê°œ í•­ëª©ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
    }
  );
}

// confirmAllItems í•¨ìˆ˜ ìˆ˜ì •
function confirmAllItems() {
  const unconfirmedItems = AppState.orderItems.filter(item => item.status !== 'í™•ì •');
  
  if (unconfirmedItems.length === 0) {
    showError('í™•ì •í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ìƒí’ˆ ëª©ë¡ HTML ìƒì„± (ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ í‘œì‹œ)
  const displayItems = unconfirmedItems.slice(0, 10);
  const itemListHtml = displayItems.map(item => `
    <div style="text-align: left; padding: 8px; border-bottom: 1px solid #eee;">
      <strong>${item.name}</strong>
      ${item.option ? `<span style="color: #666;"> - ${item.option}</span>` : ''}
      <span style="float: right; color: #3498db;">${item.quantity}ê°œ</span>
    </div>
  `).join('');
  
  const moreItemsText = unconfirmedItems.length > 10 ? 
    `<p style="text-align: center; color: #666; margin-top: 10px;">
      ... ì™¸ ${unconfirmedItems.length - 10}ê°œ í•­ëª©
    </p>` : '';
  
  // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ ì‚¬ìš©
  showConfirmModal(
    'ì „ì²´ í™•ì •',
    `<div style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
      ${itemListHtml}
      ${moreItemsText}
    </div>
    <p style="margin-top: 15px; font-weight: bold;">
      ì´ ${unconfirmedItems.length}ê°œ í•­ëª©ì„ ëª¨ë‘ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
    </p>
    <p style="color: #e74c3c; margin-top: 10px; font-size: 14px;">
      âš ï¸ í™•ì • í›„ì—ëŠ” ìˆ˜ëŸ‰ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
    </p>`,
    function() {
      unconfirmedItems.forEach(item => {
        item.status = 'í™•ì •';
        item.confirmedAt = new Date().toLocaleString('ko-KR');
      });
      
      updateOrderList();
      saveDraft();
      showQuickSuccess(`${unconfirmedItems.length}ê°œ í•­ëª©ì´ ëª¨ë‘ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
  );
}

function saveDraft(showMessage = true) {
  if (!AppState.currentOrderInfo) {
    if (showMessage) showError('ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (AppState.orderItems.length === 0) {
    if (showMessage) showError('ì €ì¥í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  showSaveIndicator('saving');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('saved');
      if (result.success && showMessage) {
        showQuickSuccess(`${result.savedCount}ê°œ í•­ëª©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
      AppState.hasUnsavedChanges = false;
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      if (showMessage) showError('ì €ì¥ ì‹¤íŒ¨: ' + error);
    })
    .saveToOrderSheetWithVersion(AppState.orderItems)
}

function clearOrders() {
  const modalContent = `
    <div class="clear-orders-modal">
      <h3>âš ï¸ ë°œì£¼ ëª©ë¡ ì´ˆê¸°í™”</h3>
      <p class="warning-text">ì •ë§ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <p class="sub-text">ë°œì£¼ì„œì˜ ëª¨ë“  í•­ëª©ì´ ì‚­ì œë©ë‹ˆë‹¤.</p>
      
      <div class="modal-actions">
        <button id="clear-confirm-btn" class="btn btn-danger" disabled onclick="confirmClearOrders()">
          ì˜ˆ (<span id="clear-timer">5</span>ì´ˆ)
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">ì•„ë‹ˆì˜¤</button>
      </div>
    </div>
  `;
  
  showModal(modalContent);
  
  let timeLeft = 5;
  const confirmBtn = document.getElementById('clear-confirm-btn');
  const timerSpan = document.getElementById('clear-timer');
  
  const timerInterval = setInterval(() => {
    timeLeft--;
    
    if (timeLeft > 0) {
      timerSpan.textContent = timeLeft;
    } else {
      clearInterval(timerInterval);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = 'ì˜ˆ, ì´ˆê¸°í™”í•©ë‹ˆë‹¤';
      confirmBtn.classList.add('active');
    }
  }, 1000);
}

function confirmClearOrders() {
  AppState.orderItems = [];
  clearSession();
  updateOrderList();
  closeModal();
  
  if (AppState.currentOrderInfo) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          showQuickSuccess('ë°œì£¼ ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      })
      .clearOrderSheet(AppState.currentOrderInfo.orderId);
  } else {
    showQuickSuccess('ë°œì£¼ ëª©ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
}

// ===== 18. ì„¸ì…˜ ê´€ë¦¬ =====
function restoreSession() {
  try {
    const sessionData = sessionStorage.getItem('currentOrderSession');
    if (!sessionData) return false;
    
    const data = JSON.parse(sessionData);
    
    if (Date.now() - data.timestamp > CONFIG.SESSION_TTL) {
      sessionStorage.removeItem('currentOrderSession');
      return false;
    }
    
    if (data.orderInfo?.orderId !== AppState.currentOrderInfo?.orderId) {
      sessionStorage.removeItem('currentOrderSession');
      return false;
    }
    
    AppState.orderItems = data.orderItems;
    updateOrderList();
    showQuickSuccess('ì´ì „ ì‘ì—…ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
    return true;
    
  } catch (e) {
    console.error('ì„¸ì…˜ ë³µì› ì‹¤íŒ¨:', e);
    sessionStorage.removeItem('currentOrderSession');
    return false;
  }
}

function saveSession() {
  if (!AppState.currentOrderInfo || AppState.orderItems.length === 0) return;
  
  try {
    const sessionData = {
      orderInfo: {
        orderId: AppState.currentOrderInfo.orderId,
        recipientName: AppState.currentOrderInfo.recipientName,
        fileName: AppState.currentOrderInfo.fileName
      },
      orderItems: AppState.orderItems.slice(0, CONFIG.MAX_SESSION_ITEMS),
      timestamp: Date.now()
    };
    
    sessionStorage.setItem('currentOrderSession', JSON.stringify(sessionData));
  } catch (e) {
    console.warn('ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨:', e);
  }
}

function clearSession() {
  sessionStorage.removeItem('currentOrderSession');
  
  if (AppState.currentOrderInfo?.orderId) {
    localStorage.removeItem(`order_${AppState.currentOrderInfo.orderId}`);
  }
  
  Object.values(AppState.timers).forEach(timer => {
    if (timer) clearTimeout(timer);
  });
  
  AppState.hasUnsavedChanges = false;
}

// ===== 19. ìë™ ì €ì¥ =====
function startAutoSave() {
  if (AppState.timers.autoSave) {
    clearInterval(AppState.timers.autoSave);
  }
  
  AppState.timers.autoSave = setInterval(() => {
    saveSession();
    
    if (AppState.hasUnsavedChanges && AppState.currentOrderInfo) {
      performAutoSave();
    }
  }, CONFIG.AUTO_SAVE_DELAY);
}

function scheduleAutoSave() {
  AppState.hasUnsavedChanges = true;
  saveSession();
}

function performAutoSave() {
  showSaveIndicator('saving');
  
  google.script.run
    .withSuccessHandler(() => {
      showSaveIndicator('saved');
      AppState.hasUnsavedChanges = false;
    })
    .withFailureHandler((error) => {
      showSaveIndicator('hide');
      console.error('ìë™ ì €ì¥ ì‹¤íŒ¨:', error);
    })
    .saveToOrderSheetWithVersion(AppState.orderItems)
}

// ===== 20. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ =====
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function formatNumber(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function parseColorSize(optionText) {
  if (!optionText) return { color: '', size: '', display: '' };
  
  const parts = optionText.split('/');
  if (parts.length !== 2) {
    return { color: '', size: optionText, display: optionText };
  }
  
  const [colorPart, sizePart] = parts.map(p => p.trim());
  const colorLower = colorPart.toLowerCase();
  const hexColor = colorMap[colorLower];
  
  return {
    color: colorPart,
    colorHex: hexColor,
    size: sizePart,
    display: optionText
  };
}

// ===== 20. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ===== ì„¹ì…˜ì— ì¶”ê°€
function getPriorityDisplay(priority) {
  switch(priority) {
    case 1:
      return { 
        icon: 'â˜…', 
        text: 'ë†’ìŒ', 
        class: 'priority-high' 
      };
    case 2:
      return { 
        icon: 'â˜…', 
        text: 'ë³´í†µ', 
        class: 'priority-medium' 
      };
    case 3:
      return { 
        icon: 'â˜…', 
        text: 'ë‚®ìŒ', 
        class: 'priority-low' 
      };
    default:
      return { 
        icon: 'â˜…', 
        text: 'ë‚®ìŒ', 
        class: 'priority-medium' 
      };
  }
}

function getCategory(productName) {
  if (!productName) return '';
  
  // AppState.categoryRulesê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
  if (!AppState.categoryRules || typeof AppState.categoryRules !== 'object') {
    return '';
  }
  
  const nameLower = productName.toLowerCase();
  
  // ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš° ë¨¼ì € í™•ì¸
  if (AppState.categoryRules[nameLower]) {
    return AppState.categoryRules[nameLower];
  }
  
  // ë¶€ë¶„ ì¼ì¹˜ í™•ì¸
  for (const [keyword, category] of Object.entries(AppState.categoryRules)) {
    if (nameLower.includes(keyword.toLowerCase())) {
      return category;
    }
  }
  
  return '';
}

function filterSearchResults() {
  const items = document.querySelectorAll('.search-item');
  
  items.forEach(item => {
    if (AppState.currentFilter === 'all' || item.dataset.tag === AppState.currentFilter) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}

function showModal(content) {
  console.log('showModal í˜¸ì¶œë¨');
  
  let modalBody = document.getElementById('modal-body');
  let modal = document.getElementById('modal');
  
  // ëª¨ë‹¬ì´ ì—†ìœ¼ë©´ ìƒì„±
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'modal';
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div id="modal-body"></div>
      </div>
    `;
    document.body.appendChild(modal);
    modalBody = document.getElementById('modal-body');
  }
  
  if (modalBody) {
    modalBody.innerHTML = content;
    modal.style.display = 'block';
  } else {
    console.error('ëª¨ë‹¬ bodyë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
  }
}

function closeModal(modalId) {
  console.log('closeModal í˜¸ì¶œë¨, modalId:', modalId);
  
  if (modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
    }
  } else {
    // ê¸°ë³¸ ëª¨ë‹¬ ë‹«ê¸°
    const modal = document.getElementById('modal');
    if (modal) {
      modal.style.display = 'none';
    }
    
    // ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
    document.querySelectorAll('.modal').forEach(m => {
      if (m.style.display === 'block') {
        m.style.display = 'none';
      }
    });
  }
}

function closeAllModals() {
  document.querySelectorAll('.modal').forEach(modal => {
    modal.style.display = 'none';
  });
  
  document.querySelectorAll('.quick-stock-menu.show').forEach(menu => {
    menu.classList.remove('show');
  });
}

function handleBeforeUnload(e) {
  if (AppState.hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = 'ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.';
  }
}

function showQuickSuccess(message) {
  const translatedMessage = typeof message === 'string' && message.startsWith('messages.') 
    ? t(message) 
    : message;
    
  const existingToast = document.querySelector('.toast-message');
  if (existingToast) existingToast.remove();
  
  const toast = document.createElement('div');
  toast.className = 'toast-message success show';
  toast.textContent = translatedMessage;
  document.body.appendChild(toast);
  
setTimeout(() => {
   toast.classList.remove('show');
   setTimeout(() => toast.remove(), 300);
 }, 2000);
}

function showError(message) {
 const translatedMessage = typeof message === 'string' && message.startsWith('messages.') 
   ? t(message) 
   : message;
   
 const existingToast = document.querySelector('.toast-message');
 if (existingToast) existingToast.remove();
 
 const toast = document.createElement('div');
 toast.className = 'toast-message error show';
 toast.textContent = translatedMessage;
 document.body.appendChild(toast);
 
 setTimeout(() => {
   toast.classList.remove('show');
   setTimeout(() => toast.remove(), 300);
 }, 3000);
}

function showSaveIndicator(status) {
 let indicator = document.getElementById('save-indicator');
 
 if (!indicator) {
   indicator = document.createElement('div');
   indicator.id = 'save-indicator';
   indicator.className = 'save-indicator';
   document.body.appendChild(indicator);
 }
 
 const messages = {
   'loading': 'âŸ³ ë¡œë”©ì¤‘...',
   'saving': 'ğŸ’¾ ì €ì¥ ì¤‘...',
   'saved': 'âœ“ ì €ì¥ë¨',
   'hide': ''
 };
 
 indicator.textContent = messages[status] || '';
 
 if (status === 'hide') {
   indicator.classList.remove('show');
   indicator.style.display = 'none';
 } else {
   indicator.classList.add('show');
   indicator.style.display = 'block';
 }
 
 if (status === 'saved') {
   setTimeout(() => {
     indicator.classList.remove('show');
     setTimeout(() => {
       indicator.style.display = 'none';
     }, 300);
   }, 2000);
 }
}

function showLoading(message = 'ì²˜ë¦¬ ì¤‘...') {
  let loading = document.getElementById('loading');
  if (!loading) {
    loading = document.createElement('div');
    loading.id = 'loading';
    loading.className = 'loading';
    loading.innerHTML = `
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-message">${message}</div>
        <div class="loading-progress">
          <div class="loading-progress-bar"></div>
        </div>
      </div>
    `;
    document.body.appendChild(loading);
  } else {
    const messageEl = loading.querySelector('.loading-message');
    if (messageEl) {
      messageEl.textContent = message;
    }
  }
  loading.style.display = 'flex';
}

function hideLoading() {
  const loading = document.getElementById('loading');
  if (loading) {
    loading.style.display = 'none';
  }
}

function showRetryNotification(functionName, attempt, maxRetries) {
 let notification = document.getElementById('retry-notification');
 
 if (!notification) {
   notification = document.createElement('div');
   notification.id = 'retry-notification';
   notification.className = 'retry-notification';
   document.body.appendChild(notification);
 }
 
 notification.innerHTML = `
   <div class="retry-icon">ğŸ”„</div>
   <div class="retry-text">
     <div class="retry-title">ì—°ê²° ì¬ì‹œë„ ì¤‘...</div>
     <div class="retry-detail">${attempt}/${maxRetries} ì‹œë„</div>
   </div>
 `;
 
 notification.classList.add('show');
}

function hideRetryNotification() {
 const notification = document.getElementById('retry-notification');
 if (notification) {
   notification.classList.remove('show');
   setTimeout(() => {
     notification.remove();
   }, 300);
 }
}

// ===== 21. ë‹¤êµ­ì–´ ì§€ì› =====
function initializeLanguage() {
  // const savedLang = localStorage.getItem('preferredLanguage');
  const savedLang = safeGetItem('preferredLanguage');
  
  if (savedLang) {
    AppState.currentLang = savedLang;
  } else {
    AppState.currentLang = detectBrowserLanguage();
    // localStorage.setItem('preferredLanguage', AppState.currentLang);
    safeSetItem('preferredLanguage', AppState.currentLang);
  }
  
  return loadTranslations(AppState.currentLang);
}

function detectBrowserLanguage() {
 const browserLang = navigator.language || navigator.userLanguage;
 return browserLang.startsWith('ja') ? 'ja' : 'ko';
}

function loadTranslations(lang) {
 return new Promise((resolve, reject) => {
   google.script.run
     .withSuccessHandler(function(trans) {
       AppState.translations = trans;
       applyTranslations();
       resolve();
     })
     .withFailureHandler(reject)
     .getTranslations(lang);
 });
}

function applyTranslations() {
 document.querySelectorAll('[data-i18n]').forEach(element => {
   const key = element.getAttribute('data-i18n');
   const translation = getNestedTranslation(key);
   
   if (translation) {
     if (element.tagName === 'INPUT' && element.type === 'text') {
       element.placeholder = translation;
     } else {
       element.textContent = translation;
     }
   }
 });
}

function getNestedTranslation(key) {
 const keys = key.split('.');
 let value = AppState.translations;
 
 for (const k of keys) {
   if (value && value[k]) {
     value = value[k];
   } else {
     return null;
   }
 }
 
 return value;
}

function t(key) {
 return getNestedTranslation(key) || key;
}

// ===== 22. í‘œì‹œ ì„¤ì • =====
function loadDisplaySettings() {
  // const stored = localStorage.getItem('displaySettings');
  const stored = safeGetItem('displaySettings');
  
  if (stored) {
    // try {
    //   return JSON.parse(stored);
    // } catch (e) {
    //   return getDefaultDisplaySettings();
    // }
    return stored; // safeGetItemì´ ì´ë¯¸ íŒŒì‹±í•´ì„œ ë°˜í™˜
  }
  
  return getDefaultDisplaySettings();
}

function getDefaultDisplaySettings() {
  const defaults = {
    showBarcode: false,
    showSupplier: false,
    showWeight: false,
    showMemo: false,
    colorChipEnabled: true,
    compactMode: false
  };
  
  // localStorage.setItem('displaySettings', JSON.stringify(defaults));
  safeSetItem('displaySettings', defaults);
  return defaults;
}

// ì„¤ì • í‘œì‹œ í•¨ìˆ˜ ìˆ˜ì •
function displaySettings(settings) {
  const elements = {
    'product-sheet-id': settings.productSheetId,
    'order-sheet-id': settings.orderSheetId,
    'max-results': settings.maxSearchResults || 100,
    'monthly-budget': settings.monthlyBudget || 10000000,
    'language': settings.language || 'ko'
  };
  
  Object.entries(elements).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.value = value || '';
  });
  
  // ë°•ìŠ¤ ë°”ì½”ë“œ ëª©ë¡ í‘œì‹œ
  displayBoxBarcodes();
}

// ë°•ìŠ¤ ëª¨ë“œ ì „í™˜ UI
function toggleBoxModeUI(mode) {
  // ë°•ìŠ¤ ì„¤ì •ì´ ì„¤ì • íƒ­ì— ì—†ìœ¼ë¯€ë¡œ í•¨ìˆ˜ ë¹„í™œì„±í™”
  console.log('ë°•ìŠ¤ ëª¨ë“œ:', mode);
  
  // ë°•ìŠ¤ ë°”ì½”ë“œ ëª©ë¡ë§Œ í‘œì‹œ/ì—…ë°ì´íŠ¸
  if (mode === 'barcode') {
    displayBoxBarcodes();
  }
}

function initializeDisplaySettings() {
 const settings = loadDisplaySettings();
 
 Object.keys(settings).forEach(key => {
   const toggleId = `toggle-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
   const toggleElement = document.getElementById(toggleId);
   
   if (toggleElement) {
     if (settings[key]) {
       toggleElement.classList.add('active');
     } else {
       toggleElement.classList.remove('active');
     }
   }
 });
}

function toggleSetting(settingName) {
 const settings = loadDisplaySettings();
 const toggleElement = event.currentTarget;
 
 settings[settingName] = !settings[settingName];
 
 if (settings[settingName]) {
   toggleElement.classList.add('active');
 } else {
   toggleElement.classList.remove('active');
 }
 
 saveDisplaySettings(settings);
}

// ===== 23. ì¶”ê°€ ê¸°ëŠ¥ë“¤ =====
function injectColorChipStyles() {
 if (document.getElementById('colorchip-styles')) return;
 
 const styleElement = document.createElement('style');
 styleElement.id = 'colorchip-styles';
 styleElement.textContent = `
   .color-chip-container {
     display: inline-flex !important;
     align-items: center !important;
     gap: 6px !important;
     margin-right: 12px !important;
   }
   
   .color-chip {
     display: inline-block !important;
     width: 14px !important;
     height: 14px !important;
     border-radius: 4px !important;
     border: 1px solid rgba(0, 0, 0, 0.2) !important;
     vertical-align: middle !important;
     box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12) !important;
   }
   
   .color-name {
     font-size: 12px !important;
     color: #666 !important;
     text-transform: capitalize !important;
   }
   
   .size-text {
     font-size: 12px !important;
     color: #333 !important;
     font-weight: 500 !important;
     padding: 2px 8px !important;
     background: #f0f0f0 !important;
     border-radius: 12px !important;
     text-transform: uppercase !important;
   }
 `;
 
 document.head.appendChild(styleElement);
}

function setupKeyboardShortcuts() {
 // ì´ë¯¸ handleGlobalKeydownì—ì„œ ì²˜ë¦¬ë¨
}

function restoreLocalCache() {
 try {
   const localCache = localStorage.getItem('recentAddedProducts');
   if (!localCache) return;
   
   const cached = JSON.parse(localCache);
   const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
   
   const validCache = cached.filter(p => {
     const cachedTime = new Date(p.cachedAt).getTime();
     return cachedTime > thirtyDaysAgo;
   });
   
   const existingBarcodes = new Set(AppState.products.map(p => p.barcode));
   let addedCount = 0;
   
   validCache.forEach(p => {
     if (!existingBarcodes.has(p.barcode)) {
       p.isFromCache = true;
       AppState.products.push(p);
       addedCount++;
     }
   });
   
   if (validCache.length < cached.length) {
     localStorage.setItem('recentAddedProducts', JSON.stringify(validCache));
   }
   
   if (addedCount > 0) {
     console.info(`ë¡œì»¬ ìºì‹œì—ì„œ ${addedCount}ê°œ ìƒí’ˆ ë³µì›`);
   }
   
 } catch (e) {
   console.warn('ë¡œì»¬ ìºì‹œ ë³µì› ì‹¤íŒ¨:', e);
 }
}

// ===== 24. ë‚˜ë¨¸ì§€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í•¨ìˆ˜ë“¤ =====
// ìš°ì„ ìˆœìœ„, ì½”ë©˜íŠ¸, ëŒ€ì‹œë³´ë“œ, ìì£¼ë°œì£¼, ì•ˆì „ì¬ê³ , CSV ì—…ë¡œë“œ/ë‚´ë³´ë‚´ê¸°, ì œí’ˆ ì´ìŠˆ, ì„¤ì • ë“±ì˜ í•¨ìˆ˜ë“¤
// ì´ ë¶€ë¶„ì€ ê¸°ì¡´ ì½”ë“œì—ì„œ ì¤‘ë³µ ì œê±° í›„ ê·¸ëŒ€ë¡œ ìœ ì§€

// ===== ìš°ì„ ìˆœìœ„ ê´€ë ¨ í•¨ìˆ˜ë“¤ - ì „ì—­ ìŠ¤ì½”í”„ì— ì§ì ‘ ì •ì˜ =====

// 1. getPriorityDisplay í•¨ìˆ˜ ìˆ˜ì • (ê¸°ë³¸ê°’ 3ìœ¼ë¡œ)
window.getPriorityDisplay = function(priority) {
  // ê¸°ë³¸ê°’ì„ 3ìœ¼ë¡œ ì„¤ì •
  const p = priority || 3;
  
  switch(p) {
    case 1:
      return { 
        icon: 'â˜…â˜…â˜…', 
        text: 'ë†’ìŒ', 
        class: 'priority-high' 
      };
    case 2:
      return { 
        icon: 'â˜…â˜…', 
        text: 'ë³´í†µ', 
        class: 'priority-medium' 
      };
    case 3:
      return { 
        icon: 'â˜…', 
        text: 'ë‚®ìŒ', 
        class: 'priority-low' 
      };
    default:
      return { 
        icon: 'â˜…', 
        text: 'ë‚®ìŒ', 
        class: 'priority-low' 
      };
  }
}

// ìš°ì„ ìˆœìœ„ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ - ì „ì—­ í•¨ìˆ˜ë¡œ ì§ì ‘ ì •ì˜
window.showPriorityPicker = function(itemId) {
  console.log('=== showPriorityPicker ë””ë²„ê¹… ===');
  console.log('1. í•¨ìˆ˜ í˜¸ì¶œë¨, itemId:', itemId);
  console.log('2. AppState í™•ì¸:', typeof AppState !== 'undefined' ? 'OK' : 'ERROR - AppState ì—†ìŒ');
  console.log('3. orderItems ê°œìˆ˜:', AppState?.orderItems?.length || 0);
  
  // AppState ì²´í¬
  if (typeof AppState === 'undefined' || !AppState.orderItems) {
    console.error('AppState ë˜ëŠ” orderItemsê°€ ì—†ìŠµë‹ˆë‹¤');
    alert('ì•± ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ì•„ì´í…œ ì°¾ê¸°
  const item = AppState.orderItems.find(i => String(i.id) === String(itemId));
  console.log('4. ì•„ì´í…œ ì°¾ê¸° ê²°ê³¼:', item ? 'FOUND' : 'NOT FOUND');
  
  if (!item) {
    console.error('ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID:', itemId);
    console.log('í˜„ì¬ orderItems IDs:', AppState.orderItems.map(i => i.id));
    alert('í•´ë‹¹ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (item.status === 'í™•ì •') {
    console.log('5. í™•ì •ëœ í•­ëª©ì…ë‹ˆë‹¤');
    alert('í™•ì •ëœ í•­ëª©ì€ ìš°ì„ ìˆœìœ„ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  const currentPriority = item.priority || 2;
  console.log('6. í˜„ì¬ ìš°ì„ ìˆœìœ„:', currentPriority);
  
  // ëª¨ë‹¬ HTML ìƒì„±
  const modalContent = `
    <div class="priority-modal-content">
      <h3>ìš°ì„ ìˆœìœ„ ì„ íƒ</h3>
      <p class="item-info">${item.name}</p>
      <div class="priority-picker">
        <button class="priority-option ${currentPriority === 1 ? 'selected' : ''}" 
                onclick="window.setPriority('${itemId}', 1)">
          <span class="priority-level high">â˜…â˜…â˜…</span>
          <span class="priority-desc">ê¸´ê¸‰ ë°œì£¼ í•„ìš”</span>
        </button>
        <button class="priority-option ${currentPriority === 2 ? 'selected' : ''}" 
                onclick="window.setPriority('${itemId}', 2)">
          <span class="priority-level medium">â˜…â˜…</span>
          <span class="priority-desc">ì¼ë°˜ ë°œì£¼</span>
        </button>
        <button class="priority-option ${currentPriority === 3 ? 'selected' : ''}" 
                onclick="window.setPriority('${itemId}', 3)">
          <span class="priority-level low">â˜…</span>
          <span class="priority-desc">ì—¬ìœ  ìˆìŒ</span>
        </button>
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <button class="btn btn-secondary" onclick="window.closeModal()">ì·¨ì†Œ</button>
      </div>
    </div>
  `;
  
  console.log('7. ëª¨ë‹¬ í‘œì‹œ ì‹œë„');
  
  // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
  const existingModal = document.getElementById('priority-modal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // ìƒˆ ëª¨ë‹¬ ìƒì„±
  const modal = document.createElement('div');
  modal.id = 'priority-modal';
  modal.className = 'modal';
  modal.style.cssText = 'display: block; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);';
  
  const modalInner = document.createElement('div');
  modalInner.className = 'modal-content';
  modalInner.style.cssText = 'background-color: white; margin: 10% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 8px; position: relative;';
  
  const closeBtn = document.createElement('span');
  closeBtn.className = 'modal-close';
  closeBtn.innerHTML = '&times;';
  closeBtn.style.cssText = 'position: absolute; right: 20px; top: 20px; font-size: 28px; cursor: pointer; color: #aaa;';
  closeBtn.onclick = function() { modal.remove(); };
  
  modalInner.appendChild(closeBtn);
  modalInner.insertAdjacentHTML('beforeend', modalContent);
  modal.appendChild(modalInner);
  document.body.appendChild(modal);
  
  console.log('8. ëª¨ë‹¬ ìƒì„± ì™„ë£Œ');
  
  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  modal.onclick = function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  };
};

// ìš°ì„ ìˆœìœ„ ì„¤ì • - ì „ì—­ í•¨ìˆ˜ë¡œ ì§ì ‘ ì •ì˜
window.setPriority = function(itemId, priority) {
  console.log('=== setPriority ë””ë²„ê¹… ===');
  console.log('1. í•¨ìˆ˜ í˜¸ì¶œë¨, itemId:', itemId, 'priority:', priority);
  
  const item = AppState.orderItems.find(i => String(i.id) === String(itemId));
  if (!item) {
    console.error('ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', itemId);
    return;
  }
  
  console.log('2. ì´ì „ ìš°ì„ ìˆœìœ„:', item.priority);
  item.priority = priority || 2;
  console.log('3. ìƒˆ ìš°ì„ ìˆœìœ„:', item.priority);
  
  // ëª¨ë‹¬ ë‹«ê¸°
  const modal = document.getElementById('priority-modal');
  if (modal) {
    modal.remove();
  }
  
  // í•´ë‹¹ í•­ëª©ë§Œ ì—…ë°ì´íŠ¸
  const orderItemEl = document.querySelector(`[data-id="${itemId}"]`);
  if (orderItemEl) {
    const priorityBtn = orderItemEl.querySelector('.order-action-btn.priority');
    if (priorityBtn) {
      const priorityDisplay = getPriorityDisplay(priority);
      priorityBtn.className = `order-action-btn priority ${priorityDisplay.class}`;
      priorityBtn.innerHTML = `
        <span class="priority-badge">${priorityDisplay.icon}</span>
        <span class="priority-text">${priorityDisplay.text}</span>
      `;
      priorityBtn.title = `ìš°ì„ ìˆœìœ„: ${priorityDisplay.text}`;
      console.log('4. UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }
  }
  
  // ìë™ ì €ì¥
  if (typeof scheduleAutoSave === 'function') {
    scheduleAutoSave();
  }
  
  // ì„±ê³µ ë©”ì‹œì§€
  if (typeof showQuickSuccess === 'function') {
    showQuickSuccess('ìš°ì„ ìˆœìœ„ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } else {
    alert('ìš°ì„ ìˆœìœ„ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
  
  console.log('5. ìš°ì„ ìˆœìœ„ ë³€ê²½ ì™„ë£Œ');
};

// closeModal í•¨ìˆ˜ë„ ì „ì—­ìœ¼ë¡œ
window.closeModal = function(modalId) {
  if (modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.style.display = 'none';
  } else {
    // priority-modal ë¨¼ì € í™•ì¸
    const priorityModal = document.getElementById('priority-modal');
    if (priorityModal) {
      priorityModal.remove();
      return;
    }
    
    // ê¸°ë³¸ ëª¨ë‹¬
    const modal = document.getElementById('modal');
    if (modal) modal.style.display = 'none';
    
    // ëª¨ë“  ëª¨ë‹¬
    document.querySelectorAll('.modal').forEach(m => {
      if (m.style.display === 'block') {
        m.style.display = 'none';
      }
    });
  }
};

function showCommentInput(id) {
  const item = AppState.orderItems.find(i => i.id == id);
  if (!item) return;
  
  const modalContent = `
    <h3>ì½”ë©˜íŠ¸ ì…ë ¥</h3>
    <textarea id="comment-textarea" class="comment-textarea" placeholder="í´ë¦­í•˜ì—¬ ì…ë ¥...">${item.comment || ''}</textarea>
    <div style="margin-top: 20px; text-align: right;">
      <button class="btn btn-primary" onclick="saveComment('${id}')">ì €ì¥</button>
      <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
  `;
  
  showModal(modalContent);
  
  // autofocus ëŒ€ì‹  í´ë¦­ ì´ë²¤íŠ¸ ì‚¬ìš©
  setTimeout(() => {
    const textarea = document.getElementById('comment-textarea');
    if (textarea) {
      textarea.addEventListener('click', function() {
        this.placeholder = 'ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
      }, { once: true });
    }
  }, 100);
}

function saveComment(id) {
  const comment = document.getElementById('comment-textarea').value.trim();
  const item = AppState.orderItems.find(i => i.id == id);
  
  if (item) {
    item.comment = comment;
    
    // í•´ë‹¹ í•­ëª©ì˜ UIë§Œ ì—…ë°ì´íŠ¸
    const orderItem = document.querySelector(`[data-id="${id}"]`);
    if (orderItem) {
      const commentBtn = orderItem.querySelector('.order-action-btn.comment');
      if (commentBtn) {
        if (comment) {
          commentBtn.classList.add('has-comment');
          commentBtn.setAttribute('data-comment', comment);
          
          // ì½”ë©˜íŠ¸ í‘œì‹œê¸° ì¶”ê°€
          if (!commentBtn.querySelector('.comment-indicator')) {
            commentBtn.innerHTML = 'ğŸ’¬<span class="comment-indicator"></span>';
          }
        } else {
          commentBtn.classList.remove('has-comment');
          commentBtn.removeAttribute('data-comment');
          commentBtn.innerHTML = 'ğŸ’¬';
        }
      }
    }
    
    closeModal();
    scheduleAutoSave();
    showQuickSuccess(comment ? 'ì½”ë©˜íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì½”ë©˜íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
}

function loadSettings() {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(function(data) {
        AppState.settings = data;
        
        // DOM ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì„¤ì •
        const productSheetEl = document.getElementById('product-sheet-id');
        if (productSheetEl) {
          productSheetEl.value = data.productSheetId || '';
        }
        
        const orderSheetEl = document.getElementById('order-sheet-id');
        if (orderSheetEl) {
          orderSheetEl.value = data.orderSheetId || '';
        }
        
        const maxResultsEl = document.getElementById('max-results');
        if (maxResultsEl) {
          maxResultsEl.value = data.maxSearchResults || 100;
        }
        
        const languageEl = document.getElementById('language');
        if (languageEl) {
          languageEl.value = data.language || 'ko';
        }
        
        const suggestStock0El = document.getElementById('suggest-stock-0');
        if (suggestStock0El) {
          suggestStock0El.value = data.suggestStock0 || 30;
        }
        
        const suggestStock10El = document.getElementById('suggest-stock-10');
        if (suggestStock10El) {
          suggestStock10El.value = data.suggestStock10 || 20;
        }
        
        const suggestStock20El = document.getElementById('suggest-stock-20');
        if (suggestStock20El) {
          suggestStock20El.value = data.suggestStock20 || 10;
        }
        
        resolve();
      })
      .withFailureHandler(function(error) {
        console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
        // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì•±ì€ ê³„ì† ì‹¤í–‰ë˜ë„ë¡ resolve í˜¸ì¶œ
        resolve();
      })
      .getSettings();
  });
}

// ë” ì•ˆì „í•œ ë°©ë²•: ì„¤ì • íƒ­ì´ í™œì„±í™”ë  ë•Œë§Œ ì„¤ì • ë¡œë“œ
function loadSettingsWhenVisible() {
  // ì„¤ì • íƒ­ì´ í‘œì‹œë  ë•Œë§Œ DOM ì—…ë°ì´íŠ¸
  const settingsTab = document.getElementById('settings-tab');
  if (!settingsTab || !settingsTab.classList.contains('active')) {
    // ì„¤ì •ì€ ì €ì¥í•˜ë˜ DOM ì—…ë°ì´íŠ¸ëŠ” í•˜ì§€ ì•ŠìŒ
    return new Promise((resolve) => {
      google.script.run
        .withSuccessHandler(function(data) {
          AppState.settings = data;
          resolve();
        })
        .withFailureHandler(function(error) {
          console.warn('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
          AppState.settings = {}; // ê¸°ë³¸ê°’ ì„¤ì •
          resolve();
        })
        .getSettings();
    });
  }
  
  // ì„¤ì • íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆì„ ë•Œë§Œ ì „ì²´ ë¡œë“œ
  return loadSettings();
}

// ì´ˆê¸°í™” ì‹œì—ëŠ” ì„¤ì •ë§Œ ë¡œë“œí•˜ê³  DOM ì—…ë°ì´íŠ¸ëŠ” í•˜ì§€ ì•ŠìŒ
async function loadSettingsDataOnly() {
  return new Promise((resolve) => {
    google.script.run
      .withSuccessHandler((data) => {
        AppState.settings = data || {};
        resolve(data || {});
      })
      .withFailureHandler(() => {
        AppState.settings = {};
        resolve({});
      })
      .getSettings();
  });
}

// ì„¤ì • ì €ì¥ í•¨ìˆ˜ ìˆ˜ì •
function saveSettings() {
  // DOM ìš”ì†Œ ì•ˆì „ ì¡°íšŒ í•¨ìˆ˜
  const safeGetValue = (id, defaultValue = '') => {
    const element = document.getElementById(id);
    return element ? element.value : defaultValue;
  };

  const newSettings = {
    productSheetId: safeGetValue('product-sheet-id'),
    orderSheetId: safeGetValue('order-sheet-id'),
    maxSearchResults: safeGetValue('max-results', '100'),
    language: safeGetValue('language', 'ko'),
    monthlyBudget: safeGetValue('monthly-budget', '10000000'),
    suggestStock0: safeGetValue('suggest-stock-0', '30'),
    suggestStock10: safeGetValue('suggest-stock-10', '20'),
    suggestStock20: safeGetValue('suggest-stock-20', '10'),
    // ë°•ìŠ¤ ì„¤ì •
    boxMode: safeGetValue('box-mode', 'barcode'),
    boxDigits: safeGetValue('box-digits', '3'),
    maxLowStockDisplay: safeGetValue('max-low-stock-display', '50')
  };

  // ìŒì„± ì„¤ì • ì²˜ë¦¬ (ìš”ì†Œê°€ ìˆì„ ë•Œë§Œ)
  const voiceVolumeEl = document.getElementById('voice-volume');
  const voiceRateEl = document.getElementById('voice-rate');
  const voicePitchEl = document.getElementById('voice-pitch');
  const voiceLanguageEl = document.getElementById('voice-language');

  if (voiceVolumeEl && voiceRateEl && voicePitchEl && voiceLanguageEl) {
    newSettings.voiceSettings = {
      volume: parseFloat(voiceVolumeEl.value),
      rate: parseFloat(voiceRateEl.value),
      pitch: parseFloat(voicePitchEl.value),
      language: voiceLanguageEl.value
    };
  }

  showSaveIndicator('saving');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      if (result.success) {
        AppState.settings = newSettings;
        showQuickSuccess(result.message);
        updateBoxNumberStatus();
      } else {
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + error);
    })
    .updateSettings(newSettings);
}

function updateBulkEditButton() {
 const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
 const bulkEditBtn = document.getElementById('bulk-stock-edit-btn');
 
 if (checkedBoxes.length > 0) {
   bulkEditBtn.style.display = 'inline-flex';
   bulkEditBtn.innerHTML = `<span style="margin-right: 4px;">ğŸ“¦</span> ì¬ê³  ìƒíƒœ (${checkedBoxes.length})`;
 } else {
   bulkEditBtn.style.display = 'none';
 }
}

function updateExportButtonStatus() {
  const exportBtn = document.getElementById('export-csv-btn');
  
  // ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¦¬í„´ (ì˜¤ë¥˜ ë°©ì§€)
  if (!exportBtn) {
    console.log('export-csv-btn not found in DOM');
    return;
  }
  
  if (!AppState.currentOrderInfo || AppState.orderItems.length === 0) {
    exportBtn.disabled = true;
    return;
  }
  
  const hasConfirmed = AppState.orderItems.some(item => item.status === 'í™•ì •');
  exportBtn.disabled = !hasConfirmed;
}

// ===== 25. ëŒ€ì‹œë³´ë“œ ê¸°ëŠ¥ =====
// ë¡œë”© ìƒíƒœ í‘œì‹œ
function showChartLoading(containerId) {
  const container = document.getElementById(containerId);
  if (container) {
    container.innerHTML = `
      <div class="chart-loading">
        <div class="chart-spinner"></div>
      </div>
    `;
  }
}

// ëŒ€ì‹œë³´ë“œ ë¡œë“œ í•¨ìˆ˜ ê°œì„ 
function loadDashboard() {
  // ëª¨ë“  ì°¨íŠ¸ì— ë¡œë”© í‘œì‹œ
  ['top-products', 'category-chart', 'monthly-trend', 'supplier-chart', 'weekday-pattern'].forEach(id => {
    showChartLoading(id);
  });
  
  google.script.run
    .withSuccessHandler(function(data) {
      if (!data) {
        showError('ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ê° ë°ì´í„° í‘œì‹œ
      displayActionItems(data.actionItems || []);
      displayMetrics(data);
      displayTopProducts(data.topProducts || []);
      displayCategoryChart(data.categoryStats || []);
      displayMonthlyTrend(data.monthlyTrend || []);
      displaySupplierChart(data.supplierStats || []);
      displayWeekdayPattern(data.weekdayPattern || []);
      displayBudgetStatus(data.budgetStatus || {});
      
      if (data.trendingProducts) {
        displayTrendingProducts(data.trendingProducts);
      }
    })
    .withFailureHandler(function(error) {
      showError('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨: ' + error);
      // ëª¨ë“  ì°¨íŠ¸ì— ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
      document.querySelectorAll('.chart-container').forEach(container => {
        container.innerHTML = `
          <div class="empty-chart">
            <div class="empty-chart-icon">âŒ</div>
            <div class="empty-chart-text">ë¡œë“œ ì‹¤íŒ¨</div>
          </div>
        `;
      });
    })
    .getDashboardData();
}

function displayActionItems(items) {
  const container = document.getElementById('action-items');
  
  if (!items || items.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  container.innerHTML = items.map(item => `
    <div class="action-item ${item.type}">
      <div class="action-content">
        <h4>${item.title}</h4>
        <p>${item.message}</p>
      </div>
      <button class="btn btn-primary" onclick="handleAction('${item.action}')">
        í™•ì¸
      </button>
    </div>
  `).join('');
}

function handleAction(action) {
  switch(action) {
    case 'checkInventory':
      showFrequentNotOrdered();
      break;
    case 'viewBudget':
      showBudgetDetails();
      break;
    case 'confirmOrders':
      switchTab('order');
      break;
  }
}

function displayMetrics(data) {
  const monthlyTotal = data.monthlyTrend.length > 0 ? 
    data.monthlyTrend[data.monthlyTrend.length - 1].totalAmount : 0;
  document.getElementById('monthly-total').textContent = 'â‚©' + formatNumber(monthlyTotal);
  
  if (data.monthlyTrend.length > 1) {
    const prevMonth = data.monthlyTrend[data.monthlyTrend.length - 2].totalAmount;
    const change = ((monthlyTotal - prevMonth) / prevMonth * 100).toFixed(1);
    const changeEl = document.getElementById('monthly-change');
    changeEl.textContent = (change >= 0 ? '+' : '') + change + '%';
    changeEl.className = 'metric-change ' + (change >= 0 ? 'positive' : 'negative');
  }
  
  if (data.efficiencyMetrics) {
    document.getElementById('avg-cycle').textContent = data.efficiencyMetrics.avgOrderCycle || '-';
    document.getElementById('repeat-rate').textContent = data.efficiencyMetrics.repeatOrderRate || '-';
  }
  
  if (data.budgetStatus) {
    document.getElementById('budget-rate').textContent = data.budgetStatus.percentage + '%';
    document.getElementById('budget-mini-fill').style.width = data.budgetStatus.percentage + '%';
    
    if (data.budgetStatus.percentage >= 80) {
      document.getElementById('budget-mini-fill').style.background = 'var(--error)';
    } else if (data.budgetStatus.percentage >= 60) {
      document.getElementById('budget-mini-fill').style.background = 'var(--warning)';
    }
  }
}

// ëŒ€ì‹œë³´ë“œ ë°ì´í„° í‘œì‹œ í•¨ìˆ˜ë“¤ ê°œì„ 
function displayTopProducts(products) {
  const container = document.getElementById('top-products');
  
  if (!container) return;
  
  if (!products || products.length === 0) {
    container.innerHTML = '<div class="empty-state">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  // ìƒìœ„ 10ê°œë§Œ í‘œì‹œ
  const topItems = products.slice(0, 10);
  const maxAmount = Math.max(...topItems.map(p => p.totalAmount || 0));
  
  let html = '';
  topItems.forEach((product, index) => {
    const percentage = maxAmount > 0 ? (product.totalAmount / maxAmount * 100) : 0;
    
    html += `
      <div class="chart-bar">
        <div class="chart-label" title="${product.name}">
          ${index + 1}. ${product.name}
        </div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill" style="width: ${percentage}%"></div>
        </div>
        <div class="chart-value">â‚©${formatNumber(product.totalAmount || 0)}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function displayCategoryChart(categories) {
  const container = document.getElementById('category-chart');
  
  if (!container) return;
  
  if (!categories || categories.length === 0) {
    container.innerHTML = '<div class="empty-state">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  const total = categories.reduce((sum, cat) => sum + (cat.totalAmount || 0), 0);
  
  let html = '';
  categories.forEach(cat => {
    const percentage = total > 0 ? (cat.totalAmount / total * 100) : 0;
    
    html += `
      <div class="chart-bar">
        <div class="chart-label">${cat.category}</div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill" style="width: ${percentage}%; background: #4caf50;"></div>
        </div>
        <div class="chart-value">${percentage.toFixed(1)}%</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function displayMonthlyTrend(trend) {
  const container = document.getElementById('monthly-trend');
  
  if (!container) return;
  
  if (!trend || trend.length === 0) {
    container.innerHTML = '<div class="empty-state">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  const maxAmount = Math.max(...trend.map(t => t.totalAmount || 0));
  
  let html = '<div class="monthly-trend-chart">';
  
  trend.forEach(month => {
    const height = maxAmount > 0 ? (month.totalAmount / maxAmount * 180) : 0;
    const amount = Math.round((month.totalAmount || 0) / 1000000);
    
    html += `
      <div class="month-bar">
        <div class="month-value">â‚©${amount}M</div>
        <div class="month-bar-fill" style="height: ${height}px"></div>
        <div class="month-label">${month.month.substring(5)}</div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function displaySupplierChart(suppliers) {
  const container = document.getElementById('supplier-chart');
  
  if (!container) return;
  
  if (!suppliers || suppliers.length === 0) {
    container.innerHTML = '<div class="empty-state">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  const topSuppliers = suppliers.slice(0, 10);
  const maxAmount = Math.max(...topSuppliers.map(s => s.totalAmount || 0));
  
  let html = '';
  topSuppliers.forEach((supplier, index) => {
    const percentage = maxAmount > 0 ? (supplier.totalAmount / maxAmount * 100) : 0;
    
    html += `
      <div class="chart-bar">
        <div class="chart-label">${index + 1}. ${supplier.supplier}</div>
        <div class="chart-bar-container">
          <div class="chart-bar-fill" style="width: ${percentage}%; background: #ff9800;"></div>
        </div>
        <div class="chart-value">â‚©${formatNumber(supplier.totalAmount || 0)}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function displayWeekdayPattern(pattern) {
  const container = document.getElementById('weekday-pattern');
  
  if (!container) return;
  
  if (!pattern || pattern.length === 0) {
    container.innerHTML = '<div class="empty-state">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  const maxCount = Math.max(...pattern.map(p => p.count || 0));
  
  let html = '<div class="weekday-pattern-chart">';
  
  pattern.forEach(day => {
    const height = maxCount > 0 ? (day.count / maxCount * 150) : 0;
    const color = (day.day === 'í™”' || day.day === 'ëª©') ? '#ff9800' : '#2196F3';
    
    html += `
      <div class="weekday-bar">
        <div class="weekday-value">${day.count || 0}</div>
        <div class="weekday-bar-fill" style="height: ${height}px; background: ${color};"></div>
        <div class="weekday-label">${day.day}</div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function displayBudgetStatus(budget) {
  if (!budget) return;
  
  const fillEl = document.getElementById('budget-used');
  const textEl = document.getElementById('budget-text');
  const percentEl = document.getElementById('budget-percent');
  
  if (fillEl) {
    fillEl.style.width = (budget.percentage || 0) + '%';
    
    if (budget.percentage >= 90) {
      fillEl.className = 'progress-fill danger';
    } else if (budget.percentage >= 70) {
      fillEl.className = 'progress-fill warning';
    } else {
      fillEl.className = 'progress-fill';
    }
  }
  
  if (textEl) {
    textEl.textContent = `â‚©${formatNumber(budget.used || 0)} / â‚©${formatNumber(budget.budget || 0)}`;
  }
  
  if (percentEl) {
    percentEl.textContent = (budget.percentage || 0) + '%';
  }
}

// formatNumber í•¨ìˆ˜ê°€ ì—†ë‹¤ë©´ ì¶”ê°€
if (typeof formatNumber === 'undefined') {
  window.formatNumber = function(num) {
    return (num || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  };
}

function displayTrendingProducts(trending) {
  const upContainer = document.getElementById('trending-up');
  if (trending.trendingUp && trending.trendingUp.length > 0) {
    upContainer.innerHTML = trending.trendingUp.map(product => `
      <div class="trend-item">
        ${product.name}
        <span class="trend-rate up">+${product.changeRate}%</span>
      </div>
    `).join('');
  } else {
    upContainer.innerHTML = '<div class="empty-state">ê¸‰ìƒìŠ¹ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  }
  
  const downContainer = document.getElementById('trending-down');
  if (trending.trendingDown && trending.trendingDown.length > 0) {
    downContainer.innerHTML = trending.trendingDown.map(product => `
      <div class="trend-item">
        ${product.name}
        <span class="trend-rate down">${product.changeRate}%</span>
      </div>
    `).join('');
  } else {
    downContainer.innerHTML = '<div class="empty-state">ê¸‰í•˜ë½ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  }
}

// ===== 26. ìì£¼ë°œì£¼ ê¸°ëŠ¥ =====
function loadFrequentItems() {
  showLoading('ìì£¼ ë°œì£¼ ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  
  google.script.run
    .withSuccessHandler(function(items) {
      hideLoading(); // showSaveIndicator ëŒ€ì‹  hideLoading ì‚¬ìš©
      displayFrequentItems(items);
    })
    .withFailureHandler(function(error) {
      hideLoading(); // showSaveIndicator ëŒ€ì‹  hideLoading ì‚¬ìš©
      showError('ìì£¼ ë°œì£¼ ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨: ' + error);
    })
    .getFrequentItems();
}

function refreshFrequentItems() {
  showLoading('ìì£¼ ë°œì£¼ ëª©ë¡ì„ ê°±ì‹ í•˜ëŠ” ì¤‘...');
  
  // ì„œë²„ì˜ ìºì‹œë¥¼ ê°±ì‹ í•˜ê³  ë‹¤ì‹œ ë¡œë“œ
  google.script.run
    .withSuccessHandler(function(items) {
      hideLoading();
      // ê°±ì‹ ëœ ë°ì´í„°ë¥¼ ë°”ë¡œ í‘œì‹œ
      displayFrequentItems(items);
      showQuickSuccess('ìì£¼ ë°œì£¼ ëª©ë¡ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('ìì£¼ ë°œì£¼ ìƒí’ˆ ê°±ì‹  ì‹¤íŒ¨: ' + error);
    })
    .refreshFrequentItemsCache();
}

function displayFrequentItems(items) {
  const container = document.getElementById('frequent-list');
  
  if (!container) {
    console.error('frequent-list ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!items || items.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“Š</div>
        <h3>ìì£¼ ë°œì£¼í•˜ëŠ” ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p>ìµœê·¼ 3ê°œì›”ê°„ 3íšŒ ì´ìƒ ë°œì£¼í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    `;
    updateFrequentStats(0, 0, 0);
    return;
  }
  
  const today = new Date();
  const totalItems = items.length;
  
  const needOrderItems = items.filter(item => {
    if (!item.lastOrder) return true;
    const lastOrderDate = new Date(item.lastOrder);
    const daysSinceLastOrder = Math.floor((today - lastOrderDate) / (1000 * 60 * 60 * 24));
    return daysSinceLastOrder > 14;
  }).length;
  
  const thisMonthItems = items.filter(item => {
    if (!item.lastOrder) return false;
    const lastOrderDate = new Date(item.lastOrder);
    return lastOrderDate.getMonth() === today.getMonth() && 
           lastOrderDate.getFullYear() === today.getFullYear();
  }).length;
  
  updateFrequentStats(totalItems, needOrderItems, thisMonthItems);
  
  let html = '';
  
  items.forEach((item, index) => {
    let daysSinceLastOrder = 0;
    let statusClass = '';
    let statusIcon = '';
    
    if (item.lastOrder) {
      const lastOrderDate = new Date(item.lastOrder);
      daysSinceLastOrder = Math.floor((today - lastOrderDate) / (1000 * 60 * 60 * 24));
      
      if (daysSinceLastOrder > 30) {
        statusClass = 'need-urgent';
        statusIcon = 'ğŸ”´';
      } else if (daysSinceLastOrder > 14) {
        statusClass = 'need-check';
        statusIcon = 'ğŸŸ¡';
      } else {
        statusClass = 'ok';
        statusIcon = 'ğŸŸ¢';
      }
    } else {
      statusClass = 'need-urgent';
      statusIcon = 'ğŸ”´';
    }
    
    html += `
      <div class="frequent-simple-item ${statusClass}">
        <div class="item-number">${index + 1}</div>
        
        <div class="item-main">
          <div class="item-title">
            <span class="item-status">${statusIcon}</span>
            <span class="item-name">${item.productName}</span>
            ${item.option ? `<span class="item-option">${item.option}</span>` : ''}
          </div>
          
          <div class="item-stats">
            <span class="stat">ë°œì£¼ ${item.orderCount}íšŒ</span>
            <span class="stat">í‰ê·  ${item.avgQuantity}ê°œ</span>
            <span class="stat">ì£¼ê¸° ${item.avgCycle}</span>
            <span class="stat last-order">${daysSinceLastOrder}ì¼ ì „</span>
          </div>
        </div>
        
        <div class="item-action">
          <input type="number" 
                 id="qty-${item.barcode}" 
                 class="quick-qty-input" 
                 value="${item.avgQuantity}"
                 min="1">
          <button class="btn btn-primary btn-sm" 
                  onclick="quickAddFromFrequent('${item.barcode}')">
            ë°œì£¼ ì¶”ê°€
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function updateFrequentStats(total, needOrder, thisMonth) {
  const totalEl = document.getElementById('total-frequent');
  const needOrderEl = document.getElementById('need-order');
  const thisMonthEl = document.getElementById('this-month');
  
  if (totalEl) totalEl.textContent = total;
  if (needOrderEl) needOrderEl.textContent = needOrder;
  if (thisMonthEl) thisMonthEl.textContent = thisMonth;
}

function quickAddFromFrequent(barcode) {
  if (!AppState.currentOrderInfo) {
    if (confirm('ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      showCreateOrderModal();
    }
    return;
  }
  
  const qtyInput = document.getElementById(`qty-${barcode}`);
  if (!qtyInput) {
    showError('ìˆ˜ëŸ‰ ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  const quantity = parseInt(qtyInput.value) || 1;
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(product) {
      hideLoading();
      
      if (product) {
        const existingItem = AppState.orderItems.find(item => 
          item.barcode === barcode && item.status !== 'í™•ì •'
        );
        
        if (existingItem) {
          existingItem.quantity += quantity;
          showQuickSuccess(`ìˆ˜ëŸ‰ì´ ${existingItem.quantity}ê°œë¡œ ì¦ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
          const newItem = {
            ...product,
            quantity: 1,
            priority: 3,  // ê¸°ë³¸ê°’ 3 (ë‚®ìŒ/ì—¬ìœ ìˆìŒ)
            comment: '',
            status: 'ëŒ€ê¸°',
            id: Date.now() + Math.random(),
            confirmedAt: null,
            stockAvailable: 'ë¯¸í™•ì¸'
          };
          
          AppState.orderItems.push(newItem);
          showQuickSuccess(`${product.name} ${quantity}ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        
        updateOrderList();
        scheduleAutoSave();
        
        const btn = event.target;
        if (btn) {
          const originalText = btn.textContent;
          btn.textContent = 'ì¶”ê°€ë¨';
          btn.classList.add('added');
          setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('added');
          }, 2000);
        }
      } else {
        showError('ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('ìƒí’ˆ ì¶”ê°€ ì‹¤íŒ¨: ' + error);
    })
    .getProductDetails(barcode);
}

// ===== 27. ì œí’ˆ ì´ìŠˆì‚¬í•­ ê¸°ëŠ¥ =====
function openProductIssueModal(barcode = null) {
  let product = null;
  if (barcode) {
    product = AppState.products.find(p => p.barcode === barcode);
  }
  
  const modalContent = `
    <h3>${product ? 'ì œí’ˆ ì´ìŠˆì‚¬í•­ ìˆ˜ì •' : 'ì œí’ˆ ì´ìŠˆì‚¬í•­ ì¶”ê°€'}</h3>
    <div class="issue-form">
      ${!product ? `
        <div class="form-group">
          <label>ì œí’ˆ ê²€ìƒ‰</label>
          <div class="product-search-wrapper">
            <input type="text" 
                   id="issue-product-search" 
                   class="form-input" 
                   placeholder="ìƒí’ˆëª… ë˜ëŠ” ë°”ì½”ë“œë¡œ ê²€ìƒ‰..."
                   autocomplete="off">
            <div id="issue-search-results" class="issue-search-results"></div>
          </div>
          <input type="hidden" id="selected-barcode" value="">
          <div id="selected-product-info" class="selected-product-info" style="display:none;"></div>
        </div>
      ` : `
        <div class="form-group">
          <label>ìƒí’ˆì •ë³´</label>
          <div class="product-info-display">
            <strong>${product.name}</strong><br>
            <span class="text-muted">${product.barcode} | ${product.supplierName || ''}</span>
          </div>
        </div>
      `}
      
      <div class="form-group">
        <label>ë©”ëª¨ (ìƒíƒœ)</label>
        <select id="issue-memo" class="form-input">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="í’ˆì ˆ" ${product && AppState.productIssues[product.barcode]?.memo === 'í’ˆì ˆ' ? 'selected' : ''}>í’ˆì ˆ</option>
          <option value="ì˜¤ë”ì¤‘" ${product && AppState.productIssues[product.barcode]?.memo === 'ì˜¤ë”ì¤‘' ? 'selected' : ''}>ì˜¤ë”ì¤‘</option>
          <option value="ê¸°íƒ€" ${product && AppState.productIssues[product.barcode]?.memo === 'ê¸°íƒ€' ? 'selected' : ''}>ê¸°íƒ€</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>ë¹„ê³  (ìƒì„¸ì •ë³´)</label>
        <textarea id="issue-remarks" class="form-input" rows="3" placeholder="ìƒì„¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">${product && AppState.productIssues[product.barcode]?.remarks || ''}</textarea>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="saveProductIssue('${barcode || ''}')">ì €ì¥</button>
        ${product && AppState.productIssues[product.barcode] ? 
          `<button class="btn btn-danger" onclick="deleteProductIssue('${barcode}')">ì‚­ì œ</button>` : 
          ''
        }
        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
      </div>
    </div>
  `;
  
  showModal(modalContent);
  
  // ê²€ìƒ‰ ì…ë ¥ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  if (!product) {
    setTimeout(() => {
      const searchInput = document.getElementById('issue-product-search');
      if (searchInput) {
        searchInput.addEventListener('input', function(e) {
          searchProductsForIssue(e.target.value);
        });
        searchInput.focus();
      }
    }, 100);
  }
}

function searchProductsForIssue(query) {
  const resultsContainer = document.getElementById('issue-search-results');
  
  if (!query || query.trim().length < 2) {
    resultsContainer.style.display = 'none';
    resultsContainer.innerHTML = '';
    return;
  }
  
  // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
  if (AppState.timers.issue) {
    clearTimeout(AppState.timers.issue);
  }
  
  const searchLower = query.toLowerCase().trim();
  
  // ë¡œì»¬ ê²€ìƒ‰
  const localResults = AppState.products.filter(product => {
    if (!product) return false;
    
    const barcode = (product.barcode || '').toLowerCase();
    const name = (product.name || '').toLowerCase();
    const option = (product.option || '').toLowerCase();
    const searchText = product.searchText || `${barcode} ${name} ${option}`;
    
    return searchText.includes(searchLower) || 
           barcode.includes(searchLower) ||
           name.includes(searchLower) ||
           option.includes(searchLower);
  }).slice(0, 10);
  
  // ê²°ê³¼ í‘œì‹œ
  if (localResults.length > 0) {
    displayIssueSearchResults(localResults, false);
  } else {
    resultsContainer.innerHTML = '<div class="searching-message">ê²€ìƒ‰ ì¤‘...</div>';
    resultsContainer.style.display = 'block';
  }
  
  // ì„œë²„ ê²€ìƒ‰ (ë””ë°”ìš´ìŠ¤)
  if (localResults.length < 5) {
    AppState.timers.issue = setTimeout(() => {
      searchAllProductsForIssue(query, localResults);
    }, 500);
  }
}

function searchAllProductsForIssue(query, existingResults = []) {
  google.script.run
    .withSuccessHandler(function(serverResults) {
      if (!serverResults || serverResults.length === 0) {
        if (existingResults.length === 0) {
          const container = document.getElementById('issue-search-results');
          container.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        }
        return;
      }
      
      const existingBarcodes = new Set(existingResults.map(p => p.barcode));
      const newResults = serverResults.filter(p => !existingBarcodes.has(p.barcode));
      const combinedResults = [...existingResults, ...newResults].slice(0, 15);
      displayIssueSearchResults(combinedResults, true);
    })
    .withFailureHandler(function(error) {
      console.error('ì „ì²´ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
      if (existingResults.length === 0) {
        const container = document.getElementById('issue-search-results');
        container.innerHTML = '<div class="no-results">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
      }
    })
    .searchAllProducts(query, 10);
}

function displayIssueSearchResults(results, showSource = false) {
  const container = document.getElementById('issue-search-results');
  
  if (!container) {
    console.error('issue-search-results ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (results.length === 0) {
    container.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    container.style.display = 'block';
    return;
  }
  
  container.innerHTML = results.map(product => {
    if (!product) return '';
    
    const barcode = product.barcode || '';
    const name = product.name || 'ì´ë¦„ ì—†ìŒ';
    const option = product.option || '';
    const supplier = product.supplierName || product.supplier || '';
    
    const hasIssue = AppState.productIssues[barcode] || 
                     (product.issueMemo || product.issueRemarks);
    
    const sourceTag = showSource && product.isServerResult ? 
      '<span class="source-tag">ì „ì²´</span>' : 
      '<span class="source-tag cached">ìºì‹œ</span>';
    
    return `
      <div class="issue-search-item ${hasIssue ? 'has-issue' : ''}" 
           onclick="selectProductForIssue('${barcode}')"
           data-barcode="${barcode}">
        <div class="search-item-header">
          <div class="search-item-name">${name}</div>
          ${hasIssue ? '<span class="has-issue-badge">âš ï¸ ì´ìŠˆ</span>' : ''}
        </div>
        <div class="search-item-details">
          ${option ? `${option} | ` : ''}
          ${barcode} 
          ${supplier ? `| ${supplier}` : ''}
          ${showSource ? sourceTag : ''}
        </div>
      </div>
    `;
  }).filter(html => html).join('');
  
  container.style.display = 'block';
}

function selectProductForIssue(barcode) {
  let product = AppState.products.find(p => p.barcode === barcode);
  
  if (!product) {
    showSaveIndicator('loading');
    
    google.script.run
      .withSuccessHandler(function(details) {
        showSaveIndicator('hide');
        
        if (details) {
          displaySelectedProduct(details, barcode);
        } else {
          showError('ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      })
      .withFailureHandler(function(error) {
        showSaveIndicator('hide');
        showError('ìƒí’ˆ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + error);
      })
      .getProductDetails(barcode);
  } else {
    displaySelectedProduct(product, barcode);
  }
}

function displaySelectedProduct(product, barcode) {
  document.getElementById('selected-barcode').value = barcode;
  document.getElementById('issue-search-results').style.display = 'none';
  document.getElementById('issue-product-search').value = '';
  
  const infoContainer = document.getElementById('selected-product-info');
  infoContainer.innerHTML = `
    <div class="selected-product">
      <strong>${product.name}</strong><br>
      <span class="text-muted">${product.barcode} | ${product.supplierName || ''}</span>
      <button class="btn-sm btn-secondary" onclick="resetProductSelection()">ë‹¤ì‹œ ì„ íƒ</button>
    </div>
  `;
  infoContainer.style.display = 'block';
  
  if (AppState.productIssues[barcode]) {
    document.getElementById('issue-memo').value = AppState.productIssues[barcode].memo || '';
    document.getElementById('issue-remarks').value = AppState.productIssues[barcode].remarks || '';
  }
}

function resetProductSelection() {
  document.getElementById('selected-barcode').value = '';
  document.getElementById('selected-product-info').style.display = 'none';
  document.getElementById('issue-product-search').value = '';
  document.getElementById('issue-memo').value = '';
  document.getElementById('issue-remarks').value = '';
}

function saveProductIssue(barcode) {
  let targetBarcode = barcode;
  let product = null;
  
  if (!barcode) {
    targetBarcode = document.getElementById('selected-barcode').value;
    if (!targetBarcode) {
      showError('ì œí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    product = AppState.products.find(p => p.barcode === targetBarcode);
  } else {
    product = AppState.products.find(p => p.barcode === targetBarcode);
  }
  
  const memo = document.getElementById('issue-memo').value;
  const remarks = document.getElementById('issue-remarks').value.trim();
  
  if (!memo && !remarks) {
    showError('ë©”ëª¨ ë˜ëŠ” ë¹„ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  showSaveIndicator('saving');
  
  const issueData = {
    barcode: targetBarcode,
    productName: product?.name || '',
    option: product?.option || '',
    supplierName: product?.supplierName || '',
    memo: memo,
    remarks: remarks
  };
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result.success) {
        AppState.productIssues[targetBarcode] = {
          memo: memo,
          remarks: remarks
        };
        
        if (product) {
          product.issueMemo = memo;
          product.issueRemarks = remarks;
        }
        
        const searchInput = document.getElementById('search-input').value;
        if (searchInput) {
          performSearch();
        }
        
        closeModal();
        showQuickSuccess(result.message);
      } else {
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì €ì¥ ì‹¤íŒ¨: ' + error);
    })
    .updateProductIssue(issueData);
}

function deleteProductIssue(barcode) {
  if (!confirm('ì •ë§ ì´ìŠˆì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  showSaveIndicator('saving');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result.success) {
        delete AppState.productIssues[barcode];
        
        const product = AppState.products.find(p => p.barcode === barcode);
        if (product) {
          delete product.issueMemo;
          delete product.issueRemarks;
        }
        
        const searchInput = document.getElementById('search-input').value;
        if (searchInput) {
          performSearch();
        }
        
        closeModal();
        showQuickSuccess(result.message);
      } else {
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì‚­ì œ ì‹¤íŒ¨: ' + error);
    })
    .deleteProductIssue(barcode);
}

// ===== 28. ì•ˆì „ì¬ê³  ê¸°ëŠ¥ =====
function loadSafetyStockTab() {
  const container = document.getElementById('safety-stock-list');
  
  if (container.dataset.loading === 'true') {
    return;
  }
  
  if (cache.safetyStockCache && cache.safetyStockCacheTime) {
    const now = new Date();
    const cacheAge = (now - cache.safetyStockCacheTime) / 1000 / 60;
    
    if (cacheAge < 5 && cache.safetyStockCache.length > 0) {
      displaySafetyStockList(cache.safetyStockCache);
      return;
    }
  }
  
  container.dataset.loading = 'true';
  container.innerHTML = `
    <div class="loading-container">
      <div class="loading-spinner-small"></div>
      <p>ì•ˆì „ì¬ê³  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  `;
  
  google.script.run
    .withSuccessHandler(function(list) {
      container.dataset.loading = 'false';
      
      const safeList = list || [];
      cache.safetyStockCache = safeList;
      cache.safetyStockCacheTime = new Date();
      
      displaySafetyStockList(safeList);
      AppState.safetyStockCache = safeList;
    })
    .withFailureHandler(function(error) {
      container.dataset.loading = 'false';
      container.innerHTML = `
        <div class="error-state">
          <div class="error-icon">âŒ</div>
          <h3>ë¡œë“œ ì‹¤íŒ¨</h3>
          <p>${error}</p>
          <button class="btn btn-primary" onclick="loadSafetyStockTab()">ë‹¤ì‹œ ì‹œë„</button>
        </div>
      `;
    })
    .getSafetyStockList();
}

function displaySafetyStockList(list) {
  const container = document.getElementById('safety-stock-list');
  
  if (!list || !Array.isArray(list)) {
    list = [];
  }
  
  if (list.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“¦</div>
        <h3>ì•ˆì „ì¬ê³ ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h3>
        <p>ìƒí’ˆë³„ ì•ˆì „ì¬ê³ ë¥¼ ì„¤ì •í•˜ì—¬ ì¬ê³  ë¶€ì¡±ì„ ì˜ˆë°©í•˜ì„¸ìš”</p>
        <button class="btn btn-primary" onclick="showAddSafetyStockModal()">
          ì²« ì•ˆì „ì¬ê³  ì¶”ê°€í•˜ê¸°
        </button>
      </div>
    `;
    return;
  }
  
  const totalItems = list.length;
  const percentageItems = list.filter(item => item.type === 'percentage').length;
  const quantityItems = list.filter(item => item.type === 'quantity').length;
  
  container.innerHTML = `
    <div class="safety-stock-stats">
      <div class="stat-card">
        <div class="stat-value">${totalItems}</div>
        <div class="stat-label">ì „ì²´ ì„¤ì •</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${quantityItems}</div>
        <div class="stat-label">ìˆ˜ëŸ‰ ê¸°ì¤€</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${percentageItems}</div>
        <div class="stat-label">í¼ì„¼íŠ¸ ê¸°ì¤€</div>
      </div>
    </div>
    
    <div class="safety-stock-grid">
      ${list.map(item => {
        const typeIcon = item.type === 'percentage' ? '%' : 'ê°œ';
        const typeClass = item.type === 'percentage' ? 'type-percent' : 'type-quantity';
        
        return `
          <div class="safety-stock-card">
            <div class="card-header">
              <h4>${item.productName}</h4>
              <span class="safety-type-badge ${typeClass}">
                ${item.value}${typeIcon}
              </span>
            </div>
            
            <div class="card-body">
              <div class="product-details">
                <span class="barcode">${item.barcode}</span>
                ${item.option ? `<span class="option">${item.option}</span>` : ''}
              </div>
              
              <div class="safety-info">
                <div class="info-item">
                  <span class="info-label">ì•ˆì „ì¬ê³ :</span>
                  <span class="info-value">${item.type === 'percentage' ? 'í˜„ì¬ê³ ì˜ ' : ''}${item.value}${typeIcon}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ë“±ë¡ì¼:</span>
                  <span class="info-value">${formatDate(item.registeredAt)}</span>
                </div>
              </div>
            </div>
            
            <div class="card-actions">
              <button class="btn-icon" onclick="editSafetyStock('${item.barcode}')" title="ìˆ˜ì •">
                <span>âœï¸</span>
              </button>
              <button class="btn-icon danger" onclick="deleteSafetyStock('${item.barcode}')" title="ì‚­ì œ">
                <span>ğŸ—‘ï¸</span>
              </button>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function formatDate(dateValue) {
  if (!dateValue) return '';
  
  const date = dateValue instanceof Date ? dateValue : new Date(dateValue);
  if (isNaN(date.getTime())) return '';
  
  return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
}

function searchSafetyStockItems(query) {
  if (!AppState.safetyStockCache || !Array.isArray(AppState.safetyStockCache)) {
    AppState.safetyStockCache = [];
  }
  
  if (!query || query.trim().length < 1) {
    displaySafetyStockList(AppState.safetyStockCache);
    return;
  }
  
  const searchLower = query.toLowerCase();
  const filtered = AppState.safetyStockCache.filter(item => {
    if (!item) return false;
    
    const barcode = (item.barcode || '').toLowerCase();
    const productName = (item.productName || '').toLowerCase();
    const option = (item.option || '').toLowerCase();
    
    return barcode.includes(searchLower) ||
           productName.includes(searchLower) ||
           option.includes(searchLower);
  });
  
  displaySafetyStockList(filtered);
  
  if (filtered.length === 0) {
    const container = document.getElementById('safety-stock-list');
    container.innerHTML = `
      <div class="no-search-results">
        <div class="no-results-icon">ğŸ”</div>
        <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
        <p>"${query}"ì— ëŒ€í•œ ì•ˆì „ì¬ê³  ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
        <button class="btn btn-secondary" onclick="document.getElementById('safety-stock-search').value=''; loadSafetyStockTab();">
          ì „ì²´ ë³´ê¸°
        </button>
      </div>
    `;
  }
}

function showAddSafetyStockModal() {
  resetSafetyStockModal();
  document.getElementById('safety-stock-modal').style.display = 'block';
}

function editSafetyStock(barcode) {
  showSaveIndicator('loading');
  
  google.script.run
    .withSuccessHandler(function(item) {
      showSaveIndicator('hide');
      
      if (!item) {
        showError('ì•ˆì „ì¬ê³  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      showAddSafetyStockModal();
      
      const selectedProduct = document.getElementById('selected-safety-product');
      selectedProduct.innerHTML = `
        <div class="selected-product">
          <strong>${item.productName}</strong><br>
          <span class="text-muted">${item.barcode} | ${item.option || ''}</span>
        </div>
      `;
      selectedProduct.style.display = 'block';
      selectedProduct.dataset.barcode = item.barcode;
      selectedProduct.dataset.productName = item.productName;
      selectedProduct.dataset.option = item.option || '';
      
      document.getElementById('safety-product-search').value = '';
      document.getElementById('safety-search-results').style.display = 'none';
      
      document.querySelector(`input[name="safetyType"][value="${item.type}"]`).checked = true;
      document.getElementById('safety-value').value = item.value;
      toggleSafetyInput();
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì•ˆì „ì¬ê³  ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + error);
    })
    .getSafetyStockForBarcode(barcode);
}

function toggleSafetyInput() {
  const type = document.querySelector('input[name="safetyType"]:checked').value;
  const unit = document.getElementById('safety-unit');
  const input = document.getElementById('safety-value');
  
  if (type === 'percentage') {
    unit.textContent = '%';
    input.max = 100;
    input.placeholder = '0-100';
  } else {
    unit.textContent = 'ê°œ';
    input.max = '';
    input.placeholder = 'ìˆ˜ëŸ‰ ì…ë ¥';
  }
}

function searchProductsForSafety(query) {
  if (!query || query.trim().length < 2) {
    document.getElementById('safety-search-results').style.display = 'none';
    return;
  }
  
  const searchLower = query.toLowerCase();
  
  let results = [];
  
  if (AppState.products && AppState.products.length > 0) {
    results = AppState.products.filter(product => {
      if (!product) return false;
      
      if (product.searchText && product.searchText.includes(searchLower)) {
        return true;
      }
      
      const barcode = product.barcode || '';
      const name = product.name || '';
      const option = product.option || '';
      
      return barcode.toLowerCase().includes(searchLower) ||
             name.toLowerCase().includes(searchLower) ||
             option.toLowerCase().includes(searchLower);
    }).slice(0, 10);
  }
  
  if (results.length < 5) {
    const container = document.getElementById('safety-search-results');
    container.innerHTML = results.length > 0 ? 
      results.map(p => createSafetySearchItem(p)).join('') + 
      '<div class="searching-more">ì¶”ê°€ ê²€ìƒ‰ ì¤‘...</div>' :
      '<div class="searching-message">ê²€ìƒ‰ ì¤‘...</div>';
    container.style.display = 'block';
    
    clearTimeout(AppState.timers.safetySearch);
    AppState.timers.safetySearch = setTimeout(() => {
      google.script.run
        .withSuccessHandler(function(serverResults) {
          if (!serverResults || !Array.isArray(serverResults)) {
            if (results.length > 0) {
              displaySafetySearchResults(results);
            }
            return;
          }
          
          const existingBarcodes = new Set(results.map(p => p.barcode));
          const newResults = serverResults.filter(p => {
            return p && p.barcode && !existingBarcodes.has(p.barcode);
          });
          
          const combinedResults = [...results, ...newResults].slice(0, 15);
          displaySafetySearchResults(combinedResults);
        })
        .withFailureHandler(function(error) {
          console.error('ì„œë²„ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
          if (results.length > 0) {
            displaySafetySearchResults(results);
          } else {
            container.innerHTML = '<div class="no-results">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
          }
        })
        .searchAllProducts(query, 10);
    }, 300);
  } else {
    displaySafetySearchResults(results);
  }
}

function createSafetySearchItem(product) {
  if (!product) return '';
  
  const name = product.name || 'ì´ë¦„ ì—†ìŒ';
  const option = product.option || '';
  const barcode = product.barcode || '';
  
  return `
    <div class="safety-search-item" onclick="selectProductForSafety('${barcode}')">
      <div>${name}</div>
      <div class="search-item-details">
        ${option ? option + ' | ' : ''}${barcode}
      </div>
    </div>
  `;
}

function selectProductForSafety(barcode) {
  if (!barcode) {
    showError('ë°”ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  const product = AppState.products.find(p => p && p.barcode === barcode);
  
  if (!product) {
    showSaveIndicator('loading');
    
    google.script.run
      .withSuccessHandler(function(details) {
        showSaveIndicator('hide');
        
        if (details) {
          displaySelectedSafetyProduct(details);
        } else {
          showError('ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      })
      .withFailureHandler(function(error) {
        showSaveIndicator('hide');
        showError('ìƒí’ˆ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + error);
      })
      .getProductDetails(barcode);
  } else {
    displaySelectedSafetyProduct(product);
  }
}

function displaySelectedSafetyProduct(product) {
  const name = product.name || 'ì´ë¦„ ì—†ìŒ';
  const barcode = product.barcode || '';
  const option = product.option || '';
  
  document.getElementById('selected-safety-product').innerHTML = `
    <div class="selected-product">
      <strong>${name}</strong><br>
      <span class="text-muted">${barcode} | ${option}</span>
    </div>
  `;
  document.getElementById('selected-safety-product').style.display = 'block';
  document.getElementById('selected-safety-product').dataset.barcode = barcode;
  document.getElementById('selected-safety-product').dataset.productName = name;
  document.getElementById('selected-safety-product').dataset.option = option;
  
  document.getElementById('safety-product-search').value = '';
  document.getElementById('safety-search-results').style.display = 'none';
}

function saveSafetyStock() {
  const selectedProduct = document.getElementById('selected-safety-product');
  if (!selectedProduct.dataset.barcode) {
    showError('ì œí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const type = document.querySelector('input[name="safetyType"]:checked').value;
  const value = document.getElementById('safety-value').value;
  
  if (!value || value < 0) {
    showError('ì•ˆì „ì¬ê³  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (type === 'percentage' && value > 100) {
    showError('í¼ì„¼íŠ¸ëŠ” 100 ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const safetyStockData = {
    barcode: selectedProduct.dataset.barcode,
    productName: selectedProduct.dataset.productName,
    option: selectedProduct.dataset.option,
    type: type,
    value: Number(value)
  };
  
  showSaveIndicator('saving');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result.success) {
        closeModal('safety-stock-modal');
        showQuickSuccess(result.message);
        loadSafetyStockTab();
      } else {
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì €ì¥ ì‹¤íŒ¨: ' + error);
    })
    .saveSafetyStock(safetyStockData);
}

function deleteSafetyStock(barcode) {
  if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  showSaveIndicator('loading');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result.success) {
        showQuickSuccess(result.message);
        loadSafetyStockTab();
      } else {
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì‚­ì œ ì‹¤íŒ¨: ' + error);
    })
    .deleteSafetyStock(barcode);
}

function resetSafetyStockModal() {
  document.getElementById('safety-product-search').value = '';
  document.getElementById('safety-search-results').style.display = 'none';
  document.getElementById('selected-safety-product').style.display = 'none';
  document.getElementById('selected-safety-product').innerHTML = '';
  document.querySelector('input[value="quantity"]').checked = true;
  document.getElementById('safety-value').value = '';
  toggleSafetyInput();
}

// ===== 29. CSV ì—…ë¡œë“œ/ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ =====
function showStockUploadModal() {
  if (!AppState.currentOrderInfo) {
    showError('ë¨¼ì € ë°œì£¼ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  document.getElementById('stock-upload-modal').style.display = 'block';
  setupDropZone();
}

function setupDropZone() {
  const dropZone = document.getElementById('csv-drop-zone');
  const fileInput = document.getElementById('csv-file-input');
  
  if (dropZone.dataset.initialized === 'true') return;
  dropZone.dataset.initialized = 'true';
  
  dropZone.addEventListener('click', () => fileInput.click());
  
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('drag-over');
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'text/csv') {
      handleCSVFile(file);
    } else {
      showError('CSV íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    }
  });
  
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      handleCSVFile(file);
    }
  });
}

function handleCSVFile(file) {
  const reader = new FileReader();
  
  reader.onload = (e) => {
    AppState.uploadedCSVContent = e.target.result;
    
    // CSV ë¯¸ë¦¬ë³´ê¸°
    const lines = e.target.result.split(/\r?\n/);
    console.log('ì—…ë¡œë“œëœ CSV ë¼ì¸ ìˆ˜:', lines.length);
    console.log('ì²« 5ì¤„:', lines.slice(0, 5));
    
    const dropZone = document.getElementById('csv-drop-zone');
    dropZone.innerHTML = `
      <div class="upload-success">
        <span class="success-icon">âœ…</span>
        <p>${file.name}</p>
        <small>${(file.size / 1024).toFixed(2)} KB</small>
      </div>
    `;
    
    document.getElementById('process-csv-btn').disabled = false;
  };
  
  reader.onerror = (e) => {
    console.error('íŒŒì¼ ì½ê¸° ì—ëŸ¬:', e);
    showError('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  };
  
  // UTF-8ë¡œ ì½ê¸° (í•œê¸€ ì§€ì›)
  reader.readAsText(file, 'UTF-8');
}

function processCSVUpload() {
  if (!AppState.uploadedCSVContent) {
    showError('CSV íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const updateType = document.querySelector('input[name="updateType"]:checked').value;
  
  // ëª¨ë‹¬ ë‹«ê³  ë¡œë”© í‘œì‹œ
  closeModal('stock-upload-modal');
  showLoading('ì¬ê³  ë°ì´í„° ì²˜ë¦¬ ì¤‘...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        showQuickSuccess(`${result.itemCount}ê°œ ì¬ê³  ì •ë³´ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
        // ì¬ê³  ë°ì´í„° ë¡œë“œ í›„ ë°œì£¼ í•­ëª© ì—…ë°ì´íŠ¸
        updateLoadingMessage('ì¬ê³  ì •ë³´ë¥¼ ì ìš©í•˜ëŠ” ì¤‘...');
        
        // ë°œì£¼ í•­ëª©ì˜ ì¬ê³  ìƒíƒœ ì—…ë°ì´íŠ¸
        updateOrderItemsWithStockBatch(updateType);
      } else {
        hideLoading();
        showError('CSV ì²˜ë¦¬ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error);
    })
    .processStockCSV(AppState.uploadedCSVContent, updateType);
}

// ì„œë²„ì—ì„œ ì¬ê³  ë°ì´í„° ë¡œë“œ
async function loadStockDataFromServer() {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.data) {
          AppState.stockData = result.data;
          AppState.stockDataTimestamp = result.updatedAt;
          console.log('ì¬ê³  ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', Object.keys(result.data).length);
          resolve(result);
        } else {
          resolve(null);
        }
      })
      .withFailureHandler(reject)
      .loadSavedStockData();
  });
}

function updateOrderItemsWithStockBatch(updateType) {
  const itemsToUpdate = AppState.orderItems.filter(item => {
    // ë‚´ë³´ë‚´ê¸°ëœ í•­ëª©ì€ ì œì™¸
    if (item.exportedAt || item.exportStatus) return false;
    
    if (updateType === 'confirmed' && item.status !== 'í™•ì •') return false;
    if (updateType === 'unconfirmed' && item.status === 'í™•ì •') return false;
    return true;
  });
  
  if (itemsToUpdate.length === 0) {
    hideLoading();
    showInfo('ì—…ë°ì´íŠ¸í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  let processed = 0;
  updateLoadingMessage(`ì¬ê³  ì •ë³´ ì ìš© ì¤‘... (0/${itemsToUpdate.length})`);
  
  // ì„œë²„ì— ì¼ê´„ ì—…ë°ì´íŠ¸ ìš”ì²­
  google.script.run
    .withSuccessHandler(function(results) {
      // ê²°ê³¼ë¥¼ ë¡œì»¬ ë°ì´í„°ì— ë°˜ì˜
      results.forEach(result => {
        const item = AppState.orderItems.find(i => i.id === result.id);
        if (item) {
          item.stockAvailable = result.stockStatus.message;
          item.stockStatus = result.stockStatus.status;
          item.csvConfirmed = true; // CSV í™•ì¸ í”Œë˜ê·¸ ì¶”ê°€
        }
      });
      
      // UI ì—…ë°ì´íŠ¸
      updateOrderList();
      hideLoading();
      showQuickSuccess(`${results.length}ê°œ í•­ëª©ì˜ ì¬ê³ ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      
      // ìë™ ì €ì¥
      scheduleAutoSave();
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('ì¬ê³  ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error);
    })
    .updateOrderItemsStock(itemsToUpdate, updateType);
}

function updateOrderItemsWithStockFromServer(updateType) {
  const itemsToUpdate = AppState.orderItems.filter(item => {
    if (updateType === 'confirmed' && item.status !== 'í™•ì •') return false;
    if (updateType === 'unconfirmed' && item.status === 'í™•ì •') return false;
    return true;
  });
  
  if (itemsToUpdate.length === 0) {
    showInfo('ì—…ë°ì´íŠ¸í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  showProgress(`ì¬ê³  ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘... (0/${itemsToUpdate.length})`);
  let processed = 0;
  
  const BATCH_SIZE = 10;
  const batches = [];
  
  for (let i = 0; i < itemsToUpdate.length; i += BATCH_SIZE) {
    batches.push(itemsToUpdate.slice(i, i + BATCH_SIZE));
  }
  
  function processBatch(batchIndex) {
    if (batchIndex >= batches.length) {
      hideProgress();
      updateOrderList();
      scheduleAutoSave();
      return;
    }
    
    const batch = batches[batchIndex];
    const promises = batch.map(item => {
      return new Promise((resolve) => {
        google.script.run
          .withSuccessHandler(function(result) {
            item.stockAvailable = result.message;
            item.stockStatus = result.status;
            processed++;
            updateProgress(`ì¬ê³  ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘... (${processed}/${itemsToUpdate.length})`);
            resolve();
          })
          .withFailureHandler(function() {
            item.stockAvailable = 'í™•ì¸ ì‹¤íŒ¨';
            item.stockStatus = 'error';
            processed++;
            updateProgress(`ì¬ê³  ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘... (${processed}/${itemsToUpdate.length})`);
            resolve();
          })
          .calculateStockAvailability(item.barcode, item.quantity);
      });
    });
    
    Promise.all(promises).then(() => {
      processBatch(batchIndex + 1);
    });
  }
  
  processBatch(0);
}

function showProgress(message) {
  let progress = document.getElementById('progress-indicator');
  if (!progress) {
    progress = document.createElement('div');
    progress.id = 'progress-indicator';
    progress.className = 'progress-indicator';
    document.body.appendChild(progress);
  }
  progress.textContent = message;
  progress.style.display = 'block';
}

function updateProgress(message) {
  const progress = document.getElementById('progress-indicator');
  if (progress) {
    progress.textContent = message;
  }
}

function hideProgress() {
  const progress = document.getElementById('progress-indicator');
  if (progress) {
    progress.style.display = 'none';
  }
}

function showInfo(message) {
  const existingToast = document.querySelector('.toast-message');
  if (existingToast) existingToast.remove();
  
  const toast = document.createElement('div');
  toast.className = 'toast-message info show';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

// ===== 30. CSV ë‚´ë³´ë‚´ê¸° =====
function showExportModal() {
  if (!AppState.currentOrderInfo) {
    showError('ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (AppState.orderItems.length === 0) {
    showError('ë‚´ë³´ë‚¼ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  document.getElementById('export-csv-modal').style.display = 'block';
  
  const checkedCount = document.querySelectorAll('.order-checkbox:checked').length;
  
  if (checkedCount > 0) {
    document.querySelector('input[name="exportType"][value="selected"]').checked = true;
  } else {
    document.querySelector('input[name="exportType"][value="all"]').checked = true;
  }
  
  document.getElementById('exclude-exported').checked = true;
  
  updateExportPreview();
  loadExportHistory();
}

function updateExportPreview() {
  const exportType = document.querySelector('input[name="exportType"]:checked').value;
  validateExportItems(exportType);
}

function validateExportItems(exportType) {
  const validationContainer = document.getElementById('export-validation');
  const previewContainer = document.getElementById('export-preview-content');
  
  previewContainer.innerHTML = `
    <div class="export-loading">
      <div class="loading-spinner-small"></div>
      <p>ê²€ì¦ ì¤‘...</p>
    </div>
  `;
  
  let itemsToValidate = [];
  
  if (exportType === 'all') {
    itemsToValidate = AppState.orderItems;
  } else {
    const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
    
    checkedBoxes.forEach(checkbox => {
      const orderItem = checkbox.closest('.order-item');
      if (orderItem && orderItem.dataset.id) {
        const itemId = orderItem.dataset.id;
        const item = AppState.orderItems.find(i => String(i.id) === String(itemId));
        if (item) {
          itemsToValidate.push(item);
        }
      }
    });
  }
  
  if (itemsToValidate.length === 0) {
    validationContainer.innerHTML = `
      <div class="validation-error">
        <div class="validation-item">
          <span class="validation-icon">âŒ</span>
          <span>${exportType === 'selected' ? 'ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ë‚´ë³´ë‚¼ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'}</span>
        </div>
      </div>
    `;
    previewContainer.innerHTML = '<p style="text-align: center; color: #6c757d;">ë‚´ë³´ë‚¼ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    document.getElementById('proceed-export-btn').disabled = true;
    return;
  }
  
  const validation = performValidation(itemsToValidate);
  
  displayValidationResult(validation, validationContainer);
  displayExportPreview(validation, previewContainer);
  
  document.getElementById('proceed-export-btn').disabled = validation.exportableItems.length === 0;
}

function performValidation(items) {
  const excludeExported = document.getElementById('exclude-exported').checked;
  
  const result = {
    totalItems: items.length,
    confirmedItems: 0,
    unconfirmedItems: 0,
    withStockStatus: 0,
    withoutStockStatus: 0,
    exportableItems: [],
    excludedItems: [],
    alreadyExported: [],
    warnings: []
  };
  
  items.forEach(item => {
    // ì´ë¯¸ ë‚´ë³´ë‚¸ í•­ëª© ì²´í¬ë¥¼ ë¨¼ì € ìˆ˜í–‰
    if (item.exportedAt) {
      result.alreadyExported.push(item);
      
      if (excludeExported) {
        result.excludedItems.push({
          item: item,
          reason: 'ì´ë¯¸ ë‚´ë³´ë‚´ê¸°ë¨'
        });
        return; // ì´ í•­ëª©ì€ ì œì™¸í•˜ê³  ë‹¤ìŒìœ¼ë¡œ
      }
    }
    
    // í™•ì • ìƒíƒœ ì²´í¬
    if (item.status !== 'í™•ì •') {
      result.unconfirmedItems++;
      result.excludedItems.push({
        item: item,
        reason: 'ë¯¸í™•ì •'
      });
      return;
    }
    
    result.confirmedItems++;
    
    // ì¬ê³  ìƒíƒœ ì²´í¬
    if (!item.stockAvailable || item.stockAvailable === 'ë¯¸í™•ì¸') {
      result.withoutStockStatus++;
      result.excludedItems.push({
        item: item,
        reason: 'ì¬ê³  ë¯¸í™•ì¸'
      });
      return;
    }
    
    result.withStockStatus++;
    
    const stockStatus = String(item.stockAvailable).toLowerCase();
    
    if (stockStatus === 'í’ˆì ˆ' || stockStatus === 'ì˜¤ë”ì¤‘') {
      result.excludedItems.push({
        item: item,
        reason: stockStatus
      });
      return;
    }
    
    // ì¬ë‚´ë³´ë‚´ê¸° ê²½ê³  (ì´ë¯¸ ì œì™¸ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ)
    if (!excludeExported && item.exportedAt) {
      result.warnings.push({
        item: item,
        warning: 'ì¬ë‚´ë³´ë‚´ê¸°'
      });
    }
    
    // ë‚´ë³´ë‚¼ ìˆ˜ëŸ‰ ê³„ì‚°
    let exportQuantity = item.quantity;
    if (stockStatus !== 'ê°€ëŠ¥') {
      const match = stockStatus.match(/(\d+)ê°œ/);
      if (match) {
        exportQuantity = Math.min(parseInt(match[1]), item.quantity);
      }
    }
    
    result.exportableItems.push({
      ...item,
      exportQuantity: exportQuantity
    });
  });
  
  return result;
}

function displayValidationResult(validation, container) {
 let html = '';
 let validationClass = 'validation-success';
 
 const messages = [];
 
 if (validation.unconfirmedItems > 0) {
   messages.push({
     icon: 'âš ï¸',
     text: `${validation.unconfirmedItems}ê°œ í•­ëª©ì´ ë¯¸í™•ì • ìƒíƒœì…ë‹ˆë‹¤.`,
     type: 'warning'
   });
   validationClass = 'validation-warning';
 }
 
 if (validation.withoutStockStatus > 0) {
   messages.push({
     icon: 'âš ï¸',
     text: `${validation.withoutStockStatus}ê°œ í•­ëª©ì˜ ì¬ê³ ê°€ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`,
     type: 'warning'
   });
   validationClass = 'validation-warning';
 }
 
 if (validation.alreadyExported.length > 0) {
   messages.push({
     icon: 'âš ï¸',
     text: `${validation.alreadyExported.length}ê°œ í•­ëª©ì´ ì´ë¯¸ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.`,
     type: 'warning'
   });
 }
 
 if (validation.exportableItems.length === 0) {
   messages.push({
     icon: 'âŒ',
     text: 'ë‚´ë³´ë‚¼ ìˆ˜ ìˆëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.',
     type: 'error'
   });
   validationClass = 'validation-error';
 } else {
   messages.push({
     icon: 'âœ…',
     text: `${validation.exportableItems.length}ê°œ í•­ëª©ì„ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
     type: 'success'
   });
 }
 
 html = `
   <div class="${validationClass}">
     ${messages.map(msg => `
       <div class="validation-item">
         <span class="validation-icon">${msg.icon}</span>
         <span>${msg.text}</span>
       </div>
     `).join('')}
   </div>
 `;
 
 container.innerHTML = html;
}

function displayExportPreview(validation, container) {
  if (validation.exportableItems.length === 0) {
    // ì œì™¸ëœ í•­ëª©ë“¤ì˜ ì´ìœ ë¥¼ ì§‘ê³„
    let excludedReasons = {};
    validation.excludedItems.forEach(item => {
      if (!excludedReasons[item.reason]) {
        excludedReasons[item.reason] = 0;
      }
      excludedReasons[item.reason]++;
    });
    
    // ì œì™¸ ì´ìœ ë³„ í‘œì‹œ
    let reasonsHtml = Object.entries(excludedReasons).map(([reason, count]) => {
      let icon = 'âŒ';
      switch(reason) {
        case 'ë¯¸í™•ì •': icon = 'â¸ï¸'; break;
        case 'ì¬ê³  ë¯¸í™•ì¸': icon = 'â“'; break;
        case 'í’ˆì ˆ': icon = 'ğŸš«'; break;
        case 'ì˜¤ë”ì¤‘': icon = 'â³'; break;
        case 'ì´ë¯¸ ë‚´ë³´ë‚´ê¸°ë¨': icon = 'âœ…'; break;
      }
      return `<li>${icon} ${reason}: ${count}ê°œ</li>`;
    }).join('');
    
    container.innerHTML = `
      <div style="text-align: center; color: #6c757d;">
        <p style="font-size: 16px; font-weight: 500; color: #dc3545;">ë‚´ë³´ë‚¼ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        ${reasonsHtml ? `
          <div style="margin-top: 15px;">
            <p style="font-size: 14px; font-weight: 500; color: #495057;">ì œì™¸ëœ ì´ìœ :</p>
            <ul style="text-align: left; display: inline-block; font-size: 13px; list-style: none; padding: 0;">
              ${reasonsHtml}
            </ul>
          </div>
        ` : ''}
        <p style="font-size: 12px; margin-top: 15px; color: #868e96;">
          ${validation.alreadyExported.length > 0 ? 
            'ì´ë¯¸ ë‚´ë³´ë‚¸ í•­ëª©ì„ í¬í•¨í•˜ë ¤ë©´ "ì´ë¯¸ ë‚´ë³´ë‚¸ í•­ëª© ì œì™¸" ì²´í¬ë¥¼ í•´ì œí•˜ì„¸ìš”.' : 
            'í™•ì •ë˜ê³  ì¬ê³ ê°€ í™•ì¸ëœ í•­ëª©ë§Œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
          }
        </p>
      </div>
    `;
    return;
  }
  
  // ë‚´ë³´ë‚¼ í•­ëª©ì´ ìˆëŠ” ê²½ìš°
  let html = `
    <div style="margin-bottom: 10px; font-size: 14px;">
      <strong>ë‚´ë³´ë‚´ê¸° í•­ëª©: ${validation.exportableItems.length}ê°œ</strong>
      ${validation.warnings.length > 0 ? 
        `<span style="color: #ffc107; margin-left: 10px;">âš ï¸ ì¬ë‚´ë³´ë‚´ê¸° ${validation.warnings.length}ê°œ</span>` : 
        ''
      }
    </div>
    <table class="preview-table">
      <thead>
        <tr>
          <th>ë°”ì½”ë“œ</th>
          <th>ìƒí’ˆëª…</th>
          <th>ì˜µì…˜</th>
          <th>ìš”ì²­</th>
          <th>ì¶œê³ </th>
          <th>ìƒíƒœ</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  validation.exportableItems.forEach(item => {
    const isModified = item.exportQuantity !== item.quantity;
    const isReExport = item.exportedAt ? true : false;
    
    html += `
      <tr class="${isModified ? 'preview-modified' : ''} ${isReExport ? 'preview-reexport' : ''}">
        <td>${item.barcode}</td>
        <td>${item.name}</td>
        <td>${item.option || '-'}</td>
        <td>${item.quantity}</td>
        <td class="${isModified ? 'text-danger' : ''}">${item.exportQuantity}</td>
        <td>
          ${item.stockAvailable}
          ${isReExport ? '<span class="export-status-badge status-exported">ì¬ë‚´ë³´ë‚´ê¸°</span>' : ''}
        </td>
      </tr>
    `;
  });
  
  html += `
      </tbody>
    </table>
  `;
  
  // ì œì™¸ëœ í•­ëª©ì´ ìˆëŠ” ê²½ìš° ìš”ì•½ í‘œì‹œ
  if (validation.excludedItems.length > 0) {
    html += `
      <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 12px;">
        <strong>ì œì™¸ëœ í•­ëª©: ${validation.excludedItems.length}ê°œ</strong>
        <span style="color: #6c757d; margin-left: 10px;">
          (ë¯¸í™•ì • ${validation.unconfirmedItems}ê°œ, ì¬ê³ ë¯¸í™•ì¸ ${validation.withoutStockStatus}ê°œ${
            validation.alreadyExported.length > 0 ? `, ì´ë¯¸ ë‚´ë³´ëƒ„ ${validation.alreadyExported.length}ê°œ` : ''
          })
        </span>
      </div>
    `;
  }
  
  container.innerHTML = html;
}

function loadExportHistory() {
 const container = document.getElementById('export-history-content');
 
 container.innerHTML = '<div class="loading-spinner-small"></div>';
 
 google.script.run
   .withSuccessHandler(function(history) {
     displayExportHistory(history, container);
   })
   .withFailureHandler(function(error) {
     container.innerHTML = '<p style="color: #dc3545;">ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
   })
   .getExportHistory(AppState.currentOrderInfo.orderId);
}

function displayExportHistory(history, container) {
 if (!history || history.length === 0) {
   container.innerHTML = '<p style="text-align: center; color: #6c757d;">ë‚´ë³´ë‚´ê¸° ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
   return;
 }
 
 let html = '';
 
 history.forEach(record => {
   html += `
     <div class="history-item">
       <div>
         <div class="history-date">${formatDateTime(record.exportedAt)}</div>
         <div class="history-info">${record.exportedBy}</div>
       </div>
       <div>
         <span class="history-count">${record.itemCount}ê°œ</span>
       </div>
     </div>
   `;
 });
 
 container.innerHTML = html;
}

function formatDateTime(dateString) {
 const date = new Date(dateString);
 return date.toLocaleString('ko-KR', {
   year: 'numeric',
   month: '2-digit',
   day: '2-digit',
   hour: '2-digit',
   minute: '2-digit'
 });
}

function proceedExport() {
  const exportType = document.querySelector('input[name="exportType"]:checked').value;
  
  let itemsToExport = [];
  
  if (exportType === 'all') {
    itemsToExport = AppState.orderItems;
  } else {
    const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
    checkedBoxes.forEach(checkbox => {
      const orderItem = checkbox.closest('.order-item');
      if (orderItem && orderItem.dataset.id) {
        const itemId = orderItem.dataset.id;
        const item = AppState.orderItems.find(i => String(i.id) === String(itemId));
        if (item) itemsToExport.push(item);
      }
    });
  }
  
  if (itemsToExport.length === 0) {
    showError('ë‚´ë³´ë‚¼ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  const validation = performValidation(itemsToExport);
  
  if (validation.exportableItems.length === 0) {
    showError('ë‚´ë³´ë‚¼ ìˆ˜ ìˆëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ì¬ë‚´ë³´ë‚´ê¸° í™•ì¸
  const excludeExported = document.getElementById('exclude-exported').checked;
  if (!excludeExported && validation.alreadyExported.length > 0) {
    if (!confirm(`${validation.alreadyExported.length}ê°œ í•­ëª©ì´ ì´ë¯¸ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.\nê³„ì† í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }
  }
  
  showSaveIndicator('loading');
  document.getElementById('proceed-export-btn').disabled = true;
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result.success) {
        // CSV ë‹¤ìš´ë¡œë“œ
        downloadCSV(result.csvContent, result.filename);
        
        // ì¶œê³  íƒ­ ê°•ì œ ë¦¬í”„ë ˆì‹œ í”Œë˜ê·¸ ì„¤ì •
        sessionStorage.setItem('forceRefreshShipping', 'true');
        
        // ë‚´ë³´ë‚¸ í•­ëª©ë“¤ì˜ ë°”ì½”ë“œì™€ ì‹œê°„ ì €ì¥
        const exportedInfo = {};
        
        if (result.exportedItems && result.exportedItems.length > 0) {
          result.exportedItems.forEach(exported => {
            exportedInfo[exported.barcode] = exported.exportedAt;
            
            const item = AppState.orderItems.find(i => 
              i.barcode === exported.barcode || i.id === exported.id
            );
            if (item) {
              item.exportedAt = exported.exportedAt;
              item.exportStatus = `ë‚´ë³´ë‚´ê¸° ì™„ë£Œ (${new Date(exported.exportedAt).toLocaleString('ko-KR')})`;
            }
          });
          
          // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
          updateOrderList();
          updateExportButtonStatus();
          
          // ì„¸ì…˜ì— ë‚´ë³´ë‚´ê¸° ì •ë³´ ì €ì¥
          sessionStorage.setItem('lastExportInfo', JSON.stringify(exportedInfo));
        }
        
        // ê²°ê³¼ í‘œì‹œ
        showExportResult(result);
        
        // ëª¨ë‹¬ ë‹«ê¸°
        closeModal('export-csv-modal');
        
        // localStorage í´ë¦¬ì–´
        try {
          localStorage.removeItem('shippingSession');
        } catch (e) {
          console.warn('localStorage í´ë¦¬ì–´ ì‹¤íŒ¨:', e);
        }
        
        // ì¶œê³  íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
        const activeTab = document.querySelector('.nav-btn.active');
        if (activeTab && activeTab.dataset.tab === 'shipping') {
          setTimeout(() => {
            loadExportedItems(); // ê°•ì œë¡œ ì„œë²„ì—ì„œ ë‹¤ì‹œ ë¡œë“œ
          }, 1000);
        }
        
        // ì„œë²„ì—ì„œ ë°œì£¼ì„œ ë‹¤ì‹œ ë¡œë“œ
        setTimeout(() => {
          // ê¸°ì¡´ ì¬ê³  ìƒíƒœ ë°±ì—…
          const stockStatusBackup = {};
          AppState.orderItems.forEach(item => {
            stockStatusBackup[item.barcode] = item.stockAvailable;
          });
          
          loadOrderItemsFromSheetAsync().then(() => {
            const savedExportInfo = sessionStorage.getItem('lastExportInfo');
            if (savedExportInfo) {
              const exportInfo = JSON.parse(savedExportInfo);
              AppState.orderItems.forEach(item => {
                if (exportInfo[item.barcode]) {
                  item.exportedAt = exportInfo[item.barcode];
                }
                // ì¬ê³  ìƒíƒœ ë³µì› (ì„œë²„ì—ì„œ ì œëŒ€ë¡œ ëª» ì½ì–´ì˜¨ ê²½ìš°)
                if (stockStatusBackup[item.barcode] && item.stockAvailable === 'ë¯¸í™•ì¸') {
                  item.stockAvailable = stockStatusBackup[item.barcode];
                }
              });
              updateOrderList();
              sessionStorage.removeItem('lastExportInfo');
            }
          });
        }, 2000);
      } else {
        showError('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        document.getElementById('proceed-export-btn').disabled = false;
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error.toString());
      document.getElementById('proceed-export-btn').disabled = false;
    })
    .exportToCSV(AppState.currentOrderInfo.orderId, validation.exportableItems);
}

function downloadCSV(csvContent, filename) {
 const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
 const link = document.createElement('a');
 
 if (navigator.msSaveBlob) {
   navigator.msSaveBlob(blob, filename);
 } else {
   link.href = URL.createObjectURL(blob);
   link.download = filename;
   link.style.display = 'none';
   document.body.appendChild(link);
   link.click();
   document.body.removeChild(link);
 }
}

function updateExportedStatus(exportedItems, exportedAt) {
  const now = exportedAt || new Date().toISOString();
  
  exportedItems.forEach(expItem => {
    const item = AppState.orderItems.find(i => i.id === expItem.id);
    if (item) {
      item.exportedAt = now;
      item.exportedQuantity = expItem.exportQuantity || expItem.quantity;
      item.exportStatus = `ë‚´ë³´ë‚´ê¸° ì™„ë£Œ (${new Date(now).toLocaleString('ko-KR')})`;
    }
  });
  
  // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
  updateOrderList();
  updateExportButtonStatus();
  
  // ì„¸ì…˜ ì €ì¥
  saveSession();
  
  // ì„œë²„ì—ë„ ì €ì¥ (ìë™ ì €ì¥)
  scheduleAutoSave();
}

function showExportResult(result) {
 const content = document.getElementById('export-result-content');
 
 content.innerHTML = `
   <div class="export-result">
     <div class="export-result-icon success">âœ…</div>
     <div class="export-result-title">ë‚´ë³´ë‚´ê¸° ì™„ë£Œ</div>
     <div class="export-result-info">
       CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.
     </div>
     <div class="export-result-details">
       <p><strong>íŒŒì¼ëª…:</strong> ${result.filename}</p>
       <p><strong>ë‚´ë³´ë‚¸ í•­ëª©:</strong> ${result.exportedCount}ê°œ</p>
       <p><strong>ë‚´ë³´ë‚´ê¸° ì‹œê°„:</strong> ${formatDateTime(result.exportedAt)}</p>
     </div>
   </div>
 `;
 
 document.getElementById('export-result-modal').style.display = 'block';
}

// 7. ê°œë³„ ì•„ì´í…œì˜ Smaregi ì •ë³´ë§Œ ì—…ë°ì´íŠ¸
function updateOrderItemSmaregiInfo(itemId) {
  const itemElement = document.querySelector(`[data-id="${itemId}"]`);
  if (!itemElement) return;
  
  const item = AppState.orderItems.find(i => i.id == itemId);
  if (!item) return;
  
  const storeStock = AppState.smaregiData[item.barcode] || 0;
  const hasData = item.barcode in AppState.smaregiData;
  
  // ë§¤ì¥ ì¬ê³  ë°°ì§€ë§Œ ì—…ë°ì´íŠ¸
  const stockBadge = itemElement.querySelector('.store-stock-badge');
  if (stockBadge) {
    if (hasData) {
      let stockClass = 'store-stock-normal';
      if (storeStock === 0) stockClass = 'store-stock-empty';
      else if (storeStock < 10) stockClass = 'store-stock-low';
      
      stockBadge.className = `store-stock-badge ${stockClass}`;
      stockBadge.innerHTML = `
        <span class="store-icon">ğŸª</span>
        <span class="store-count">${storeStock}ê°œ</span>
      `;
    } else {
      stockBadge.className = 'store-stock-badge store-stock-no-data';
      stockBadge.innerHTML = `
        <span class="store-icon">ğŸª</span>
        <span class="store-count">-</span>
      `;
    }
  }
}

// ===== 31. Smaregi ì—…ë¡œë“œ ê¸°ëŠ¥ =====
function showSmaregiUploadModal() {
 document.getElementById('smaregi-upload-modal').style.display = 'block';
 document.getElementById('last-smaregi-upload').textContent = 'í™•ì¸ì¤‘...';
 loadLastSmaregiUploadInfo();
 setupSmaregiDropZone();
}

function setupSmaregiDropZone() {
 const dropZone = document.getElementById('smaregi-drop-zone');
 const fileInput = document.getElementById('smaregi-file-input');
 
 if (!dropZone || !fileInput) return;
 if (dropZone.dataset.initialized === 'true') return;
 
 dropZone.dataset.initialized = 'true';
 
 dropZone.addEventListener('click', () => {
   fileInput.click();
 });
 
 dropZone.addEventListener('dragover', (e) => {
   e.preventDefault();
   dropZone.classList.add('drag-over');
 });
 
 dropZone.addEventListener('dragleave', () => {
   dropZone.classList.remove('drag-over');
 });
 
 dropZone.addEventListener('drop', (e) => {
   e.preventDefault();
   dropZone.classList.remove('drag-over');
   
   const file = e.dataTransfer.files[0];
   if (file && file.type === 'text/csv') {
     handleSmaregiFile(file);
   } else {
     showError('CSV íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
   }
 });
 
 fileInput.addEventListener('change', (e) => {
   const file = e.target.files[0];
   if (file) {
     handleSmaregiFile(file);
   }
 });
}

function handleSmaregiFile(file) {
  const reader = new FileReader();
  
  reader.onload = (e) => {
    AppState.uploadedSmaregiContent = e.target.result;
    
    // íŒŒì¼ ì„ íƒ ìƒíƒœë¥¼ ëª…í™•í•˜ê²Œ í‘œì‹œ
    const dropZone = document.getElementById('smaregi-drop-zone');
    dropZone.innerHTML = `
      <div class="file-selected">
        <div class="file-icon">ğŸ“„</div>
        <div class="file-info">
          <div class="file-name">${file.name}</div>
          <div class="file-size">${(file.size / 1024).toFixed(2)} KB</div>
          <div class="file-status">âœ… íŒŒì¼ ì„ íƒë¨</div>
        </div>
        <button class="btn-remove-file" onclick="removeSmaregiFile()">
          <span>âœ•</span> ë‹¤ì‹œ ì„ íƒ
        </button>
      </div>
    `;
    
    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
    previewSmaregiCSV(AppState.uploadedSmaregiContent);
    document.getElementById('process-smaregi-btn').disabled = false;
  };
  
  reader.onerror = (e) => {
    showError('íŒŒì¼ ì½ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  };
  
  reader.readAsText(file, 'UTF-8');
}

// íŒŒì¼ ì œê±° í•¨ìˆ˜ ì¶”ê°€
function removeSmaregiFile() {
  AppState.uploadedSmaregiContent = null;
  
  const dropZone = document.getElementById('smaregi-drop-zone');
  dropZone.innerHTML = `
    <p>ğŸ“ CSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</p>
  `;
  
  document.getElementById('smaregi-preview').style.display = 'none';
  document.getElementById('process-smaregi-btn').disabled = true;
  
  // íŒŒì¼ input ì´ˆê¸°í™”
  const fileInput = document.getElementById('smaregi-file-input');
  if (fileInput) fileInput.value = '';
}

function previewSmaregiCSV(csvContent) {
  const lines = csvContent.split('\n');
  const preview = document.getElementById('smaregi-preview');
  const previewContent = document.getElementById('smaregi-preview-content');
  
  // ê°„ë‹¨í•œ CSV íŒŒì‹± í•¨ìˆ˜ (ì¸ë¼ì¸)
  const parseCSV = (line) => {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        result.push(current);
        current = '';
      } else {
        current += char;
      }
    }
    
    result.push(current);
    return result;
  };
  
  let html = `
    <table class="preview-table">
      <thead>
        <tr>
          <th>ë°”ì½”ë“œ</th>
          <th>ë§¤ì¥ ì¬ê³ </th>
        </tr>
      </thead>
      <tbody>
  `;
  
  let validRows = 0;
  
  for (let i = 1; i < lines.length && validRows < 5; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    const columns = parseCSV(line); // parseCSVLine ëŒ€ì‹  parseCSV ì‚¬ìš©
    
    if (columns.length > 8) {
      const barcode = columns[2] ? columns[2].trim() : '';
      const stock = columns[8] ? columns[8].trim() : '0';
      
      if (barcode) {
        html += `<tr><td>${barcode}</td><td>${stock}ê°œ</td></tr>`;
        validRows++;
      }
    }
  }
  
  const totalValidRows = lines.filter((line, index) => {
    if (index === 0 || !line.trim()) return false;
    const cols = parseCSV(line);
    return cols.length > 8 && cols[2];
  }).length;
  
  if (totalValidRows > 5) {
    html += `<tr><td colspan="2" style="text-align: center;">... ì´ ${totalValidRows}ê°œ í•­ëª©</td></tr>`;
  }
  
  html += '</tbody></table>';
  
  previewContent.innerHTML = html;
  preview.style.display = 'block';
}

function processSmaregiUpload() {
  console.log('processSmaregiUpload ì‹œì‘');
  console.log('CSV ë‚´ìš© ê¸¸ì´:', AppState.uploadedSmaregiContent?.length);

  if (!AppState.uploadedSmaregiContent) {
    showError('CSV íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
  const processBtn = document.getElementById('process-smaregi-btn');
  const originalText = processBtn.textContent;
  processBtn.disabled = true;
  processBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
  
  // ë” ë‚˜ì€ ë¡œë”© í‘œì‹œ
  showLoadingOverlay('ë§¤ì¥ ì¬ê³  ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoadingOverlay();
      processBtn.disabled = false;
      processBtn.textContent = originalText;
      
      if (result && result.success) {
        // ë©”ëª¨ë¦¬ì˜ Smaregi ë°ì´í„° ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        AppState.smaregiData = result.data || {};
        AppState.smaregiUploadTime = new Date().toLocaleString('ko-KR');
        AppState.smaregiDataLoaded = true;
        
        showQuickSuccess(`${result.count}ê°œ ë§¤ì¥ ì¬ê³  ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        closeModal('smaregi-upload-modal');
        
        // í™”ë©´ì— í‘œì‹œëœ ë‚´ìš© ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        updateSmaregiDisplay();
        
        if (result.lowStockItems && result.lowStockItems.length > 0) {
          showLowStockAlert(result.lowStockItems);
        }
      } else {
        showError(result ? result.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    })
    .withFailureHandler(function(error) {
      hideLoadingOverlay();
      processBtn.disabled = false;
      processBtn.textContent = originalText;
      
      console.error('Smaregi ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
      showError('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.message || error.toString()));
    })
    .uploadSmaregiCSV(AppState.uploadedSmaregiContent);
}

function showLoadingOverlay(message = 'ì²˜ë¦¬ ì¤‘...') {
  let overlay = document.getElementById('loading-overlay');
  
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'loading-overlay';
    overlay.className = 'loading-overlay';
    document.body.appendChild(overlay);
  }
  
  overlay.innerHTML = `
    <div class="loading-overlay-content">
      <div class="loading-spinner"></div>
      <div class="loading-message">${message}</div>
      <div class="loading-submessage">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
    </div>
  `;
  
  overlay.style.display = 'flex';
}

function hideLoadingOverlay() {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
}

function updateSmaregiDisplay() {
  // ê²€ìƒ‰ ê²°ê³¼ê°€ í‘œì‹œë˜ì–´ ìˆìœ¼ë©´ ë‹¤ì‹œ ë Œë”ë§
  const searchResults = document.getElementById('search-results');
  if (searchResults && searchResults.children.length > 1) {
    const query = document.getElementById('search-input').value;
    if (query) {
      performSearch(); // ë¡œì»¬ ë°ì´í„°ë¡œ ì¬ê²€ìƒ‰
    }
  }
  
  // ë°œì£¼ ëª©ë¡ ì—…ë°ì´íŠ¸
  if (AppState.orderItems.length > 0) {
    updateOrderList();
  }
  
  // Smaregi ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
  updateSmaregiStatusDisplay();
}

// Smaregi ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateSmaregiStatus() {
  // order-management-sectionì˜ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸
  const statusElement = document.querySelector('.order-management-section #smaregi-status');
  if (!statusElement) return;
  
  const statusIcon = statusElement.querySelector('#smaregi-status-icon');
  const statusText = statusElement.querySelector('#smaregi-status-text');
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.connected) {
        statusElement.classList.add('connected');
        statusElement.classList.remove('error');
        statusIcon.textContent = 'âœ…';
        statusText.textContent = 'API ì—°ê²°ë¨';
        
        // AppState ì—…ë°ì´íŠ¸
        AppState.smaregiConnected = true;
        
        // ì¬ê³  ë°ì´í„° ë¡œë“œ
        if (result.hasData) {
          statusText.textContent = `API ì—°ê²°ë¨ (${result.itemCount || 0}ê°œ ìƒí’ˆ)`;
        }
      } else {
        statusElement.classList.add('error');
        statusElement.classList.remove('connected');
        statusIcon.textContent = 'âŒ';
        statusText.textContent = 'API ì—°ê²° ì•ˆë¨';
        AppState.smaregiConnected = false;
      }
    })
    .withFailureHandler(function(error) {
      statusElement.classList.add('error');
      statusElement.classList.remove('connected');
      statusIcon.textContent = 'âš ï¸';
      statusText.textContent = 'API í™•ì¸ ì‹¤íŒ¨';
      AppState.smaregiConnected = false;
    })
    .checkSmaregiConnection();
}

// scripts.htmlì˜ Smaregi ê´€ë ¨ ìµœì í™”ëœ ì½”ë“œ

// ì „ì—­ ë³€ìˆ˜
window.currentLowStockItems = null;

// ë©”ì¸ í•¨ìˆ˜
function showLowStockAlert(lowStockItems) {
  if (!lowStockItems || lowStockItems.length === 0) {
    showInfo('ì¬ê³  ë¶€ì¡± ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  window.currentLowStockItems = lowStockItems;
  
  const orderedBarcodes = new Set(AppState.orderItems.map(item => item.barcode));
  const threshold = AppState.settings.suggestStock10 || 10;
  
  const modalContent = `
    <div class="low-stock-alert">
      <div class="low-stock-alert-header">
        <h3>âš ï¸ ì¬ê³  ë¶€ì¡± ìƒí’ˆ</h3>
        <div class="low-stock-summary">ë§¤ì¥ ì¬ê³  ${threshold}ê°œ ë¯¸ë§Œ</div>
      </div>
      
      <div class="low-stock-controls">
        <label class="filter-checkbox">
          <input type="checkbox" id="select-all-items" onchange="toggleSelectAll()">
          <span>ì „ì²´ ì„ íƒ</span>
        </label>
        <label class="filter-checkbox" style="margin-left: 20px;">
          <input type="checkbox" id="hide-ordered" onchange="filterLowStockItems()">
          <span>ë°œì£¼ëª©ë¡ì— ìˆëŠ” ìƒí’ˆ ìˆ¨ê¸°ê¸°</span>
        </label>
      </div>
      
      <div class="low-stock-list">
        ${lowStockItems.map((item, index) => {
  const isOrdered = orderedBarcodes.has(item.barcode);
  return `
    <div class="low-stock-item ${isOrdered ? 'already-in-order' : ''} ${item.isFrequent ? 'frequent-item' : ''}" 
         id="low-stock-${index}"
         data-is-ordered="${isOrdered}">
      
      <input type="checkbox" 
             class="item-checkbox" 
             data-index="${index}"
             ${isOrdered ? 'disabled' : ''}
             onchange="updateAddButton()">
      
      <div class="item-main">
        <div class="item-name">
          ${item.name}
          ${item.isFrequent ? '<span class="frequent-badge">ìì£¼ë°œì£¼</span>' : ''}
        </div>
        <div class="item-meta">
          ${item.option ? `<span class="item-option">${item.option}</span>` : ''}
          ${item.orderCount > 0 ? `<span class="order-count">ìµœê·¼ ${item.orderCount}íšŒ ë°œì£¼</span>` : ''}
        </div>
      </div>
      
      <div class="stock-badge ${item.stock === 0 ? 'out-of-stock' : 'low-stock'}">
        ì¬ê³ : ${item.stock}ê°œ
      </div>
      
      <div class="quantity-control">
        <button class="qty-btn" onclick="adjustQty(${index}, -1)">âˆ’</button>
        <input type="number" 
               id="qty-${index}" 
               class="qty-input" 
               value="${item.suggestedOrder || 10}"
               min="1">
        <button class="qty-btn" onclick="adjustQty(${index}, 1)">+</button>
      </div>
      
      <button class="add-to-order-btn btn-primary" 
              onclick="addToOrderFromLowStock(${index})"
              id="btn-${index}"
              ${isOrdered ? 'disabled' : ''}>
        ${isOrdered ? 'ë°œì£¼ëª©ë¡ì— ìˆìŒ' : 'ë°œì£¼ ì¶”ê°€'}
      </button>
    </div>
  `;
}).join('')}
      </div>
      
      <div class="low-stock-footer">
        <button class="btn btn-primary" onclick="addSelectedLowStock()" id="add-selected-btn">
          ì„ íƒ í•­ëª© ì¶”ê°€
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  `;
  
  showModal(modalContent);
  updateAddButton();
}

function toggleSelectAll() {
  const selectAll = document.getElementById('select-all-items').checked;
  const checkboxes = document.querySelectorAll('.item-checkbox:not(:disabled)');
  
  checkboxes.forEach(cb => {
    cb.checked = selectAll;
  });
  
  updateAddButton();
}

// í—¬í¼ í•¨ìˆ˜ë“¤ (ê°„ì†Œí™”)
function filterLowStockItems() {
  const hide = document.getElementById('hide-ordered').checked;
  document.querySelectorAll('.already-in-order').forEach(el => {
    el.style.display = hide ? 'none' : '';
  });
}

function adjustQty(index, delta) {
  const input = document.getElementById(`qty-${index}`);
  if (input) input.value = Math.max(1, parseInt(input.value) + delta);
}

function updateAddButton() {
  const count = document.querySelectorAll('.item-checkbox:checked:not(:disabled)').length;
  const btn = document.getElementById('add-selected-btn');
  if (btn) {
    btn.textContent = count > 0 ? `ì„ íƒ í•­ëª© ì¶”ê°€ (${count}ê°œ)` : 'ì„ íƒ í•­ëª© ì¶”ê°€';
    btn.disabled = count === 0;
  }
}

// ê°œë³„ ì¶”ê°€
function addToOrderFromLowStock(index) {
  const item = window.currentLowStockItems[index];
  const quantity = parseInt(document.getElementById(`qty-${index}`).value);
  const btn = document.getElementById(`btn-${index}`);
  const itemEl = document.getElementById(`low-stock-${index}`);
  
  // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
  btn.disabled = true;
  btn.textContent = 'ì¶”ê°€ ì¤‘...';
  
  google.script.run
    .withSuccessHandler(productDetails => {
      if (productDetails) {
        AppState.orderItems.push({
          ...productDetails,
          quantity: quantity,
          priority: 1,
          comment: '', // ì½”ë©˜íŠ¸ ì œê±°
          status: 'ëŒ€ê¸°',
          id: Date.now() + index,
          stockAvailable: 'ë¯¸í™•ì¸'
        });
        
        updateOrderList();
        scheduleAutoSave();
        
        // UI ì—…ë°ì´íŠ¸
        btn.textContent = 'âœ“ ì¶”ê°€ë¨';
        btn.classList.add('btn-success');
        itemEl.classList.add('added');
        itemEl.style.opacity = '0.6';
        
        // ì²´í¬ë°•ìŠ¤ ë¹„í™œì„±í™”
        const checkbox = itemEl.querySelector('.item-checkbox');
        if (checkbox) {
          checkbox.disabled = true;
          checkbox.checked = false;
        }
        
        showQuickSuccess(`${item.name} ${quantity}ê°œ ì¶”ê°€ë¨`);
        updateAddButton();
      }
    })
    .withFailureHandler(error => {
      btn.disabled = false;
      btn.textContent = 'ë°œì£¼ ì¶”ê°€';
      showError('ì¶”ê°€ ì‹¤íŒ¨');
    })
    .getProductDetails(item.barcode);
}

// ì„ íƒ í•­ëª© ì¶”ê°€
function addSelectedLowStock() {
  const selected = [];
  const btn = document.getElementById('add-selected-btn');
  
  // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
  btn.disabled = true;
  btn.textContent = 'ì¶”ê°€ ì¤‘...';
  
  document.querySelectorAll('.item-checkbox:checked:not(:disabled)').forEach(cb => {
    const index = parseInt(cb.dataset.index);
    const quantity = parseInt(document.getElementById(`qty-${index}`).value);
    selected.push({ ...window.currentLowStockItems[index], quantity, index });
  });
  
  if (selected.length === 0) {
    btn.disabled = false;
    btn.textContent = 'ì„ íƒ í•­ëª© ì¶”ê°€';
    return;
  }
  
  let completed = 0;
  const total = selected.length;
  
  selected.forEach(item => {
    google.script.run
      .withSuccessHandler(productDetails => {
        if (productDetails) {
          AppState.orderItems.push({
            ...productDetails,
            quantity: item.quantity,
            priority: 1,
            comment: '', // ì½”ë©˜íŠ¸ ì œê±°
            status: 'ëŒ€ê¸°',
            id: Date.now() + item.index,
            stockAvailable: 'ë¯¸í™•ì¸'
          });
          
          // UI ì—…ë°ì´íŠ¸
          const itemEl = document.getElementById(`low-stock-${item.index}`);
          const itemBtn = document.getElementById(`btn-${item.index}`);
          
          if (itemEl) {
            itemEl.classList.add('added');
            itemEl.style.opacity = '0.6';
          }
          
          if (itemBtn) {
            itemBtn.textContent = 'âœ“ ì¶”ê°€ë¨';
            itemBtn.disabled = true;
            itemBtn.classList.add('btn-success');
          }
        }
        
        completed++;
        btn.textContent = `ì¶”ê°€ ì¤‘... (${completed}/${total})`;
        
        if (completed === total) {
          updateOrderList();
          scheduleAutoSave();
          showQuickSuccess(`${selected.length}ê°œ í•­ëª© ì¶”ê°€ ì™„ë£Œ`);
          setTimeout(() => closeModal(), 1500); // 1.5ì´ˆ í›„ ìë™ ë‹«ê¸°
        }
      })
      .withFailureHandler(error => {
        completed++;
        if (completed === total) {
          btn.disabled = false;
          btn.textContent = 'ì„ íƒ í•­ëª© ì¶”ê°€';
          showError('ì¼ë¶€ í•­ëª© ì¶”ê°€ ì‹¤íŒ¨');
        }
      })
      .getProductDetails(item.barcode);
  });
}

function showNotification(content, type = 'info', duration = 5000) {
 const notification = document.createElement('div');
 notification.className = `notification notification-${type}`;
 notification.innerHTML = content;
 
 document.body.appendChild(notification);
 
 setTimeout(() => {
   notification.classList.add('show');
 }, 10);
 
 setTimeout(() => {
   notification.classList.remove('show');
   setTimeout(() => {
     notification.remove();
   }, 300);
 }, duration);
}

function loadLastSmaregiUploadInfo() {
 const timeoutId = setTimeout(() => {
   document.getElementById('last-smaregi-upload').textContent = 'ì •ë³´ ì—†ìŒ';
 }, 5000);
 
 google.script.run
   .withSuccessHandler(function(info) {
     clearTimeout(timeoutId);
     
     if (info) {
       document.getElementById('last-smaregi-upload').textContent = info.date;
       
       if (!info.isToday) {
         document.getElementById('last-smaregi-upload').innerHTML += 
           ' <span class="warning-text">(ì—…ë°ì´íŠ¸ í•„ìš”)</span>';
       }
     } else {
       document.getElementById('last-smaregi-upload').textContent = 'ì—†ìŒ';
     }
   })
   .withFailureHandler(function(error) {
     clearTimeout(timeoutId);
     document.getElementById('last-smaregi-upload').textContent = 'ë¡œë“œ ì‹¤íŒ¨';
   })
   .getLastSmaregiUploadInfo();
}

// ===== 32. ì¼ê´„ ì¬ê³  í¸ì§‘ =====
function showBulkStockEditModal() {
 const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
 const selectedIds = Array.from(checkedBoxes).map(cb => 
   cb.closest('.order-item').dataset.id
 );
 
 if (selectedIds.length === 0) {
   showError('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
   return;
 }
 
 document.getElementById('selected-count').textContent = selectedIds.length;
 document.getElementById('bulk-stock-edit-modal').style.display = 'block';
 
 window.bulkEditSelectedIds = selectedIds;
}

function applyBulkStock(status) {
 if (!window.bulkEditSelectedIds || window.bulkEditSelectedIds.length === 0) return;
 
 if (status === 'quantity') {
   showBulkQuantityModal();
   return;
 }
 
 showSaveIndicator('saving');
 
 const updates = [];
 
 window.bulkEditSelectedIds.forEach(id => {
   const item = AppState.orderItems.find(i => i.id == id);
   if (item) {
     item.stockAvailable = status;
     updates.push({
       itemId: item.id,
       barcode: item.barcode,
       stockStatus: status
     });
   }
 });
 
 updateOrderList();
 
 if (updates.length > 0) {
   smartRetry.execute('updateBulkStockStatus', [AppState.currentOrderInfo.orderId, updates])
     .then(result => {
       showSaveIndicator('hide');
       
       if (result.success) {
         closeModal('bulk-stock-edit-modal');
         showQuickSuccess(result.message);
         
         document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
         updateBulkEditButton();
       } else {
         showError('ì¼ë¶€ í•­ëª© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + result.message);
         loadOrderItemsFromSheetAsync();
       }
     })
     .catch(error => {
       showSaveIndicator('hide');
       showError('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error);
       loadOrderItemsFromSheetAsync();
     });
 }
}

function showBulkQuantityModal() {
 const selectedIds = window.bulkEditSelectedIds;
 
 if (!selectedIds || selectedIds.length === 0) {
   const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
   selectedIds = Array.from(checkedBoxes).map(cb => 
     cb.closest('.order-item').dataset.id
   );
   
   if (selectedIds.length === 0) {
     showError('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
     return;
   }
   
   window.bulkEditSelectedIds = selectedIds;
 }
 
 const listContainer = document.getElementById('bulk-quantity-list');
 
 if (selectedIds.length === 1) {
   const item = AppState.orderItems.find(i => i.id == selectedIds[0]);
   if (!item) return;
   
   listContainer.innerHTML = `
     <div class="single-quantity-input">
       <div class="item-info-large">
         <strong>${item.name}</strong>
         <span class="text-muted">${item.option || ''}</span>
         <span class="text-muted">ìš”ì²­ ìˆ˜ëŸ‰: ${item.quantity}ê°œ</span>
       </div>
       <div class="quantity-input-large">
         <input type="number" 
                id="bulk-qty-${item.id}" 
                class="quantity-input large" 
                placeholder="ê°€ëŠ¥ ìˆ˜ëŸ‰ ì…ë ¥"
                min="0"
                max="${item.quantity}"
                autofocus>
         <span class="unit">ê°œë§Œ ê°€ëŠ¥</span>
       </div>
     </div>
   `;
 } else {
   listContainer.innerHTML = `
     <div class="bulk-info-message">
       <p>${selectedIds.length}ê°œ ìƒí’ˆì˜ ê°€ëŠ¥ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
     </div>
     ${selectedIds.map(id => {
       const item = AppState.orderItems.find(i => i.id == id);
       if (!item) return '';
       
       return `
         <div class="bulk-quantity-item">
           <div class="item-info">
             <strong>${item.name}</strong>
             <span class="text-muted">${item.option || ''} | ìš”ì²­: ${item.quantity}ê°œ</span>
           </div>
           <div class="quantity-input-wrapper">
             <input type="number" 
                    id="bulk-qty-${id}" 
                    class="quantity-input" 
                    placeholder="ê°€ëŠ¥ìˆ˜ëŸ‰"
                    min="0"
                    max="${item.quantity}">
             <span class="unit">ê°œë§Œ ê°€ëŠ¥</span>
           </div>
         </div>
       `;
     }).join('')}
   `;
 }
 
 document.getElementById('bulk-quantity-modal').style.display = 'block';
 
 if (selectedIds.length === 1) {
   setTimeout(() => {
     const input = document.getElementById(`bulk-qty-${selectedIds[0]}`);
     if (input) input.focus();
   }, 100);
 }
}

function saveBulkQuantities() {
 const selectedIds = window.bulkEditSelectedIds;
 
 if (!selectedIds || selectedIds.length === 0) {
   showError('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
   return;
 }
 
 let updatedCount = 0;
 
 selectedIds.forEach(id => {
   const input = document.getElementById(`bulk-qty-${id}`);
   if (input && input.value) {
     const item = AppState.orderItems.find(i => i.id == id);
     if (item) {
       item.stockAvailable = `${input.value}ê°œë§Œ ê°€ëŠ¥`;
       updatedCount++;
     }
   }
 });
 
 updateOrderList();
 
 closeModal('bulk-quantity-modal');
 closeModal('bulk-stock-edit-modal');
 
 if (updatedCount > 0) {
   showQuickSuccess(`${updatedCount}ê°œ í•­ëª©ì˜ ì¬ê³  ìˆ˜ëŸ‰ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
   scheduleAutoSave();
 } else {
   showError('ì…ë ¥ëœ ìˆ˜ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.');
 }
 
 document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
 updateBulkEditButton();
 window.bulkEditSelectedIds = null;
}

function closeBulkQuantityModal() {
 closeModal('bulk-quantity-modal');
 closeModal('bulk-stock-edit-modal');
 
 document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
 updateBulkEditButton();
 window.bulkEditSelectedIds = null;
}

// ===== 33. Quick Actions (ëŒ€ì‹œë³´ë“œ) =====
function quickAction(action) {
 switch(action) {
   case 'lastWeekOrder':
     copyLastWeekOrder();
     break;
   case 'bestProducts':
     quickOrderBestProducts();
     break;
   case 'monthlyReport':
     generateMonthlyReport();
     break;
   case 'budgetAlert':
     setBudgetAlert();
     break;
 }
}

// ê¸°ì¡´ copyLastWeekOrder í•¨ìˆ˜ ì œê±°í•˜ê³  ìƒˆë¡œìš´ closeCurrentOrder í•¨ìˆ˜ë¡œ êµì²´
function closeCurrentOrder() {
  if (!AppState.currentOrderInfo) {
    showError('ì—´ë ¤ìˆëŠ” ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  if (!confirm('ë°œì£¼ì„œë¥¼ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në§ˆê° í›„ì—ëŠ” ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.')) {
    return;
  }
  
  showLoading('ë°œì£¼ì„œ ë§ˆê° ì²˜ë¦¬ ì¤‘...');
  
  google.script.run
    .withSuccessHandler(result => {
      hideLoading();
      if (result.success) {
        showQuickSuccess(result.message);
        
        // ë°œì£¼ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (AppState.currentOrderInfo) {
          AppState.currentOrderInfo.isClosed = true;
        }
        
        // UI ì—…ë°ì´íŠ¸
        updateOrderList();
        updateOrderStatus();
        
        // ë§ˆê° ë²„íŠ¼ ë¹„í™œì„±í™”
        const closeBtn = document.getElementById('closeOrderBtn');
        if (closeBtn) {
          closeBtn.disabled = true;
          closeBtn.innerHTML = '<span class="action-icon">âœ…</span><span>ë§ˆê°ë¨</span>';
        }
      } else {
        showError('ë§ˆê° ì²˜ë¦¬ ì‹¤íŒ¨: ' + result.error);
      }
    })
    .withFailureHandler(error => {
      hideLoading();
      showError('ë§ˆê° ì²˜ë¦¬ ì‹¤íŒ¨: ' + error.toString());
    })
    .closeOrder(AppState.currentOrderInfo.orderId);
}

function quickOrderBestProducts() {
 showSaveIndicator('loading');
 
 google.script.run
   .withSuccessHandler(function(bestProducts) {
     showSaveIndicator('hide');
     
     if (!bestProducts || bestProducts.length === 0) {
       showError('ë² ìŠ¤íŠ¸ ìƒí’ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
       return;
     }
     
     const modalContent = `
       <h3>ë² ìŠ¤íŠ¸ ìƒí’ˆ ë¹ ë¥¸ ë°œì£¼</h3>
       <div class="best-products-list">
         ${bestProducts.map(product => `
           <div class="best-product-item">
             <div class="product-info">
               <div class="product-name">${product.name}</div>
               <div class="product-details">${product.option} | ${product.supplierName}</div>
             </div>
             <div class="product-controls">
               <input type="number" 
                      id="qty-${product.barcode}" 
                      class="quantity-input" 
                      value="${product.avgQuantity}" 
                      min="0">
               <button class="btn btn-primary" 
                       onclick="addBestProduct('${product.barcode}')">
                 ì¶”ê°€
               </button>
             </div>
           </div>
         `).join('')}
       </div>
       <div style="text-align: right; margin-top: 20px;">
         <button class="btn btn-primary" onclick="addAllBestProducts()">ì „ì²´ ì¶”ê°€</button>
         <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
       </div>
     `;
     
     window.bestProductsData = bestProducts;
     showModal(modalContent);
   })
   .withFailureHandler(function(error) {
     showSaveIndicator('hide');
     showError('ë² ìŠ¤íŠ¸ ìƒí’ˆ ë¡œë“œ ì‹¤íŒ¨: ' + error);
   })
   .getBestProductsForQuickOrder();
}

function addBestProduct(barcode) {
 const product = window.bestProductsData.find(p => p.barcode === barcode);
 const quantity = parseInt(document.getElementById(`qty-${barcode}`).value) || 0;
 
 if (quantity <= 0) return;
 
 google.script.run
   .withSuccessHandler(function(details) {
     if (details) {
       const existing = AppState.orderItems.find(item => item.barcode === barcode);
       
       if (existing) {
         existing.quantity += quantity;
       } else {
         AppState.orderItems.push({
           ...details,
           quantity: quantity,
           priority: 3,
           comment: 'ë² ìŠ¤íŠ¸ ìƒí’ˆ',
           status: 'ëŒ€ê¸°',
           id: Date.now(),
           stockAvailable: 'ë¯¸í™•ì¸'
         });
       }
       
       updateOrderList();
       showQuickSuccess('ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
       document.getElementById(`qty-${barcode}`).disabled = true;
     }
   })
   .withFailureHandler(function(error) {
     showError('ìƒí’ˆ ì¶”ê°€ ì‹¤íŒ¨');
   })
   .getProductDetails(barcode);
}

function addAllBestProducts() {
 const productsToAdd = [];
 
 window.bestProductsData.forEach(product => {
   const qtyInput = document.getElementById(`qty-${product.barcode}`);
   if (!qtyInput.disabled) {
     const quantity = parseInt(qtyInput.value) || 0;
     if (quantity > 0) {
       productsToAdd.push({ barcode: product.barcode, quantity: quantity });
     }
   }
 });
 
 if (productsToAdd.length === 0) {
   showError('ì¶”ê°€í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
   return;
 }
 
 let addedCount = 0;
 productsToAdd.forEach(item => {
   addBestProduct(item.barcode);
   addedCount++;
 });
 
 setTimeout(() => {
   closeModal();
   switchTab('order');
   showQuickSuccess(`${addedCount}ê°œ ë² ìŠ¤íŠ¸ ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
   window.bestProductsData = null;
 }, 1000);
}

// ===== 34. ê¸°íƒ€ í—¬í¼ í•¨ìˆ˜ë“¤ =====
function showFrequentNotOrdered() {
 showSaveIndicator('loading');
 
 google.script.run
   .withSuccessHandler(function(products) {
     showSaveIndicator('hide');
     
     const modalContent = `
       <h3>ì¬ê³  í™•ì¸ í•„ìš” ìƒí’ˆ</h3>
       <p>ìµœê·¼ 7ì¼ê°„ ë°œì£¼í•˜ì§€ ì•Šì€ ìì£¼ ë°œì£¼ ìƒí’ˆì…ë‹ˆë‹¤.</p>
       <div class="best-products-list">
         ${products.map(product => `
           <div class="best-product-item">
             <div class="product-info">
               <div class="product-name">${product.name}</div>
               <div class="product-details">
                 ë§ˆì§€ë§‰ ë°œì£¼: ${product.lastOrderDate || 'ì •ë³´ì—†ìŒ'} | 
                 í‰ê·  ë°œì£¼ëŸ‰: ${product.avgQuantity}ê°œ
               </div>
             </div>
             <button class="btn btn-primary" 
                     onclick="addToOrder('${product.barcode}')">
               ë°œì£¼ ì¶”ê°€
             </button>
           </div>
         `).join('')}
       </div>
     `;
     
     showModal(modalContent);
   })
   .withFailureHandler(function(error) {
     showSaveIndicator('hide');
     showError('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
   })
   .getFrequentNotOrderedProducts();
}

function showBudgetDetails() {
 const budgetEl = document.getElementById('budget-rate').textContent;
 const usedAmount = document.getElementById('budget-text').textContent;
 
 const modalContent = `
   <h3>ì›” ì˜ˆì‚° ìƒì„¸</h3>
   <div style="padding: 20px;">
     <p><strong>í˜„ì¬ ì‚¬ìš©ë¥ :</strong> ${budgetEl}</p>
     <p><strong>ì‚¬ìš© ê¸ˆì•¡:</strong> ${usedAmount}</p>
     <div style="margin-top: 20px;">
       <label>ì›” ì˜ˆì‚° ìˆ˜ì •:</label>
       <input type="number" id="new-budget" class="form-input" 
              placeholder="ìƒˆ ì˜ˆì‚° ê¸ˆì•¡" style="margin: 10px 0;">
       <button class="btn btn-primary" onclick="updateMonthlyBudget()">
         ì˜ˆì‚° ë³€ê²½
       </button>
     </div>
   </div>
 `;
 
 showModal(modalContent);
}

function updateMonthlyBudget() {
 const newBudget = document.getElementById('new-budget').value;
 if (!newBudget || newBudget <= 0) {
   showError('ì˜¬ë°”ë¥¸ ì˜ˆì‚° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
   return;
 }
 
 google.script.run
   .withSuccessHandler(function(result) {
     if (result.success) {
       closeModal();
       showQuickSuccess('ì˜ˆì‚°ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
       loadDashboard();
     } else {
       showError('ì˜ˆì‚° ë³€ê²½ ì‹¤íŒ¨');
     }
   })
   .withFailureHandler(function(error) {
     showError('ì˜ˆì‚° ë³€ê²½ ì‹¤íŒ¨: ' + error);
   })
   .updateSettings({ monthlyBudget: newBudget });
}

function generateMonthlyReport() {
 showSaveIndicator('loading');
 
 google.script.run
   .withSuccessHandler(function(report) {
     showSaveIndicator('hide');
     
     if (report.success) {
       showQuickSuccess('ì›”ê°„ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
       window.open(report.url, '_blank');
     }
   })
   .withFailureHandler(function(error) {
     showSaveIndicator('hide');
     showError('ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨');
   })
   .createMonthlyReport();
}

function setBudgetAlert() {
 const modalContent = `
   <h3>ì˜ˆì‚° ì•Œë¦¼ ì„¤ì •</h3>
   <div style="padding: 20px;">
     <label>
       <input type="checkbox" id="alert-80" checked> 
       ì˜ˆì‚° 80% ë„ë‹¬ ì‹œ ì•Œë¦¼
     </label><br><br>
     <label>
       <input type="checkbox" id="alert-90" checked> 
       ì˜ˆì‚° 90% ë„ë‹¬ ì‹œ ì•Œë¦¼
     </label><br><br>
     <label>
       <input type="checkbox" id="alert-over"> 
       ì˜ˆì‚° ì´ˆê³¼ ì‹œ ì•Œë¦¼
     </label><br><br>
     <button class="btn btn-primary" onclick="saveBudgetAlertSettings()">
       ì €ì¥
     </button>
   </div>
 `;
 
 showModal(modalContent);
}

function saveBudgetAlertSettings() {
 const settings = {
   alert80: document.getElementById('alert-80').checked,
   alert90: document.getElementById('alert-90').checked,
   alertOver: document.getElementById('alert-over').checked
 };
 
 google.script.run
   .withSuccessHandler(function(result) {
     if (result.success) {
       closeModal();
       showQuickSuccess('ì•Œë¦¼ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
     }
   })
   .withFailureHandler(function(error) {
     showError('ì„¤ì • ì €ì¥ ì‹¤íŒ¨');
   })
   .saveBudgetAlertSettings(settings);
}

// scripts.html - ì••ì¶• í•´ì œ
function decompressProductData(compressed) {
  return compressed.map(p => ({
    barcode: p.b,
    name: p.n,
    option: p.o,
    purchasePrice: p.p,
    supplierName: p.s,
    weight: p.w,
    isFrequent: p.f,
    isRecent: p.r,
    searchText: `${p.b} ${p.n} ${p.o}`.toLowerCase()
  }));
}

// ===== 31. ì¶œê³  ê¸°ëŠ¥ =====
// ì¶œê³  ìƒíƒœ ê´€ë¦¬
const ShippingState = {
  exportedItems: [],
  currentBox: {
    barcode: null,
    name: null,
    items: {},
    startTime: null,
    number: null
  },
  currentBoxNumber: 1,
  scanState: 'READY',
  autoSaveTimer: null,
  lastSaveTime: null,
  lastServerSaveTime: null, // ì„œë²„ ì €ì¥ ì‹œê°„ ì¶”ê°€
  isSaving: false,
};

function onOrderChanged() {
  // ì´ì „ ë°œì£¼ì„œì™€ ë‹¤ë¥¸ ê²½ìš°
  const previousOrderId = sessionStorage.getItem('previousOrderId');
  const currentOrderId = AppState.currentOrderInfo?.orderId;
  
  if (previousOrderId && previousOrderId !== currentOrderId) {
    // ìƒˆë¡œìš´ ë°œì£¼ì„œì´ë¯€ë¡œ ë°•ìŠ¤ë²ˆí˜¸ëŠ” ì„œë²„ì—ì„œ ê°€ì ¸ì˜´
    console.log('ë°œì£¼ì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë°•ìŠ¤ë²ˆí˜¸ë¥¼ ìƒˆë¡œ ë¡œë“œí•©ë‹ˆë‹¤.');
  }
  
  // í˜„ì¬ ë°œì£¼ì„œ ID ì €ì¥
  if (currentOrderId) {
    sessionStorage.setItem('previousOrderId', currentOrderId);
  }
}

// ì¶œê³  íƒ­ ì´ˆê¸°í™”
function loadShippingTab() {
  console.log('=== ì¶œê³  íƒ­ ë¡œë“œ ===');
  
  if (!AppState.currentOrderInfo) {
    showShippingEmptyState();
    return;
  }
  
  // ë°œì£¼ì„œ ë³€ê²½ ê°ì§€
  onOrderChanged();
  
  // ì„¤ì •ì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
  if (!AppState.settings) {
    console.error('ì„¤ì •ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
    showShippingSetupPrompt();
    return;
  }
  
  // ê°•ì œ ë¦¬í”„ë ˆì‹œ ì²´í¬
  const forceRefresh = sessionStorage.getItem('forceRefreshShipping');
  if (forceRefresh === 'true') {
    sessionStorage.removeItem('forceRefreshShipping');
    localStorage.removeItem('shippingSession');
    
    // ìƒíƒœ ì´ˆê¸°í™”
    ShippingState.currentBox = {
      barcode: null,
      name: null,
      items: {},
      startTime: null,
      number: null
    };
  }
  
  // 1. ë¨¼ì € ì„¸ì…˜ ë³µì› ì‹œë„
  const sessionRestored = restoreShippingSession();
  
  // 2. ê·¸ ë‹¤ìŒ ë‚´ë³´ë‚´ê¸° í•­ëª© ë¡œë“œ (ì„¸ì…˜ ìœ ì§€í•˜ë©´ì„œ)
  if (sessionRestored) {
    console.log('ì„¸ì…˜ì´ ë³µì›ë˜ì—ˆìœ¼ë¯€ë¡œ ì„¸ì…˜ ìœ ì§€í•˜ë©° ë¡œë“œ');
  }
  
  loadExportedItems();
}

// ë¹ˆ ìƒíƒœ í‘œì‹œ
function showShippingEmptyState() {
  const container = document.getElementById('shipping-tab');
  container.innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">ğŸ“¦</div>
      <h3>ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>ë¨¼ì € ë°œì£¼ì„œë¥¼ ìƒì„±í•˜ê±°ë‚˜ ì„ íƒí•´ì£¼ì„¸ìš”</p>
    </div>
  `;
}

// ì„¤ì • í•„ìš” í‘œì‹œ
function showShippingSetupPrompt() {
  const container = document.getElementById('shipping-tab');
  container.innerHTML = `
    <div class="setup-prompt">
      <h3>ë°•ìŠ¤ë²ˆí˜¸ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
      <p>ì„¤ì • íƒ­ì—ì„œ ë°•ìŠ¤ë²ˆí˜¸ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</p>
      <button class="btn btn-primary" onclick="switchTab('settings')">
        ì„¤ì •ìœ¼ë¡œ ì´ë™
      </button>
    </div>
  `;
}

// ë‚´ë³´ë‚´ê¸°ëœ í•­ëª© ë¡œë“œ
function loadExportedItems() {
  console.log('loadExportedItems ì‹œì‘');
  
  if (!AppState.currentOrderInfo || !AppState.currentOrderInfo.orderId) {
    console.error('currentOrderInfoê°€ ì—†ìŠµë‹ˆë‹¤');
    displayNoExportedItems();
    return;
  }
  
  // ì„¸ì…˜ì´ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸
  const hasSession = ShippingState.currentBox.barcode !== null;
  console.log('ê¸°ì¡´ ì„¸ì…˜ ì¡´ì¬:', hasSession);
  
  // ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ
  showLoading('ì¶œê³  ê°€ëŠ¥ í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      console.log('ì„œë²„ ì‘ë‹µ:', result);
      
      if (result.success && result.items.length > 0) {
        console.log('ì¶œê³  ê°€ëŠ¥ í•­ëª© ìˆ˜:', result.items.length);
        
        // ì„¸ì…˜ì´ ì—†ì„ ë•Œë§Œ ìƒíƒœ ì´ˆê¸°í™”
        if (!hasSession) {
          ShippingState.currentBox = {
            barcode: null,
            name: null,
            items: {},
            startTime: null,
            number: null
          };
        }
        
        // exportedItemsëŠ” ì—…ë°ì´íŠ¸ (ì„¸ì…˜ì˜ ë°•ìŠ¤ ì •ë³´ëŠ” ìœ ì§€)
        ShippingState.exportedItems = result.items;
        
        // ë°œì£¼ì„œë³„ ë°•ìŠ¤ë²ˆí˜¸ ì„¤ì •
        if (!ShippingState.currentBoxNumber || ShippingState.currentBoxNumber === 1) {
          ShippingState.currentBoxNumber = result.currentBoxNumber || 1;
        }
        
        displayShippingInterface();
      } else {
        console.log('ì¶œê³  ê°€ëŠ¥í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
        displayNoExportedItems();
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
      showError('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error);
      displayNoExportedItems();
    })
    .getExportedItems(AppState.currentOrderInfo.orderId);
}


// ì¶œê³  ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ
function displayShippingInterface() {
  const container = document.getElementById('shipping-tab');
  const settings = AppState.settings;
  
  if (!settings) {
    container.innerHTML = `
      <div class="setup-prompt">
        <h3>ì„¤ì •ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h3>
        <p>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”</p>
      </div>
    `;
    return;
  }
  
  if (!settings.boxBarcodes || settings.boxBarcodes.length === 0) {
    container.innerHTML = `
      <div class="setup-prompt">
        <h3>ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”</h3>
        <p>ì„¤ì • íƒ­ì—ì„œ ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ë¨¼ì € ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤</p>
        <button class="btn btn-primary" onclick="switchTab('settings')">
          ì„¤ì •ìœ¼ë¡œ ì´ë™
        </button>
      </div>
    `;
    return;
  }
  
  container.innerHTML = `
    <div class="shipping-container">
      <!-- ê°„ì†Œí™”ëœ ë°•ìŠ¤ ì •ë³´ -->
      <div class="box-status-bar">
        <div class="current-status">
          <span id="status-text">ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</span>
          ${ShippingState.currentBox.number ? 
            `<span class="current-box-badge">${ShippingState.currentBox.number}ë²ˆ ë°•ìŠ¤</span>` : 
            ''
          }
        </div>
        <div class="box-quick-info" id="box-quick-info">
          <span>ë‹¤ìŒ ë°•ìŠ¤: ${ShippingState.currentBoxNumber}ë²ˆ</span>
          <button class="btn btn-sm" onclick="showBoxOptionsMenu()" title="ë°•ìŠ¤ ì˜µì…˜">
            â‹®
          </button>
          <div class="box-options-menu" id="box-options-menu" style="display:none;">
            <button onclick="resetOrderBoxNumberUI()">ë°•ìŠ¤ë²ˆí˜¸ ì´ˆê¸°í™”</button>
            <button onclick="setCustomBoxNumber()">ë°•ìŠ¤ë²ˆí˜¸ ì„¤ì •</button>
          </div>
        </div>
      </div>
      
      <!-- ìŠ¤ìº” ì…ë ¥ -->
      <div class="scan-input-section">
        <div class="scan-input-wrapper">
          <input type="text" 
                 id="barcode-scan-input" 
                 class="scan-input" 
                 placeholder="í´ë¦­í•˜ì—¬ ìŠ¤ìº” ì‹œì‘..." 
                 autocomplete="off">
          <div class="scan-indicator ${ShippingState.scanState}" id="scan-indicator">
            <span class="scan-icon">ğŸ“·</span>
          </div>
        </div>
      </div>
      
      <!-- í˜„ì¬ ë°•ìŠ¤ ì§„í–‰ìƒí™© -->
      <div class="box-progress-section" id="box-progress-section" style="${ShippingState.currentBox.barcode ? '' : 'display:none;'}">
        <div class="box-header">
          <h4 id="box-progress-title">
            ${ShippingState.currentBox.number ? `${ShippingState.currentBox.number}ë²ˆ ë°•ìŠ¤ ì§„í–‰ ì¤‘ (${ShippingState.currentBox.name})` : ''}
          </h4>
          <div class="scan-feedback" id="scan-feedback"></div>
          <div class="box-actions">
            <button class="btn btn-sm btn-info" onclick="manualSaveSession()" title="ì‘ì—… ë‚´ìš© ì €ì¥">
              ğŸ’¾ ì„ì‹œì €ì¥
            </button>
            <button class="btn btn-sm btn-secondary" onclick="forceCompleteBox()">
              ê°•ì œ ì™„ë£Œ
            </button>
          </div>
        </div>
        <div class="box-items-summary" id="box-items-summary"></div>
      </div>
      
      <!-- ì¶œê³  ëŒ€ìƒ ëª©ë¡ -->
      <div class="shipping-list-section">
        <div class="section-header">
          <h3>ì¶œê³  ëŒ€ìƒ ëª©ë¡</h3>
          <div class="list-summary" id="list-summary"></div>
        </div>
        <div id="shipping-list" class="shipping-list"></div>
      </div>
    </div>
  `;

  // ì˜µì…˜ ë©”ë‰´ í•¨ìˆ˜ë“¤
window.showBoxOptionsMenu = function() {
  const menu = document.getElementById('box-options-menu');
  if (menu) {
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  }
};

window.resetOrderBoxNumberUI = function() {
  // ì´ˆê¸°í™” ëª¨ë‹¬ í‘œì‹œ (ë°œì£¼ ëª©ë¡ ì´ˆê¸°í™”ì™€ ë™ì¼í•œ UI)
  const modalContent = `
    <div class="clear-orders-modal">
      <h3>âš ï¸ ë°•ìŠ¤ë²ˆí˜¸ ì´ˆê¸°í™”</h3>
      <p class="warning-text">ëª¨ë“  ì¶œê³  ê¸°ë¡ê³¼ ë°•ìŠ¤ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <p class="sub-text">í˜„ì¬ê¹Œì§€ ìŠ¤ìº”í•œ ëª¨ë“  í•­ëª©ì´ ì´ˆê¸°í™”ë˜ê³ <br>ë°•ìŠ¤ë²ˆí˜¸ê°€ 1ë²ˆë¶€í„° ë‹¤ì‹œ ì‹œì‘ë©ë‹ˆë‹¤.</p>
      
      <div class="modal-actions">
        <button id="reset-box-confirm-btn" class="btn btn-danger" disabled onclick="confirmResetBoxNumber()">
          ì˜ˆ (<span id="reset-timer">5</span>ì´ˆ)
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">ì•„ë‹ˆì˜¤</button>
      </div>
    </div>
  `;
  
  showModal(modalContent);
  
  // 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´
  let timeLeft = 5;
  const confirmBtn = document.getElementById('reset-box-confirm-btn');
  const timerSpan = document.getElementById('reset-timer');
  
  const timerInterval = setInterval(() => {
    timeLeft--;
    
    if (timeLeft > 0) {
      timerSpan.textContent = timeLeft;
    } else {
      clearInterval(timerInterval);
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = 'ì˜ˆ, ì´ˆê¸°í™”í•©ë‹ˆë‹¤';
      confirmBtn.classList.add('active');
    }
  }, 1000);
};

// ë°•ìŠ¤ë²ˆí˜¸ ì´ˆê¸°í™” í™•ì¸ í•¨ìˆ˜
window.confirmResetBoxNumber = function() {
  showLoading('ë°•ìŠ¤ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘...');
  
  // ë¡œì»¬ ìƒíƒœ ì´ˆê¸°í™”
  ShippingState.currentBox = {
    barcode: null,
    name: null,
    items: {},
    startTime: null,
    number: null
  };
  ShippingState.currentBoxNumber = 1;
  ShippingState.scanState = 'READY';
  
  // ì„œë²„ì— ì´ˆê¸°í™” ìš”ì²­
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        // ì„¸ì…˜ í´ë¦¬ì–´
        localStorage.removeItem('shippingSession');
        sessionStorage.removeItem('lastExportInfo');
        
        // ì¶œê³  ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
        loadExportedItems();
        
        closeModal();
        showQuickSuccess('ë°•ìŠ¤ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        showError('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error);
    })
    .resetAllBoxNumbers(AppState.currentOrderInfo.orderId);
};

window.setCustomBoxNumber = function() {
  const newNumber = prompt('ì‹œì‘í•  ë°•ìŠ¤ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', ShippingState.currentBoxNumber);
  if (newNumber && !isNaN(newNumber)) {
    const boxNumber = parseInt(newNumber);
    if (boxNumber > 0) {
      ShippingState.currentBoxNumber = boxNumber;
      google.script.run
        .setOrderBoxNumber(AppState.currentOrderInfo.orderId, boxNumber);
      
      const boxQuickInfo = document.getElementById('box-quick-info');
      if (boxQuickInfo) {
        boxQuickInfo.querySelector('span').textContent = `ë‹¤ìŒ ë°•ìŠ¤: ${boxNumber}ë²ˆ`;
      }
      showQuickSuccess(`ë°•ìŠ¤ë²ˆí˜¸ê°€ ${boxNumber}ë²ˆìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
  }
};
  
  setupScanInput();
  displayShippingList();
  
  if (ShippingState.currentBox.barcode) {
    updateBoxProgress();
  }
  
  startShippingAutoSave();
}

function manualSaveSession() {
  saveShippingSession();
  
  // ì„œë²„ì—ë„ ì¦‰ì‹œ ì €ì¥
  const sessionData = {
    currentBox: ShippingState.currentBox,
    currentBoxNumber: ShippingState.currentBoxNumber,
    scanState: ShippingState.scanState,
    exportedItems: ShippingState.exportedItems,
    lastActivity: new Date().toISOString(),
    orderId: AppState.currentOrderInfo?.orderId
  };
  
  google.script.run
    .withSuccessHandler(() => {
      showQuickSuccess('ì‘ì—… ë‚´ìš©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    })
    .withFailureHandler((error) => {
      showError('ì €ì¥ ì‹¤íŒ¨: ' + error);
    })
    .saveShippingSession(sessionData);
}

// ì¶œê³  ëŒ€ìƒì´ ì—†ì„ ë•Œ
function displayNoExportedItems() {
  const container = document.getElementById('shipping-tab');
  container.innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">ğŸ“¤</div>
      <h3>ì¶œê³  ê°€ëŠ¥í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</h3>
      <p>ë‚´ë³´ë‚´ê¸°ê°€ ì™„ë£Œëœ í•­ëª©ë§Œ ì¶œê³ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
      <p class="text-muted">í’ˆì ˆ/ì˜¤ë”ì¤‘ í•­ëª©ì€ ì œì™¸ë©ë‹ˆë‹¤</p>
    </div>
  `;
}

// ìŠ¤ìº” ì…ë ¥ ì„¤ì •
function setupScanInput() {
  const scanInput = document.getElementById('barcode-scan-input');
  if (!scanInput) return;
  
  scanInput.placeholder = 'í´ë¦­í•˜ì—¬ ìŠ¤ìº” ì‹œì‘...';
  
  scanInput.addEventListener('click', function() {
    this.placeholder = 'ë°•ìŠ¤ ë˜ëŠ” ìƒí’ˆ ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”...';
  });
  
  scanInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const barcode = e.target.value.trim();
      
      if (barcode) {
        handleBarcodeScan(barcode);
        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        e.target.value = '';
        // í¬ì»¤ìŠ¤ ìœ ì§€
        e.target.focus();
      }
    }
  });
  
  // blur ì´ë²¤íŠ¸ì—ì„œ ìë™ í¬ì»¤ìŠ¤ ì œê±°
  scanInput.addEventListener('blur', function() {
    const shippingTab = document.getElementById('shipping-tab');
    if (shippingTab && shippingTab.classList.contains('active')) {
      this.placeholder = 'í´ë¦­í•˜ì—¬ ìŠ¤ìº” ì¬ê°œ...';
    }
  });
}

// ===== ë°•ìŠ¤ ë°”ì½”ë“œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ =====

// ë°•ìŠ¤ ë°”ì½”ë“œ ì¶”ê°€
function addBoxBarcode() {
  const barcodeInput = document.getElementById('new-box-barcode');
  const nameInput = document.getElementById('new-box-name');
  
  const barcode = barcodeInput.value.trim();
  const name = nameInput.value.trim();
  
  if (!barcode) {
    showError('ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ì´ë¦„ì´ ì—†ìœ¼ë©´ ìë™ ìƒì„±
  const boxName = name || `ë°•ìŠ¤ ${(AppState.settings.boxBarcodes?.length || 0) + 1}`;
  
  showSaveIndicator('saving');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result.success) {
        // ì„¤ì • ì—…ë°ì´íŠ¸
        AppState.settings.boxBarcodes = result.boxBarcodes;
        
        // UI ì—…ë°ì´íŠ¸
        displayBoxBarcodes();
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        barcodeInput.value = '';
        nameInput.value = '';
        
        showQuickSuccess('ë°•ìŠ¤ ë°”ì½”ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì¶”ê°€ ì‹¤íŒ¨: ' + error);
    })
    .addBoxBarcode(barcode, boxName);
}

// ë°•ìŠ¤ ë°”ì½”ë“œ ì‚­ì œ
function removeBoxBarcode(barcode) {
  if (!confirm('ì´ ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  showSaveIndicator('saving');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result.success) {
        // ì„¤ì • ì—…ë°ì´íŠ¸
        AppState.settings.boxBarcodes = result.boxBarcodes;
        
        // UI ì—…ë°ì´íŠ¸
        displayBoxBarcodes();
        
        showQuickSuccess('ë°•ìŠ¤ ë°”ì½”ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì‚­ì œ ì‹¤íŒ¨: ' + error);
    })
    .removeBoxBarcode(barcode);
}

// ë°•ìŠ¤ ë°”ì½”ë“œ ëª©ë¡ í‘œì‹œ
function displayBoxBarcodes() {
  const container = document.getElementById('registered-boxes-list');
  const boxBarcodes = AppState.settings.boxBarcodes || [];
  
  if (boxBarcodes.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <p>ë“±ë¡ëœ ë°•ìŠ¤ ë°”ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = boxBarcodes.map(box => `
    <div class="box-barcode-item">
      <div class="box-barcode-info">
        <span class="box-barcode-name">${box.name}</span>
        <span class="box-barcode-code">${box.barcode}</span>
      </div>
      <div class="box-barcode-actions">
        <button class="btn-delete" onclick="removeBoxBarcode('${box.barcode}')">
          ì‚­ì œ
        </button>
      </div>
    </div>
  `).join('');
}

// ì„¤ì • íƒ­ ë¡œë“œ ì‹œ ë°•ìŠ¤ ë°”ì½”ë“œë„ í‘œì‹œ
function loadSettingsTab() {
  if (AppState.settings && Object.keys(AppState.settings).length > 0) {
    displaySettings(AppState.settings);
  } else {
    google.script.run
      .withSuccessHandler((settings) => {
        AppState.settings = settings;
        displaySettings(settings);
      })
      .withFailureHandler(() => {
        displaySettings({});
      })
      .getSettings();
  }
  
  setTimeout(() => {
    initializeDisplaySettings();
    displayBoxBarcodes();        // ê¸°ì¡´ ê¸°ëŠ¥
    displayVoiceSettings();      // ìƒˆ ê¸°ëŠ¥ ì¶”ê°€
  }, 200);
}

// ë°•ìŠ¤ ë°”ì½”ë“œ ì…ë ¥ í•„ë“œì— Enter í‚¤ ì´ë²¤íŠ¸ ì¶”ê°€
document.addEventListener('DOMContentLoaded', function() {
  const barcodeInput = document.getElementById('new-box-barcode');
  const nameInput = document.getElementById('new-box-name');
  
  if (barcodeInput) {
    barcodeInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        
        // ì´ë¦„ ì…ë ¥ í•„ë“œë¡œ í¬ì»¤ìŠ¤ ì´ë™ ë˜ëŠ” ì¶”ê°€
        if (!nameInput.value.trim()) {
          nameInput.focus();
        } else {
          addBoxBarcode();
        }
      }
    });
  }
  
  if (nameInput) {
    nameInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addBoxBarcode();
      }
    });
  }
});

// ì¶œê³  íƒ­ì—ì„œ ë°•ìŠ¤ í†µê³„ í‘œì‹œ
function displayShippingStats() {
  if (!AppState.currentOrderInfo) return;
  
  google.script.run
    .withSuccessHandler(function(stats) {
      const quickInfo = document.getElementById('box-quick-info');
      
      if (quickInfo && stats) {
        quickInfo.innerHTML = `
          <span>ì´ ë°•ìŠ¤: ${stats.totalBoxes}ê°œ</span>
          <span>ì´ ìˆ˜ëŸ‰: ${stats.totalQuantity}ê°œ</span>
        `;
      }
    })
    .withFailureHandler(function(error) {
      console.warn('ì¶œê³  í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
    })
    .getShippingStats(AppState.currentOrderInfo.orderId);
}

// ì¶œê³  íƒ­ ë¡œë“œ ì‹œ í†µê³„ë„ í‘œì‹œ
const originalLoadShippingTab = loadShippingTab;
loadShippingTab = function() {
  originalLoadShippingTab();
  
  // í†µê³„ í‘œì‹œ
  setTimeout(() => {
    displayShippingStats();
  }, 500);
};

// ë°•ìŠ¤ ì™„ë£Œ í›„ í†µê³„ ì—…ë°ì´íŠ¸
const originalCompleteBox = completeBox;
completeBox = function(callback) {
  originalCompleteBox(() => {
    // í†µê³„ ì—…ë°ì´íŠ¸
    displayShippingStats();
    
    // ì›ë˜ ì½œë°± ì‹¤í–‰
    if (callback) callback();
  });
};


// ë°•ìŠ¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function getBoxInfoFromSettings(barcode) {
  const boxBarcodes = AppState.settings.boxBarcodes || [];
  return boxBarcodes.find(box => box.barcode === barcode);
}

// ë°”ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬ ìˆ˜ì •
function handleBarcodeScan(barcode) {
  console.log('=== ë°”ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬ ì‹œì‘ ===');
  console.log('ìŠ¤ìº”ëœ ë°”ì½”ë“œ:', barcode);
  console.log('í˜„ì¬ ë°•ìŠ¤ ìƒíƒœ:', ShippingState.currentBox);
  console.log('ì„¤ì •ëœ ë°•ìŠ¤ë“¤:', AppState.settings?.boxBarcodes);
  
  // ë“±ë¡ëœ ë°•ìŠ¤ ë°”ì½”ë“œì¸ì§€ í™•ì¸
  const boxInfo = getBoxInfoFromSettings(barcode);
  console.log('ë°•ìŠ¤ ì •ë³´ í™•ì¸ ê²°ê³¼:', boxInfo);
  
  if (boxInfo) {
    // ë°•ìŠ¤ ë°”ì½”ë“œì¸ ê²½ìš°
    console.log('ë°•ìŠ¤ ë°”ì½”ë“œë¡œ ì¸ì‹ë¨');
    handleBoxScan(barcode, boxInfo);
    return;
  }
  
  // ë°•ìŠ¤ ë°”ì½”ë“œê°€ ì•„ë‹Œ ê²½ìš° = ì œí’ˆ ë°”ì½”ë“œ
  console.log('ì œí’ˆ ë°”ì½”ë“œë¡œ ì¸ì‹ë¨');
  
  // í˜„ì¬ ë°•ìŠ¤ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
  if (!ShippingState.currentBox.barcode) {
    console.log('í˜„ì¬ ë°•ìŠ¤ ì—†ìŒ - ì—ëŸ¬ ì²˜ë¦¬');
    speak('ì˜¤ë¥˜. ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ë¨¼ì € ìŠ¤ìº”í•˜ì„¸ìš”');
    showError('ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ë¨¼ì € ìŠ¤ìº”í•´ì£¼ì„¸ìš”.');
    showScanFeedback('ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ë¨¼ì € ìŠ¤ìº”í•˜ì„¸ìš”', 'error');
    return;
  }
  
  // ì œí’ˆ ìŠ¤ìº” ì²˜ë¦¬
  handleProductScan(barcode);
}

// ë°•ìŠ¤ ì‹œì‘ í•¨ìˆ˜ í†µí•©
function startBox(identifier) {
  const settings = AppState.settings;
  
  if (settings.boxMode === 'number') {
    startBoxWithNumber(identifier);
  } else {
    const boxInfo = getBoxInfoFromSettings(identifier);
    startBoxWithBarcode(identifier, boxInfo);
  }
}

// ===== scripts.htmlì— ì¶”ê°€í•  í•¨ìˆ˜ë“¤ (ì¶œê³  ê´€ë ¨ í•¨ìˆ˜ë“¤ ìœ„ì— ì¶”ê°€) =====

// ë°•ìŠ¤ ì‹ë³„ì í™•ì¸ í•¨ìˆ˜ - í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ
function isBoxBarcode(identifier) {
  const settings = AppState.settings;
  
  if (!settings) {
    console.error('ì„¤ì •ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
    return false;
  }
  
  if (settings.boxMode === 'barcode') {
    // ë°”ì½”ë“œ ëª¨ë“œ: ë“±ë¡ëœ ë°”ì½”ë“œì¸ì§€ í™•ì¸
    const boxBarcodes = settings.boxBarcodes || [];
    return boxBarcodes.some(box => box.barcode === identifier);
  } else {
    // ë²ˆí˜¸ ëª¨ë“œ: ìˆ«ìì´ê³  ì„¤ì •ëœ ìë¦¿ìˆ˜ì¸ì§€ í™•ì¸
    const digits = parseInt(settings.boxDigits) || 3;
    return identifier.length === digits && /^\d+$/.test(identifier);
  }
}

// ë°•ìŠ¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸° - í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ
function getBoxInfoFromSettings(identifier) {
  console.log('=== getBoxInfoFromSettings ì‹œì‘ ===');
  
  const settings = AppState.settings;
  
  if (!settings) {
    console.error('ì„¤ì •ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
    return null;
  }
  
  // 1. ë¨¼ì € ë“±ë¡ëœ ë°•ìŠ¤ ë°”ì½”ë“œì—ì„œ í™•ì¸ (ëª¨ë“œì™€ ê´€ê³„ì—†ì´)
  const boxBarcodes = settings.boxBarcodes || [];
  console.log('ë“±ë¡ëœ ë°•ìŠ¤ ë°”ì½”ë“œ ëª©ë¡:', boxBarcodes);
  
  const registeredBox = boxBarcodes.find(box => box.barcode === identifier);
  if (registeredBox) {
    console.log('ë“±ë¡ëœ ë°•ìŠ¤ ë°”ì½”ë“œ ì°¾ìŒ:', registeredBox);
    return registeredBox;
  }
  
  // 2. ë²ˆí˜¸ ëª¨ë“œì¼ ë•Œ ìˆ«ì íŒ¨í„´ í™•ì¸
  if (settings.boxMode === 'number') {
    const digits = parseInt(settings.boxDigits) || 3;
    const pattern = new RegExp(`^\\d{${digits}}$`);
    
    if (pattern.test(identifier)) {
      const boxInfo = {
        barcode: identifier,
        name: `ë°•ìŠ¤ ${identifier}`,
        isAutoNumber: true
      };
      console.log('ë²ˆí˜¸ ëª¨ë“œ ë°•ìŠ¤ë¡œ ì¸ì‹:', boxInfo);
      return boxInfo;
    }
  }
  
  console.log('ë°•ìŠ¤ê°€ ì•„ë‹˜ - ì œí’ˆ ë°”ì½”ë“œë¡œ íŒë‹¨');
  return null;
}

// ë°•ìŠ¤ ì‹œì‘ í•¨ìˆ˜ - ë²ˆí˜¸ ë°©ì‹
function startBoxWithNumber(boxNumber) {
  ShippingState.currentBox = {
    number: boxNumber,
    barcode: boxNumber,
    name: `ë°•ìŠ¤ ${boxNumber}`,
    items: {},
    startTime: new Date().toISOString() // Date ê°ì²´ ëŒ€ì‹  ISO ë¬¸ìì—´ë¡œ
  };
  
  ShippingState.scanState = 'SCANNING';
  
  // UI ì—…ë°ì´íŠ¸
  document.getElementById('status-text').textContent = `ë°•ìŠ¤ ${boxNumber} ìŠ¤ìº” ì¤‘`;
  
  // ë°•ìŠ¤ ì§„í–‰ìƒí™© ì„¹ì…˜ ì¶”ê°€
  const container = document.querySelector('.shipping-container');
  const progressSection = document.getElementById('box-progress-section');
  
  if (!progressSection) {
    const scanSection = document.querySelector('.scan-input-section');
    const newProgressSection = document.createElement('div');
    newProgressSection.className = 'box-progress-section';
    newProgressSection.id = 'box-progress-section';
    newProgressSection.innerHTML = `
      <div class="box-header">
        <h4>ë°•ìŠ¤ ${boxNumber} ì§„í–‰ ì¤‘</h4>
        <button class="btn btn-sm btn-secondary" onclick="forceCompleteBox()">
          ê°•ì œ ì™„ë£Œ
        </button>
      </div>
      <div class="box-items-summary" id="box-items-summary"></div>
    `;
    scanSection.insertAdjacentElement('afterend', newProgressSection);
  }
  
  updateBoxProgress();
  
  speak(`ë°•ìŠ¤ ${boxNumber} ì‹œì‘`);
  showScanFeedback(`ë°•ìŠ¤ ${boxNumber} ìŠ¤ìº” ì‹œì‘`, 'success');
  
  // ì„¸ì…˜ ì €ì¥
  saveShippingSession();
}

// handleBoxScan í•¨ìˆ˜ ìˆ˜ì •
function handleBoxScan(boxBarcode, boxInfo) {
  if (ShippingState.isSaving) {
    speak('ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
    showError('ì´ì „ ë°•ìŠ¤ë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤.');
    return;
  }
  
  if (!ShippingState.currentBox.barcode) {
    // ìƒˆ ë°•ìŠ¤ ì‹œì‘ - ìŒì„± ì•ˆë‚´ëŠ” startBoxWithBarcodeì—ì„œë§Œ
    startBoxWithBarcode(boxBarcode, boxInfo);
  } else if (boxBarcode === ShippingState.currentBox.barcode) {
    // ê°™ì€ ë°•ìŠ¤ ë°”ì½”ë“œ = ë°•ìŠ¤ ì™„ë£Œ
    if (Object.keys(ShippingState.currentBox.items).length === 0) {
      speak('ì˜¤ë¥˜. ìŠ¤ìº”ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
      showError('ìŠ¤ìº”ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    completeBox();
  } else {
    // ë‹¤ë¥¸ ë°•ìŠ¤ ë°”ì½”ë“œ = ë°•ìŠ¤ ì „í™˜
    if (Object.keys(ShippingState.currentBox.items).length === 0) {
      resetBoxState();
      startBoxWithBarcode(boxBarcode, boxInfo);
    } else {
      completeBox(() => {
        startBoxWithBarcode(boxBarcode, boxInfo);
      });
    }
  }
}

// completeBox í•¨ìˆ˜ë„ ìˆ˜ì • í•„ìš”
function completeBox(callback) {
  if (!ShippingState.currentBox.barcode) {
    speak('ì˜¤ë¥˜. ì§„í–‰ ì¤‘ì¸ ë°•ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤');
    showError('ì§„í–‰ ì¤‘ì¸ ë°•ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  if (Object.keys(ShippingState.currentBox.items).length === 0) {
    speak('ì˜¤ë¥˜. ìŠ¤ìº”ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
    showError('ìŠ¤ìº”ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  if (ShippingState.isSaving) {
    speak('ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
    showError('ì´ì „ ë°•ìŠ¤ë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const boxNumber = ShippingState.currentBox.number;
  const itemCount = Object.values(ShippingState.currentBox.items)
    .reduce((sum, item) => sum + item.scannedInThisBox, 0);
  
  // ë¡œë”© ëª¨ë‹¬ í‘œì‹œ
  showLoading(`${boxNumber}ë²ˆ ë°•ìŠ¤ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...`);
  
  // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
  updateUIForBoxCompletion();
  
  // ì €ì¥ ìƒíƒœ ì„¤ì •
  ShippingState.isSaving = true;
  
  google.script.run
    .withSuccessHandler(function(result) {
      ShippingState.isSaving = false;
      hideLoading(); // ë¡œë”© ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
      
      if (result.success) {
        updateLocalStateAfterBoxComplete();
        ShippingState.currentBoxNumber++;
        
        // ì„œë²„ì— ë°•ìŠ¤ë²ˆí˜¸ ì—…ë°ì´íŠ¸
        google.script.run
          .setOrderBoxNumber(AppState.currentOrderInfo.orderId, ShippingState.currentBoxNumber);
        
        resetBoxState();
        
        speak(`${boxNumber}ë²ˆ ë°•ìŠ¤ ì™„ë£Œ`);
        showQuickSuccess(`${boxNumber}ë²ˆ ë°•ìŠ¤ ì™„ë£Œ (${itemCount}ê°œ)`);
        
        // ì™„ë£Œ í›„ ì„¸ì…˜ ì €ì¥
        saveShippingSession();
        
        if (callback) callback();
      } else {
        ShippingState.isSaving = false;
        speak('ì˜¤ë¥˜. ì €ì¥ ì‹¤íŒ¨');
        showError('ì €ì¥ ì‹¤íŒ¨: ' + result.message);
        rollbackBoxCompletion();
      }
    })
    .withFailureHandler(function(error) {
      ShippingState.isSaving = false;
      hideLoading(); // ë¡œë”© ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
      speak('ì˜¤ë¥˜. ì €ì¥ ì‹¤íŒ¨');
      showError('ì €ì¥ ì‹¤íŒ¨: ' + error);
      rollbackBoxCompletion();
    })
    .saveShippingData(AppState.currentOrderInfo.orderId, {
      boxBarcode: ShippingState.currentBox.barcode,
      boxName: `${boxNumber}ë²ˆ ë°•ìŠ¤`,
      items: Object.values(ShippingState.currentBox.items)
    });
}

function handleBarcodeScan(barcode) {
  console.log('ìŠ¤ìº”ëœ ë°”ì½”ë“œ:', barcode, 'í˜„ì¬ ë°•ìŠ¤:', ShippingState.currentBox);
  
  // ë“±ë¡ëœ ë°•ìŠ¤ ë°”ì½”ë“œì¸ì§€ í™•ì¸
  const boxInfo = getBoxInfoFromSettings(barcode);
  
  if (boxInfo) {
    // ë°•ìŠ¤ ë°”ì½”ë“œì¸ ê²½ìš°
    handleBoxScan(barcode, boxInfo);
    return;
  }
  
  // ë°•ìŠ¤ ë°”ì½”ë“œê°€ ì•„ë‹Œ ê²½ìš° = ì œí’ˆ ë°”ì½”ë“œ
  // í˜„ì¬ ë°•ìŠ¤ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
  if (!ShippingState.currentBox.barcode) {
    speak('ì˜¤ë¥˜. ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ë¨¼ì € ìŠ¤ìº”í•˜ì„¸ìš”');
    showError('ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ë¨¼ì € ìŠ¤ìº”í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ì œí’ˆ ìŠ¤ìº” ì²˜ë¦¬
  handleProductScan(barcode);
}

function getBoxInfoFromSettings(identifier) {
  console.log('=== getBoxInfoFromSettings ì‹œì‘ ===');
  console.log('ì°¾ëŠ” ë°”ì½”ë“œ:', identifier);
  
  const settings = AppState.settings;
  
  if (!settings) {
    console.error('ì„¤ì •ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
    return null;
  }
  
  // ì„¤ì • ìƒíƒœ ì¶œë ¥
  console.log('í˜„ì¬ ì„¤ì •:', {
    boxMode: settings.boxMode,
    boxBarcodes: settings.boxBarcodes,
    boxDigits: settings.boxDigits
  });
  
  // ë“±ë¡ëœ ë°•ìŠ¤ ë°”ì½”ë“œ í™•ì¸
  const boxBarcodes = settings.boxBarcodes || [];
  
  // ê° ë°•ìŠ¤ ë°”ì½”ë“œ ìƒì„¸ ì¶œë ¥
  boxBarcodes.forEach((box, index) => {
    console.log(`ë°•ìŠ¤ ${index + 1}:`, {
      barcode: box.barcode,
      name: box.name,
      ì¼ì¹˜ì—¬ë¶€: box.barcode === identifier
    });
  });
  
  const registeredBox = boxBarcodes.find(box => box.barcode === identifier);
  
  if (registeredBox) {
    console.log('âœ… ë“±ë¡ëœ ë°•ìŠ¤ ì°¾ìŒ:', registeredBox);
    return registeredBox;
  }
  
  console.log('âŒ ë“±ë¡ëœ ë°•ìŠ¤ì—ì„œ ì°¾ì§€ ëª»í•¨');
  
  // ë²ˆí˜¸ ëª¨ë“œ ì²´í¬ëŠ” ë“±ë¡ëœ ë°•ìŠ¤ê°€ ì—†ì„ ë•Œë§Œ
  if (settings.boxMode === 'number' && boxBarcodes.length === 0) {
    const digits = parseInt(settings.boxDigits) || 3;
    const pattern = new RegExp(`^\\d{${digits}}$`);
    
    if (pattern.test(identifier)) {
      const boxInfo = {
        barcode: identifier,
        name: `ë°•ìŠ¤ ${identifier}`,
        isAutoNumber: true
      };
      console.log('ë²ˆí˜¸ ëª¨ë“œ ë°•ìŠ¤ë¡œ ì¸ì‹:', boxInfo);
      return boxInfo;
    }
  }
  
  console.log('ë°•ìŠ¤ê°€ ì•„ë‹˜ - ì œí’ˆ ë°”ì½”ë“œë¡œ íŒë‹¨');
  return null;
}

function handleProductScan(barcode) {
  console.log('ì œí’ˆ ìŠ¤ìº”:', barcode);
  
  const item = ShippingState.exportedItems.find(i => i.barcode === barcode);
  
  if (!item) {
    speak('ì˜¤ë¥˜. ì¶œê³  ëª©ë¡ì— ì—†ëŠ” ì œí’ˆì…ë‹ˆë‹¤');
    showScanFeedback('ì¶œê³  ëª©ë¡ì— ì—†ëŠ” ë°”ì½”ë“œì…ë‹ˆë‹¤', 'error');
    return;
  }
  
  // í˜„ì¬ ë°•ìŠ¤ì— ì¶”ê°€
  if (!ShippingState.currentBox.items[barcode]) {
    ShippingState.currentBox.items[barcode] = {
      ...item,
      scannedInThisBox: 0,
      justScanned: false
    };
  }
  
  const boxItem = ShippingState.currentBox.items[barcode];
  
  // ìˆ˜ëŸ‰ ì²´í¬
  if (boxItem.scannedInThisBox < item.remainingQuantity) {
    boxItem.scannedInThisBox++;
    boxItem.justScanned = true; // ì• ë‹ˆë©”ì´ì…˜ í”Œë˜ê·¸
    
    updateShippingItemUI(barcode);
    updateBoxProgress();
    
    // ì• ë‹ˆë©”ì´ì…˜ í›„ í”Œë˜ê·¸ ì œê±°
    setTimeout(() => {
      if (ShippingState.currentBox.items[barcode]) {
        ShippingState.currentBox.items[barcode].justScanned = false;
        updateBoxProgress();
      }
    }, 300);
    
    speak('ì •ìƒ');
    showScanFeedback(`${item.name} - ${boxItem.scannedInThisBox}/${item.remainingQuantity}`, 'success');
  } else {
    // ì´ˆê³¼ ìˆ˜ëŸ‰
    speak('ì˜¤ë¥˜. ìˆ˜ëŸ‰ ì´ˆê³¼');
    showExcessQuantityModal(item, boxItem);
  }
}

// ë°•ìŠ¤ ì‹œì‘
function startBoxWithBarcode(boxBarcode, boxInfo) {
  ShippingState.currentBox = {
    barcode: boxBarcode,
    name: boxInfo.name,
    items: {},
    startTime: new Date().toISOString(),
    number: ShippingState.currentBoxNumber
  };
  
  ShippingState.scanState = 'SCANNING';
  
  document.getElementById('status-text').textContent = `${ShippingState.currentBoxNumber}ë²ˆ ë°•ìŠ¤ ìŠ¤ìº” ì¤‘`;
  
  // ë°•ìŠ¤ ì§„í–‰ìƒí™© ì„¹ì…˜ ë³´ì´ê¸°
  const progressSection = document.getElementById('box-progress-section');
  if (progressSection) {
    progressSection.style.display = '';
    
    // ì œëª© ì—…ë°ì´íŠ¸
    const titleEl = document.getElementById('box-progress-title');
    if (titleEl) {
      titleEl.textContent = `${ShippingState.currentBoxNumber}ë²ˆ ë°•ìŠ¤ ì§„í–‰ ì¤‘ (${boxInfo.name})`;
    }
  }
  
  updateBoxProgress();
  
  // ìŒì„± ì•ˆë‚´
  speak(`${ShippingState.currentBoxNumber}ë²ˆ ë°•ìŠ¤ ì‹œì‘`);
  showScanFeedback(`${ShippingState.currentBoxNumber}ë²ˆ ë°•ìŠ¤ ìŠ¤ìº” ì‹œì‘`, 'success');
  
  saveShippingSession();
}

AppState.voiceSettings = {
  volume: 0.8,
  rate: 1.2,
  pitch: 1.0,
  language: 'ko-KR'
};

// ê°œì„ ëœ speak í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ êµì²´)
function speak(text) {
  if (!text || typeof text !== 'string') return;
  
  try {
    // ìŒì„± í•©ì„± ì§€ì› í™•ì¸
    if (!window.speechSynthesis) {
      console.warn('ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
      return;
    }
    
    // ì´ì „ ìŒì„± ì¤‘ë‹¨
    speechSynthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(text);
    const settings = AppState.voiceSettings;
    
    // ìŒì„± ì„¤ì • ì ìš©
    utterance.volume = settings.volume;
    utterance.rate = settings.rate;
    utterance.pitch = settings.pitch;
    utterance.lang = settings.language;
    
    // ì˜¤ë¥˜ ì²˜ë¦¬
    utterance.onerror = function(event) {
      console.warn('ìŒì„± í•©ì„± ì˜¤ë¥˜:', event.error);
    };
    
    speechSynthesis.speak(utterance);
  } catch (error) {
    console.error('speak í•¨ìˆ˜ ì˜¤ë¥˜:', error);
  }
}

// ìŒì„± ì„¤ì • ë¡œë“œ í•¨ìˆ˜
async function loadVoiceSettings() {
  return new Promise((resolve) => {
    google.script.run
      .withSuccessHandler((settings) => {
        if (settings && settings.voiceSettings) {
          AppState.voiceSettings = settings.voiceSettings;
          console.log('ìŒì„± ì„¤ì • ë¡œë“œë¨:', AppState.voiceSettings);
        }
        resolve(AppState.voiceSettings);
      })
      .withFailureHandler((error) => {
        console.warn('ìŒì„± ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
        resolve(AppState.voiceSettings); // ê¸°ë³¸ê°’ ì‚¬ìš©
      })
      .getVoiceSettings();
  });
}

// ìŒì„± ì„¤ì • ì €ì¥ í•¨ìˆ˜
function saveVoiceSettings() {
  const volume = parseFloat(document.getElementById('voice-volume').value);
  const rate = parseFloat(document.getElementById('voice-rate').value);
  const pitch = parseFloat(document.getElementById('voice-pitch').value);
  const language = document.getElementById('voice-language').value;
  
  const voiceSettings = {
    volume: volume,
    rate: rate,
    pitch: pitch,
    language: language
  };
  
  // ë¡œì»¬ ì„¤ì • ì¦‰ì‹œ ì ìš©
  AppState.voiceSettings = voiceSettings;
  
  // ì„œë²„ì— ì €ì¥
  showSaveIndicator('saving');
  
  google.script.run
    .withSuccessHandler((result) => {
      showSaveIndicator('hide');
      if (result.success) {
        showQuickSuccess('ìŒì„± ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        showError('ìŒì„± ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + result.message);
      }
    })
    .withFailureHandler((error) => {
      showSaveIndicator('hide');
      showError('ìŒì„± ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + error);
    })
    .saveVoiceSettings(voiceSettings);
}

// ìŒì„± í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function testVoiceSettings() {
  const testText = getVoiceTestText();
  speak(testText);
}

// ì–¸ì–´ë³„ í…ŒìŠ¤íŠ¸ í…ìŠ¤íŠ¸
function getVoiceTestText() {
  const language = AppState.voiceSettings.language;
  const testTexts = {
    'ko-KR': 'ìŒì„± ì„¤ì • í…ŒìŠ¤íŠ¸. ë¬¼ë¥˜íŒ€ í™”ì´íŒ…!!!',
    'ja-JP': 'éŸ³å£°è¨­å®šã®ãƒ†ã‚¹ãƒˆã€‚ç‰©æµãƒãƒ¼ãƒ é ‘å¼µã‚Œï¼ï¼ï¼',
    'en-US': 'Voice settings test. Logistics team, cheer up!!!'
  };
  
  return testTexts[language] || testTexts['ko-KR'];
}

// ì„¤ì • íƒ­ ë¡œë“œ ì‹œ ìŒì„± ì„¤ì • í‘œì‹œ
function displayVoiceSettings() {
  const settings = AppState.voiceSettings;
  
  // í¼ ìš”ì†Œì— í˜„ì¬ ì„¤ì • ê°’ ì ìš©
  const volumeInput = document.getElementById('voice-volume');
  const rateInput = document.getElementById('voice-rate');
  const pitchInput = document.getElementById('voice-pitch');
  const languageSelect = document.getElementById('voice-language');
  
  if (volumeInput) {
    volumeInput.value = settings.volume;
    document.getElementById('voice-volume-value').textContent = Math.round(settings.volume * 100) + '%';
  }
  
  if (rateInput) {
    rateInput.value = settings.rate;
    document.getElementById('voice-rate-value').textContent = settings.rate + 'x';
  }
  
  if (pitchInput) {
    pitchInput.value = settings.pitch;
    document.getElementById('voice-pitch-value').textContent = settings.pitch;
  }
  
  if (languageSelect) {
    languageSelect.value = settings.language;
  }
}

// ìŠ¬ë¼ì´ë” ê°’ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
function updateVoiceSliderValue(sliderId, valueId, unit = '') {
  const slider = document.getElementById(sliderId);
  const valueDisplay = document.getElementById(valueId);
  
  if (slider && valueDisplay) {
    let displayValue = parseFloat(slider.value);
    
    if (sliderId === 'voice-volume') {
      displayValue = Math.round(displayValue * 100) + '%';
    } else if (sliderId === 'voice-rate') {
      displayValue = displayValue + 'x';
    } else {
      displayValue = displayValue + unit;
    }
    
    valueDisplay.textContent = displayValue;
    
    // ì‹¤ì‹œê°„ìœ¼ë¡œ ë¡œì»¬ ì„¤ì • ì—…ë°ì´íŠ¸ (í…ŒìŠ¤íŠ¸ìš©)
    if (sliderId === 'voice-volume') {
      AppState.voiceSettings.volume = parseFloat(slider.value);
    } else if (sliderId === 'voice-rate') {
      AppState.voiceSettings.rate = parseFloat(slider.value);
    } else if (sliderId === 'voice-pitch') {
      AppState.voiceSettings.pitch = parseFloat(slider.value);
    }
  }
}

// ì–¸ì–´ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
function updateVoiceLanguage() {
  const language = document.getElementById('voice-language').value;
  AppState.voiceSettings.language = language;
}

// UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
function updateUIForBoxCompletion() {
  Object.entries(ShippingState.currentBox.items).forEach(([barcode, boxItem]) => {
    const item = ShippingState.exportedItems.find(i => i.barcode === barcode);
    if (item) {
      // ë¡œì»¬ remainingQuantity ì—…ë°ì´íŠ¸
      item.remainingQuantity -= boxItem.scannedInThisBox;
      item.scannedQuantity = (item.scannedQuantity || 0) + boxItem.scannedInThisBox;
      
      // ë°•ìŠ¤ì •ë³´ ì¶”ê°€
      const newBoxInfo = `${ShippingState.currentBox.name}(${boxItem.scannedInThisBox})`;
      item.boxNumbers = item.boxNumbers ? 
        `${item.boxNumbers}, ${newBoxInfo}` : 
        newBoxInfo;
    }
  });
  
  // ëª©ë¡ ë‹¤ì‹œ í‘œì‹œ
  displayShippingList();
}

// ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateLocalStateAfterBoxComplete() {
  // ì™„ë£Œëœ í•­ëª© ì œê±°
  ShippingState.exportedItems = ShippingState.exportedItems
    .filter(item => item.remainingQuantity > 0);
}

// ë°•ìŠ¤ ìƒíƒœ ì´ˆê¸°í™”
function resetBoxState() {
  ShippingState.currentBox = {
    barcode: null,
    name: null,
    items: {},
    startTime: null
  };
  
  ShippingState.scanState = 'READY';
  
  // UI ì—…ë°ì´íŠ¸
  document.getElementById('status-text').textContent = 'ë°•ìŠ¤ ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”';
  
  // ë°•ìŠ¤ ì§„í–‰ìƒí™© ì„¹ì…˜ ìˆ¨ê¸°ê¸°
  const progressSection = document.getElementById('box-progress-section');
  if (progressSection) {
    progressSection.style.display = 'none';
  }
  
  // í”¼ë“œë°± ì´ˆê¸°í™”
  const feedback = document.getElementById('scan-feedback');
  if (feedback) {
    feedback.textContent = '';
    feedback.className = 'scan-feedback';
  }
  
  // ì„¸ì…˜ ì €ì¥
  saveShippingSession();
}

// ê°•ì œ ì™„ë£Œ
function forceCompleteBox() {
  if (confirm('í˜„ì¬ ë°•ìŠ¤ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    completeBox();
  }
}

// ìŠ¤ìº” í”¼ë“œë°± í‘œì‹œ
function showScanFeedback(message, type) {
  const feedback = document.getElementById('scan-feedback');
  if (feedback) {
    feedback.textContent = message;
    feedback.className = `scan-feedback ${type}`;
    
    clearTimeout(ShippingState.feedbackTimer);
    ShippingState.feedbackTimer = setTimeout(() => {
      feedback.className = 'scan-feedback';
      feedback.textContent = '';
    }, 3000);
  }
}

// ì¶œê³  ëª©ë¡ í‘œì‹œ
function displayShippingList() {
  const container = document.getElementById('shipping-list');
  const summary = document.getElementById('list-summary');
  
  if (!ShippingState.exportedItems || ShippingState.exportedItems.length === 0) {
    container.innerHTML = '<div class="empty-message">ì¶œê³  ì™„ë£Œ</div>';
    summary.textContent = '';
    return;
  }
  
  const totalItems = ShippingState.exportedItems.length;
  const totalQuantity = ShippingState.exportedItems
    .reduce((sum, item) => sum + item.remainingQuantity, 0);
  
  summary.textContent = `${totalItems}ê°œ ìƒí’ˆ, ì´ ${totalQuantity}ê°œ`;
  
  // ê¸°ì¡´ ì»¬ëŸ¬ì¹© ê´€ë ¨ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
  const displaySettings = loadDisplaySettings();
  
  container.innerHTML = ShippingState.exportedItems.map(item => {
    const progress = item.scannedQuantity || 0;
    const total = item.quantity;
    const progressPercent = total > 0 ? (progress / total * 100) : 0;
    const isCompleted = item.remainingQuantity === 0;
    
    // ë°•ìŠ¤ ì •ë³´ í¬ë§· ê°œì„ 
    let boxInfo = '';
    if (item.boxNumbers) {
      boxInfo = item.boxNumbers.replace(/(\d+)\((\d+)\)/g, '$1ë²ˆ($2ê°œ)')
                              .replace(/\), /g, ') / ');
    }
    
    // ì»¬ëŸ¬/ì‚¬ì´ì¦ˆ ì •ë³´ íŒŒì‹±
    const colorSizeInfo = parseColorSize(item.option);
    let optionHtml = '';
    
    if (item.option && colorSizeInfo.color) {
      optionHtml = `
        <div class="item-option-with-color">
          ${displaySettings.colorChipEnabled !== false && colorSizeInfo.colorHex ? 
            `<span class="color-chip-container">
              <span class="color-chip" style="background-color: ${colorSizeInfo.colorHex}"></span>
              <span class="color-name">${colorSizeInfo.color}</span>
            </span>` : 
            `<span class="color-text">${colorSizeInfo.color}</span>`
          }
          ${colorSizeInfo.size ? `<span class="size-text">${colorSizeInfo.size}</span>` : ''}
        </div>
      `;
    } else if (item.option) {
      optionHtml = `<span class="item-option">${item.option}</span>`;
    }
    
    return `
      <div class="shipping-item ${ShippingState.currentBox.items[item.barcode] ? 'scanning' : ''} ${isCompleted ? 'completed' : ''}" 
          data-barcode="${item.barcode}"
          style="background: linear-gradient(to right, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.1) ${progressPercent}%, transparent ${progressPercent}%, transparent 100%);">
        <div class="item-header">
          <div class="item-name">${item.name}</div>
          <div class="item-details">
            ${optionHtml}
          </div>
          <div class="item-barcode">${item.barcode}</div>
        </div>

        <div class="quantity-info">
          <div class="quantity-display">
            <span class="scanned-quantity">${progress}</span>
            <span class="separator">/</span>
            <span class="total-quantity">${total}</span>
          </div>
          <div class="remaining-badge">
            ${isCompleted ? 
              '<strong style="color: #28a745;">âœ“ ì™„ë£Œ</strong>' :
              `ë‚¨ì€ìˆ˜ëŸ‰: <strong>${item.remainingQuantity}</strong>`
            }
          </div>
        </div>
        
        ${boxInfo ? `
          <div class="box-info">
            <span class="box-icon">ğŸ“¦</span>
            <span class="box-numbers">${boxInfo}</span>
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

// ì¬ê³  ìƒíƒœ í´ë˜ìŠ¤
function getStockClass(status) {
  if (status === 'ê°€ëŠ¥') return 'status-available';
  if (status.includes('ê°œë§Œ ê°€ëŠ¥')) return 'status-partial';
  return 'status-default';
}

// ì•„ì´í…œ UI ì—…ë°ì´íŠ¸
function updateShippingItemUI(barcode) {
  requestAnimationFrame(() => {
    const element = document.querySelector(`[data-barcode="${barcode}"]`);
    if (!element) return;
    
    const item = ShippingState.exportedItems.find(i => i.barcode === barcode);
    const boxItem = ShippingState.currentBox.items[barcode];
    
    if (!item || !boxItem) return;
    
    // ì• ë‹ˆë©”ì´ì…˜
    element.classList.add('just-scanned');
    setTimeout(() => element.classList.remove('just-scanned'), 300);
    
    // í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ
    if (!element.classList.contains('scanning')) {
      element.classList.add('scanning');
    }
  });
}

// ë°•ìŠ¤ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
function updateBoxProgress() {
  const summary = document.getElementById('box-items-summary');
  const items = Object.values(ShippingState.currentBox.items);
  
  if (items.length === 0) {
    summary.innerHTML = '<div class="empty-box">ì•„ì§ ìŠ¤ìº”ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  const totalScanned = items.reduce((sum, item) => sum + item.scannedInThisBox, 0);
  const displaySettings = loadDisplaySettings();
  
  summary.innerHTML = `
    <div class="box-summary">
      <div class="summary-stat">
        <span class="stat-label">ìƒí’ˆ ì¢…ë¥˜:</span>
        <span class="stat-value">${items.length}ê°œ</span>
      </div>
      <div class="summary-stat">
        <span class="stat-label">ì´ ìˆ˜ëŸ‰:</span>
        <span class="stat-value">${totalScanned}ê°œ</span>
      </div>
    </div>
    <div class="box-items">
      ${items.map(item => {
        const remaining = item.remainingQuantity - item.scannedInThisBox;
        const colorSizeInfo = parseColorSize(item.option);
        
        let optionHtml = '';
        if (item.option && colorSizeInfo.color) {
          optionHtml = `
            <div class="item-option-with-color">
              ${displaySettings.colorChipEnabled !== false && colorSizeInfo.colorHex ? 
                `<span class="color-chip-container">
                  <span class="color-chip" style="background-color: ${colorSizeInfo.colorHex}"></span>
                  <span class="color-name">${colorSizeInfo.color}</span>
                </span>` : 
                `<span class="color-text">${colorSizeInfo.color}</span>`
              }
              ${colorSizeInfo.size ? `<span class="size-text">${colorSizeInfo.size}</span>` : ''}
            </div>
          `;
        } else if (item.option) {
          optionHtml = `<span class="item-option">${item.option}</span>`;
        }
        
        return `
          <div class="box-item ${item.justScanned ? 'just-scanned' : ''}" data-barcode="${item.barcode}">
            <div class="box-item-info">
              <span class="item-name">${item.name}</span>
              ${optionHtml}
            </div>
            <div class="box-item-qty">
              <span class="item-qty">${item.scannedInThisBox}ê°œ</span>
              <span class="item-remaining">(ë‚¨ì€ìˆ˜ëŸ‰: ${remaining}ê°œ)</span>
            </div>
            <div class="box-item-actions">
              <button class="btn-icon-sm" onclick="adjustBoxItemQuantity('${item.barcode}', -1)" 
                      title="ìˆ˜ëŸ‰ ê°ì†Œ" ${item.scannedInThisBox <= 1 ? 'disabled' : ''}>
                <span>âˆ’</span>
              </button>
              <button class="btn-icon-sm" onclick="adjustBoxItemQuantity('${item.barcode}', 1)" 
                      title="ìˆ˜ëŸ‰ ì¦ê°€" ${remaining <= 0 ? 'disabled' : ''}>
                <span>+</span>
              </button>
              <button class="btn-icon-sm danger" onclick="removeBoxItem('${item.barcode}')" 
                      title="ë°•ìŠ¤ì—ì„œ ì œê±°">
                <span>Ã—</span>
              </button>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

// ë°•ìŠ¤ ì•„ì´í…œ ìˆ˜ëŸ‰ ì¡°ì • í•¨ìˆ˜ ì¶”ê°€
function adjustBoxItemQuantity(barcode, delta) {
  const boxItem = ShippingState.currentBox.items[barcode];
  const exportedItem = ShippingState.exportedItems.find(i => i.barcode === barcode);
  
  if (!boxItem || !exportedItem) return;
  
  const newQuantity = boxItem.scannedInThisBox + delta;
  const maxQuantity = exportedItem.remainingQuantity + boxItem.scannedInThisBox;
  
  if (newQuantity >= 1 && newQuantity <= maxQuantity) {
    boxItem.scannedInThisBox = newQuantity;
    
    // ë‚¨ì€ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
    exportedItem.remainingQuantity = exportedItem.quantity - 
      (exportedItem.scannedQuantity - boxItem.scannedInThisBox + newQuantity);
    
    updateBoxProgress();
    updateShippingItemUI(barcode);
    saveShippingSession();
    
    speak(delta > 0 ? 'ì¶”ê°€' : 'ê°ì†Œ');
    showScanFeedback(`${exportedItem.name} - ${newQuantity}ê°œ`, 'success');
  }
}

function removeBoxItem(barcode) {
  const boxItem = ShippingState.currentBox.items[barcode];
  const exportedItem = ShippingState.exportedItems.find(i => i.barcode === barcode);
  
  if (!boxItem || !exportedItem) return;
  
  if (confirm(`${exportedItem.name}ì„(ë¥¼) ë°•ìŠ¤ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    // ë‚¨ì€ ìˆ˜ëŸ‰ ë³µì›
    exportedItem.remainingQuantity += boxItem.scannedInThisBox;
    
    // ë°•ìŠ¤ì—ì„œ ì œê±°
    delete ShippingState.currentBox.items[barcode];
    
    updateBoxProgress();
    updateShippingItemUI(barcode);
    saveShippingSession();
    
    speak('ì œê±°ë¨');
    showScanFeedback(`${exportedItem.name} ì œê±°ë¨`, 'info');
  }
}

// ì´ˆê³¼ ìˆ˜ëŸ‰ ëª¨ë‹¬
function showExcessQuantityModal(item, boxItem) {
  const modalContent = `
    <div class="excess-modal">
      <h3>âš ï¸ ìˆ˜ëŸ‰ ì´ˆê³¼</h3>
      <div class="item-info">
        <strong>${item.name}</strong>
        ${item.option ? `<span class="option">${item.option}</span>` : ''}
      </div>
      <div class="quantity-status">
        <p>ìš”ì²­ ìˆ˜ëŸ‰: <strong>${item.quantity}ê°œ</strong></p>
        <p>í˜„ì¬ê¹Œì§€ ìŠ¤ìº”: <strong>${item.scannedQuantity || 0}ê°œ</strong></p>
        <p>ì´ë²ˆ ë°•ìŠ¤ ìŠ¤ìº”: <strong>${boxItem.scannedInThisBox}ê°œ</strong></p>
      </div>
      <p class="warning-message">í• ë‹¹ëœ ìˆ˜ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì¶”ê°€ë¡œ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="confirmExcessQuantity('${item.barcode}')">
          ì˜ˆ, ì¶”ê°€ ë°œì†¡
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">
          ì•„ë‹ˆì˜¤
        </button>
      </div>
    </div>
  `;
  
  showModal(modalContent);
}

// ì´ˆê³¼ ìˆ˜ëŸ‰ í™•ì¸
function confirmExcessQuantity(barcode) {
  const item = ShippingState.exportedItems.find(i => i.barcode === barcode);
  const boxItem = ShippingState.currentBox.items[barcode];
  
  if (item && boxItem) {
    boxItem.scannedInThisBox++;
    item.remainingQuantity++; // ì´ˆê³¼ë¶„ ë°˜ì˜
    
    updateShippingItemUI(barcode);
    updateBoxProgress();
    
    speak(`${item.name} ì¶”ê°€ ë°œì†¡`);
    showScanFeedback(`${item.name} - ì¶”ê°€ ë°œì†¡ í™•ì¸`, 'success');
  }
  
  closeModal();
}

// ìë™ ì €ì¥
function startShippingAutoSave() {
  // ê¸°ì¡´ íƒ€ì´ë¨¸ ì œê±°
  if (ShippingState.autoSaveTimer) {
    clearInterval(ShippingState.autoSaveTimer);
  }
  
  // 3ì´ˆë§ˆë‹¤ ì„¸ì…˜ ì €ì¥ (5ì´ˆì—ì„œ 3ì´ˆë¡œ ë‹¨ì¶•)
  ShippingState.autoSaveTimer = setInterval(() => {
    // í˜„ì¬ ë°•ìŠ¤ì— í•­ëª©ì´ ìˆì„ ë•Œë§Œ ì €ì¥
    if (ShippingState.currentBox.barcode && 
        Object.keys(ShippingState.currentBox.items).length > 0) {
      saveShippingSession();
    }
  }, 3000); // 3ì´ˆë¡œ ë³€ê²½
}

// ì„¸ì…˜ ì €ì¥
// saveShippingSession í•¨ìˆ˜ ìˆ˜ì •
function saveShippingSession() {
  // exportedItems ì œì™¸í•œ ì»´íŒ©íŠ¸ ì„¸ì…˜
  const compactSession = {
    currentBox: ShippingState.currentBox,
    currentBoxNumber: ShippingState.currentBoxNumber,
    scanState: ShippingState.scanState,
    lastActivity: new Date().toISOString(),
    orderId: AppState.currentOrderInfo?.orderId
  };
  
  // 1. localStorageëŠ” ì „ì²´ ë°ì´í„° ì €ì¥ (ì œí•œ ì—†ìŒ)
  try {
    const fullSession = {
      ...compactSession,
      exportedItems: ShippingState.exportedItems
    };
    localStorage.setItem('shippingSession', JSON.stringify(fullSession));
  } catch (e) {
    console.warn('ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨:', e);
  }
  
  // 2. ì„œë²„ëŠ” ì»´íŒ©íŠ¸ ë²„ì „ ì €ì¥
  const now = Date.now();
  const timeSinceLastSave = now - (ShippingState.lastServerSaveTime || 0);
  
  if (!ShippingState.lastServerSaveTime || 
      timeSinceLastSave > 5000 || 
      ShippingState.scanState === 'COMPLETING') {
    
    google.script.run
      .withSuccessHandler((result) => {
        ShippingState.lastServerSaveTime = now;
        console.log(`ì„œë²„ ì„¸ì…˜ ì €ì¥ ì™„ë£Œ (${result.location}, ${result.size} bytes)`);
      })
      .withFailureHandler((error) => {
        console.warn('ì„œë²„ ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨:', error);
      })
      .saveShippingSession(compactSession);
  }
}

// ì„¸ì…˜ ë³µì› í•¨ìˆ˜ ìˆ˜ì •
function restoreShippingSession() {
  // ê°•ì œ ë¦¬í”„ë ˆì‹œ í”Œë˜ê·¸ í™•ì¸
  const forceRefresh = sessionStorage.getItem('forceRefreshShipping');
  if (forceRefresh === 'true') {
    sessionStorage.removeItem('forceRefreshShipping');
    localStorage.removeItem('shippingSession');
    return false;
  }
  
  // 1. ë¨¼ì € localStorage í™•ì¸ (ë¹ ë¥¸ ë³µì›)
  try {
    const localSession = localStorage.getItem('shippingSession');
    if (localSession) {
      const sessionData = JSON.parse(localSession);
      
      // ì„¸ì…˜ ìœ íš¨ì„± ê²€ì‚¬
      const sessionAge = Date.now() - new Date(sessionData.lastActivity).getTime();
      const isValidSession = sessionData.orderId === AppState.currentOrderInfo?.orderId && 
                            sessionAge < 30 * 24 * 60 * 60 * 1000; // 30ì¼ë¡œ ë³€ê²½
      
      if (isValidSession && sessionData.currentBox?.barcode) {
        applyShippingSession(sessionData);
        
        // ì„¸ì…˜ ë‚˜ì´ì— ë”°ë¥¸ ë©”ì‹œì§€
        const ageMessage = getSessionAgeMessage(sessionAge);
        showInfo(`ì´ì „ ì‘ì—…ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤. (${ageMessage})`);
        
        console.log('ë¡œì»¬ ì„¸ì…˜ ë³µì›ë¨');
        
        // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì„œë²„ ì„¸ì…˜ë„ í™•ì¸
        checkServerSession();
        return true;
      } else if (!isValidSession) {
        // ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ ì‚­ì œ
        localStorage.removeItem('shippingSession');
      }
    }
  } catch (e) {
    console.warn('ë¡œì»¬ ì„¸ì…˜ ë³µì› ì‹¤íŒ¨:', e);
    localStorage.removeItem('shippingSession');
  }
  
  // 2. localStorageê°€ ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ í™•ì¸
  google.script.run
    .withSuccessHandler(function(sessionData) {
      if (sessionData && sessionData.orderId === AppState.currentOrderInfo?.orderId) {
        const sessionAge = Date.now() - new Date(sessionData.lastActivity).getTime();
        
        if (sessionAge < 7 * 24 * 60 * 60 * 1000 && sessionData.currentBox?.barcode) {
          applyShippingSession(sessionData);
          
          // ë¡œì»¬ì—ë„ ì €ì¥
          localStorage.setItem('shippingSession', JSON.stringify(sessionData));
          
          const ageMessage = getSessionAgeMessage(sessionAge);
          showInfo(`ì´ì „ ì‘ì—…ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤. (${ageMessage})`);
          displayShippingInterface();
        }
      }
    })
    .withFailureHandler((error) => {
      console.warn('ì„œë²„ ì„¸ì…˜ ë³µì› ì‹¤íŒ¨:', error);
    })
    .getShippingSession();
  
  return false;
}

// ì„¸ì…˜ ë‚˜ì´ ë©”ì‹œì§€ í—¬í¼
function getSessionAgeMessage(ageMs) {
  const minutes = Math.floor(ageMs / (1000 * 60));
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);
  
  if (days > 0) {
    return `${days}ì¼ ì „`;
  } else if (hours > 0) {
    return `${hours}ì‹œê°„ ì „`;
  } else if (minutes > 0) {
    return `${minutes}ë¶„ ì „`;
  } else {
    return 'ë°©ê¸ˆ ì „';
  }
}

// ì„œë²„ ì„¸ì…˜ í™•ì¸ (ë°±ê·¸ë¼ìš´ë“œ)
function checkServerSession() {
  google.script.run
    .withSuccessHandler(function(serverSession) {
      if (serverSession && serverSession.lastActivity) {
        const localSession = JSON.parse(localStorage.getItem('shippingSession') || '{}');
        
        // ì„œë²„ê°€ ë” ìµœì‹ ì´ë©´ ì—…ë°ì´íŠ¸
        if (new Date(serverSession.lastActivity) > new Date(localSession.lastActivity || 0)) {
          applyShippingSession(serverSession);
          localStorage.setItem('shippingSession', JSON.stringify(serverSession));
          console.log('ì„œë²„ ì„¸ì…˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨');
        }
      }
    })
    .getShippingSession();
}

// ì‹œê°„ í‘œì‹œ í—¬í¼
function formatTimeAgo(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now - date;
  
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const days = Math.floor(hours / 24);
  
  if (days > 0) {
    return `${days}ì¼ ì „`;
  } else if (hours > 0) {
    return `${hours}ì‹œê°„ ì „`;
  } else {
    const minutes = Math.floor(diff / (1000 * 60));
    return `${minutes}ë¶„ ì „`;
  }
}

// ì„¸ì…˜ ì ìš©
function applyShippingSession(sessionData) {
  console.log('ì„¸ì…˜ ì ìš© ì‹œì‘:', sessionData);
  
  // í˜„ì¬ ë°•ìŠ¤ ì •ë³´ ë³µì›
  if (sessionData.currentBox && sessionData.currentBox.barcode) {
    ShippingState.currentBox = sessionData.currentBox;
    ShippingState.scanState = sessionData.scanState || 'SCANNING';
    
    console.log('ë°•ìŠ¤ ì •ë³´ ë³µì›ë¨:', ShippingState.currentBox);
  }
  
  // ë‚´ë³´ë‚´ê¸° í•­ëª© ë³µì›
  if (sessionData.exportedItems) {
    ShippingState.exportedItems = sessionData.exportedItems;
  }
  
  // ë°•ìŠ¤ ë²ˆí˜¸ ë³µì›
  if (sessionData.currentBoxNumber) {
    ShippingState.currentBoxNumber = sessionData.currentBoxNumber;
  }
}

// ===== íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ í•¨ìˆ˜ë“¤ =====

// íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ ë‚´ë³´ë‚´ê¸°
function exportPackingList() {
  // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë°•ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸
  if (ShippingState.currentBox.barcode && Object.keys(ShippingState.currentBox.items).length > 0) {
    showError('ë°•ìŠ¤ íŒ¨í‚¹ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‘ì—… ì™„ë£Œ í›„ ë‚´ë³´ë‚´ê¸°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!AppState.currentOrderInfo || !AppState.currentOrderInfo.orderId) {
    showError('ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  showLoading('íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        showQuickSuccess(result.message);
      } else {
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error);
    })
    .exportPackingList(AppState.currentOrderInfo.orderId);
}

// íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ ë³´ê¸°
function viewPackingList() {
  if (!AppState.currentOrderInfo || !AppState.currentOrderInfo.orderId) {
    showError('ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success && result.sheetUrl) {
        window.open(result.sheetUrl, '_blank');
      } else {
        showError(result.message || 'íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    })
    .withFailureHandler(function(error) {
      showError('ì‹œíŠ¸ ì—´ê¸° ì‹¤íŒ¨: ' + error);
    })
    .getPackingListUrl(AppState.currentOrderInfo.orderId);
}

// íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ
function downloadPackingList() {
  if (!AppState.currentOrderInfo || !AppState.currentOrderInfo.orderId) {
    showError('ë°œì£¼ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  showLoading('CSV íŒŒì¼ ìƒì„± ì¤‘...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideLoading();
      
      if (result.success) {
        // CSV ë‹¤ìš´ë¡œë“œ
        const blob = new Blob([result.csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = result.filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showQuickSuccess('ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        showError(result.message);
      }
    })
    .withFailureHandler(function(error) {
      hideLoading();
      showError('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error);
    })
    .downloadPackingListCSV(AppState.currentOrderInfo.orderId);
}

// ì¶œê³  ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ í•¨ìˆ˜ ìˆ˜ì •
const originalDisplayShippingInterface = displayShippingInterface;
displayShippingInterface = function() {
  originalDisplayShippingInterface();
  
  // íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ ë²„íŠ¼ ì¶”ê°€
  const boxStatusBar = document.querySelector('.box-status-bar');
  if (boxStatusBar && !document.getElementById('packing-list-buttons')) {
    const packingListButtons = document.createElement('div');
    packingListButtons.id = 'packing-list-buttons';
    packingListButtons.className = 'packing-list-buttons';
    packingListButtons.innerHTML = `
      <button class="btn btn-primary" onclick="exportPackingList()" title="íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ ë‚´ë³´ë‚´ê¸°">
        ğŸ“¤ ë‚´ë³´ë‚´ê¸°
      </button>
      <button class="btn btn-secondary" onclick="viewPackingList()" title="íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ ë³´ê¸°">
        ğŸ“‹ íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸
      </button>
      <button class="btn btn-secondary" onclick="downloadPackingList()" title="CSV ë‹¤ìš´ë¡œë“œ">
        ğŸ’¾ ë‹¤ìš´ë¡œë“œ
      </button>
    `;
    
    boxStatusBar.appendChild(packingListButtons);
  }
};

// getPackingListUrl í•¨ìˆ˜ë¥¼ ìœ„í•œ ì„œë²„ í•¨ìˆ˜ ì¶”ê°€ (Code.gsì— ì¶”ê°€)
function getPackingListUrl(orderId) {
  try {
    const ss = SpreadsheetApp.openById(orderId);
    const packingSheet = ss.getSheetByName('íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸');
    
    if (packingSheet) {
      return {
        sheetUrl: ss.getUrl() + '#gid=' + packingSheet.getSheetId()
      };
    }
    
    return { sheetUrl: null };
  } catch (error) {
    console.error('íŒ¨í‚¹ë¦¬ìŠ¤íŠ¸ URL ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    return { sheetUrl: null };
  }
}

// íƒ­ ì „í™˜ ì‹œ ì •ë¦¬
function cleanupShippingTab() {
  if (ShippingState.autoSaveTimer) {
    clearInterval(ShippingState.autoSaveTimer);
    ShippingState.autoSaveTimer = null;
  }
  
  // ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ìˆìœ¼ë©´ ì„¸ì…˜ ì €ì¥
  if (ShippingState.scanState !== 'IDLE') {
    saveShippingSession();
  }
}

// ë¡¤ë°± í•¨ìˆ˜
function rollbackBoxCompletion() {
  // UI ìƒíƒœë¥¼ ì´ì „ìœ¼ë¡œ ë˜ëŒë¦¼
  Object.entries(ShippingState.currentBox.items).forEach(([barcode, boxItem]) => {
    const item = ShippingState.exportedItems.find(i => i.barcode === barcode);
    if (item) {
      item.remainingQuantity += boxItem.scannedInThisBox;
      item.scannedQuantity = (item.scannedQuantity || 0) - boxItem.scannedInThisBox;
    }
  });
  
  displayShippingList();
}









// Smaregi ì—°ê²° ìƒíƒœ í™•ì¸
// Smaregi ì—°ê²° ìƒíƒœ í™•ì¸ (ì´ˆê¸°í™” ì‹œ í˜¸ì¶œ)
function checkSmaregiConnection() {
  console.log('=== Smaregi ì—°ê²° ìƒíƒœ í™•ì¸ ì‹œì‘ ===');
  
  google.script.run
    .withSuccessHandler(function(result) {
      console.log('Smaregi ì—°ê²° ìƒíƒœ:', result);
      
      // AppState ì—…ë°ì´íŠ¸
      AppState.smaregiConnected = result.connected;
      
      if (result.connected && result.hasData) {
        // ì¬ê³  ë°ì´í„°ê°€ ìˆìœ¼ë©´ AppStateì— ì €ì¥
        console.log(`Smaregi ì—°ê²° ì„±ê³µ: ${result.itemCount}ê°œ ìƒí’ˆ`);
        showQuickSuccess(`Smaregi API ì—°ê²°ë¨ (${result.itemCount}ê°œ ìƒí’ˆ)`);
      } else if (result.connected) {
        console.log('Smaregi ì—°ê²°ë¨ (ë°ì´í„° ì—†ìŒ)');
        AppState.smaregiConnected = true;
      } else {
        console.log('Smaregi ì—°ê²° ì•ˆë¨');
        AppState.smaregiConnected = false;
      }
      
      // UI ì—…ë°ì´íŠ¸
      updateSmaregiStatus();
    })
    .withFailureHandler(function(error) {
      console.error('Smaregi ì—°ê²° í™•ì¸ ì‹¤íŒ¨:', error);
      AppState.smaregiConnected = false;
      updateSmaregiStatus();
    })
    .checkSmaregiConnection();
}

// Smaregi ì—°ê²° ìƒˆë¡œê³ ì¹¨
function refreshSmaregiConnection() {
  showSaveIndicator('loading');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result.success) {
        showQuickSuccess('ì¬ê³  ë°ì´í„°ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        checkSmaregiConnection();
        
        // í˜„ì¬ ë°œì£¼ì„œê°€ ìˆìœ¼ë©´ ì¬ê³  ì •ë³´ ì—…ë°ì´íŠ¸
        if (AppState.currentOrderInfo) {
          updateOrderStockInfo();
        }
      } else {
        showError('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ' + result.message);
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì—°ê²° ì‹¤íŒ¨: ' + error);
    })
    .syncSmaregiData();
}

// ìë™ ë°œì£¼ ì œì•ˆ í‘œì‹œ
function showAutoSuggestions() {
  const modal = document.getElementById('auto-suggest-modal');
  if (modal) {
    modal.style.display = 'block';
    // AI ë°œì£¼ ì œì•ˆ ë°ì´í„° ë¡œë“œ
    loadAutoSuggestions();
  } else {
    showError('AI ë°œì£¼ ì œì•ˆ ê¸°ëŠ¥ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.');
  }
}

// ìë™ ì œì•ˆ ëª©ë¡ í‘œì‹œ
function displayAutoSuggestions(suggestions) {
  const modal = document.getElementById('auto-suggest-modal');
  const list = document.getElementById('suggest-list');
  
  // í†µê³„ ì—…ë°ì´íŠ¸
  const stats = {
    outOfStock: suggestions.filter(s => s.currentStock === 0).length,
    lowStock: suggestions.filter(s => s.currentStock > 0 && s.currentStock < 10).length,
    urgent: suggestions.filter(s => s.priority === 1).length
  };
  
  document.getElementById('out-of-stock-count').textContent = stats.outOfStock;
  document.getElementById('low-stock-count').textContent = stats.lowStock;
  document.getElementById('urgent-count').textContent = stats.urgent;
  
  // ì œì•ˆ ëª©ë¡ ìƒì„±
  list.innerHTML = suggestions.map((item, index) => {
    const priorityClass = item.priority === 1 ? 'urgent' : item.priority === 2 ? 'warning' : '';
    const stockClass = item.currentStock === 0 ? 'critical' : '';
    
    return `
      <div class="suggest-item ${priorityClass}" data-index="${index}">
        <input type="checkbox" class="suggest-checkbox" checked>
        <div class="suggest-item-info">
          <div class="suggest-product-name">
            ${item.name}
            ${item.isTrending ? '<span class="suggest-reason">ì¸ê¸°</span>' : ''}
            ${item.isFrequent ? '<span class="suggest-reason">ìì£¼ë°œì£¼</span>' : ''}
          </div>
          <div class="suggest-details">
            ${item.barcode} | ${item.option || 'ì˜µì…˜ì—†ìŒ'} | ${item.supplierName || ''}
          </div>
        </div>
        <div class="suggest-quantity">
          <div class="suggest-stock ${stockClass}">
            ì¬ê³ : ${item.currentStock}ê°œ
          </div>
          <input type="number" class="suggest-qty-input" value="${item.suggestedQuantity}" min="1">
        </div>
      </div>
    `;
  }).join('');
  
  // ì œì•ˆ ë°ì´í„° ì €ì¥
  window.currentSuggestions = suggestions;
  
  modal.style.display = 'block';
}

// ì„ íƒí•œ ì œì•ˆ ì¶”ê°€
function addSelectedSuggestions() {
  const checkboxes = document.querySelectorAll('.suggest-checkbox:checked');
  const itemsToAdd = [];
  
  checkboxes.forEach(checkbox => {
    const item = checkbox.closest('.suggest-item');
    const index = parseInt(item.dataset.index);
    const quantity = parseInt(item.querySelector('.suggest-qty-input').value);
    const suggestion = window.currentSuggestions[index];
    
    itemsToAdd.push({
      barcode: suggestion.barcode,
      name: suggestion.name,
      option: suggestion.option,
      quantity: quantity,
      memo: suggestion.reason || '',
      priority: suggestion.priority,
      supplierName: suggestion.supplierName
    });
  });
  
  if (itemsToAdd.length === 0) {
    showError('ì„ íƒí•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ë°œì£¼ì„œì— ì¶”ê°€
  itemsToAdd.forEach(item => {
    addToOrderList(item);
  });
  
  closeModal('auto-suggest-modal');
  showQuickSuccess(`${itemsToAdd.length}ê°œ ìƒí’ˆì´ ë°œì£¼ì„œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// ì „ì²´ ì œì•ˆ ì¶”ê°€
function addAllSuggestions() {
  const items = document.querySelectorAll('.suggest-item');
  const itemsToAdd = [];
  
  items.forEach((item, index) => {
    const quantity = parseInt(item.querySelector('.suggest-qty-input').value);
    const suggestion = window.currentSuggestions[index];
    
    itemsToAdd.push({
      barcode: suggestion.barcode,
      name: suggestion.name,
      option: suggestion.option,
      quantity: quantity,
      memo: suggestion.reason || '',
      priority: suggestion.priority,
      supplierName: suggestion.supplierName
    });
  });
  
  // ë°œì£¼ì„œì— ì¶”ê°€
  itemsToAdd.forEach(item => {
    addToOrderList(item);
  });
  
  closeModal('auto-suggest-modal');
  showQuickSuccess(`${itemsToAdd.length}ê°œ ìƒí’ˆì´ ë°œì£¼ì„œì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// ë°œì£¼ì„œ ì¬ê³  ì •ë³´ ì—…ë°ì´íŠ¸
function updateOrderStockInfo() {
  if (!AppState.currentOrderInfo || !AppState.currentOrderInfo.orderId) {
    return;
  }
  
  showSaveIndicator('loading');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result.success) {
        showQuickSuccess(result.message);
        
        // UI ì—…ë°ì´íŠ¸
        result.updates.forEach(update => {
          updateOrderItemStock(update);
        });
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì¬ê³  ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
    })
    .updateOrderWithSmaregiData(AppState.currentOrderInfo.orderId);
}

// ê°œë³„ ì•„ì´í…œ ì¬ê³  í‘œì‹œ ì—…ë°ì´íŠ¸
function updateOrderItemStock(update) {
  const items = document.querySelectorAll('.order-item');
  
  items.forEach(item => {
    const barcode = item.querySelector('.item-barcode').textContent;
    if (barcode === update.barcode) {
      const stockBtn = item.querySelector('.stock-status-btn');
      if (stockBtn) {
        const statusClass = update.status === 'ê°€ëŠ¥' ? 'available' : 'unavailable';
        const statusIcon = update.status === 'ê°€ëŠ¥' ? 'âœ…' : 'âŒ';
        
        stockBtn.className = `stock-status-btn ${statusClass}`;
        stockBtn.innerHTML = `
          <span>${statusIcon}</span>
          <span>${update.status}</span>
          <span class="stock-count">(${update.stock}ê°œ)</span>
        `;
      }
    }
  });
}

// ëŒ€ì‹œë³´ë“œ ì¬ê³  í˜„í™© ì—…ë°ì´íŠ¸
function updateStockSummary(data) {
  if (document.getElementById('total-products')) {
    document.getElementById('total-products').textContent = data.totalItems || '-';
    document.getElementById('out-of-stock').textContent = data.outOfStock || '0';
    document.getElementById('low-stock').textContent = data.lowStock || '0';
    document.getElementById('normal-stock').textContent = data.normalStock || '0';
    document.getElementById('last-sync-time').textContent = 
      data.lastSync ? new Date(data.lastSync).toLocaleString('ko-KR') : 'ì—†ìŒ';
  }
}

// API ì—°ê²° í…ŒìŠ¤íŠ¸ (ì„¤ì • í˜ì´ì§€)
function testSmaregiConnection() {
  showSaveIndicator('loading');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      const indicator = document.getElementById('api-status-indicator');
      const message = document.getElementById('api-status-message');
      
      if (result.success) {
        indicator.classList.add('connected');
        indicator.classList.remove('error');
        message.textContent = `ì—°ê²° ì„±ê³µ! ${result.stores}ê°œ ë§¤ì¥ í™•ì¸ë¨`;
        showQuickSuccess('Smaregi API ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ');
      } else {
        indicator.classList.add('error');
        indicator.classList.remove('connected');
        message.textContent = 'ì—°ê²° ì‹¤íŒ¨: ' + result.message;
        showError('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨');
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error);
    })
    .testSmaregiConnection();
}

// ìë™ ë™ê¸°í™” ì„¤ì •
function setupAutoSync() {
  const interval = document.getElementById('sync-interval').value;
  
  if (interval === '0') {
    if (!confirm('ìë™ ë™ê¸°í™”ë¥¼ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }
  }
  
  showSaveIndicator('loading');
  
  google.script.run
    .withSuccessHandler(function(result) {
      showSaveIndicator('hide');
      
      if (result.success) {
        showQuickSuccess(result.message);
      } else {
        showError('ì„¤ì • ì‹¤íŒ¨');
      }
    })
    .withFailureHandler(function(error) {
      showSaveIndicator('hide');
      showError('ì„¤ì • ì˜¤ë¥˜: ' + error);
    })
    .setupSmaregiTriggers();
}

// ê¸°ì¡´ CSV ì—…ë¡œë“œ í•¨ìˆ˜ë“¤ ì œê±°/ë¹„í™œì„±í™”
function showSmaregiUploadModal() {
  showError('CSV ì—…ë¡œë“œëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. API ì—°ë™ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
}

// ì¬ê³  ìƒíƒœ ìŠ¤íƒ€ì¼ ì¶”ê°€
const stockStatusStyles = `
  .stock-count {
    font-size: 11px;
    margin-left: 4px;
    opacity: 0.8;
  }
  
  .stock-status-btn.available .stock-count {
    color: #4caf50;
  }
  
  .stock-status-btn.unavailable .stock-count {
    color: #f44336;
  }
`;

// ìŠ¤íƒ€ì¼ ì¶”ê°€
const styleSheet = document.createElement('style');
styleSheet.textContent = stockStatusStyles;
document.head.appendChild(styleSheet);











// ===== ê¸°ì¡´ switchTab í•¨ìˆ˜ ìˆ˜ì • =====
const originalSwitchTab = window.switchTab;
window.switchTab = function(tabName) {
  // ì´ì „ íƒ­ ì •ë¦¬
  const activeTab = document.querySelector('.nav-btn.active');
  if (activeTab && activeTab.dataset.tab === 'shipping') {
    cleanupShippingTab();
  }
  
  // ê¸°ì¡´ í•¨ìˆ˜ í˜¸ì¶œ
  originalSwitchTab(tabName);
  
  // ì¶œê³  íƒ­ í™œì„±í™”
  if (tabName === 'shipping') {
    // ê°•ì œ ë¦¬í”„ë ˆì‹œ í”Œë˜ê·¸ í™•ì¸
    const forceRefresh = sessionStorage.getItem('forceRefreshShipping');
    if (forceRefresh === 'true') {
      sessionStorage.removeItem('forceRefreshShipping');
      localStorage.removeItem('shippingSession');
    }
    
    loadShippingTab();
  }
};

// ===== ê¸°ì¡´ updateOrderList í•¨ìˆ˜ ìˆ˜ì • (ì¶œê³  ì™„ë£Œ í‘œì‹œ) =====
const originalUpdateOrderList = window.updateOrderList;
window.updateOrderList = function() {
  // ê¸°ì¡´ í•¨ìˆ˜ í˜¸ì¶œ
  originalUpdateOrderList.apply(this, arguments);
  
  // ì¶œê³  ì™„ë£Œëœ í•­ëª©ì— ë°•ìŠ¤ë²ˆí˜¸ í‘œì‹œ
  AppState.orderItems.forEach(item => {
    if (item.boxNumbers) {
      const orderItemEl = document.querySelector(`[data-id="${item.id}"]`);
      if (orderItemEl && !orderItemEl.querySelector('.box-info')) {
        // ë°•ìŠ¤ ì •ë³´ í¬ë§· ê°œì„  - ìŠ¬ë˜ì‹œë¡œ êµ¬ë¶„
        const formattedBoxInfo = item.boxNumbers.replace(/(\d+)\((\d+)\)/g, '$1ë²ˆ($2ê°œ)')
                                               .replace(/\), /g, ') / ');
        
        const boxInfo = document.createElement('div');
        boxInfo.className = 'box-info';
        boxInfo.innerHTML = `
          <span class="box-icon">ğŸ“¦</span>
          <span class="box-numbers">${formattedBoxInfo}</span>
        `;
        
        const actionsEl = orderItemEl.querySelector('.order-actions');
        if (actionsEl) {
          orderItemEl.insertBefore(boxInfo, actionsEl);
        }
        
        // ì¶œê³  ì™„ë£Œ í•­ëª©ì€ ì‚­ì œ ë²„íŠ¼ ë¹„í™œì„±í™”
        const deleteBtn = orderItemEl.querySelector('.order-action-btn.delete');
        if (deleteBtn) {
          deleteBtn.disabled = true;
          deleteBtn.title = 'ì¶œê³ ëœ í•­ëª©ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        }
      }
    }
  });
};

// ===== ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì— ì¶œê³  íƒ­ ì •ë¦¬ ì¶”ê°€ =====
window.addEventListener('beforeunload', function(e) {
  // ì¶œê³  ì‘ì—… ì¤‘ì´ë©´ ë¬´ì¡°ê±´ ì„¸ì…˜ ì €ì¥
  if (ShippingState.currentBox.barcode || ShippingState.exportedItems.length > 0) {
    saveShippingSession();
  }
  
  if (AppState.hasUnsavedChanges || ShippingState.scanState === 'SCANNING') {
    e.preventDefault();
    e.returnValue = 'ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ìˆìŠµë‹ˆë‹¤.';
  }
});

window.loadShippingTab = loadShippingTab;
window.cleanupShippingTab = cleanupShippingTab;
window.forceCompleteBox = forceCompleteBox;
window.confirmExcessQuantity = confirmExcessQuantity;
window.completeBox = completeBox;

window.showCommentInput = showCommentInput;
window.saveComment = saveComment;
window.removeItem = removeItem;
window.showModal = showModal;
window.closeModal = closeModal;
window.updateQuantity = updateQuantity;
window.showQuickStockMenu = showQuickStockMenu;
window.setQuickStock = setQuickStock;
window.showStockStatusModal = showStockStatusModal;
window.saveStockStatus = saveStockStatus;
window.refreshFrequentItems = refreshFrequentItems;


// ===== scripts.html ë =====



</script>
